<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Lucidian</title>
<style>
:root{
  --bg-0:#0e1116;
  --bg-1:#121720;
  --panel:#1a1f2a;
  --ink:#f7f2d8;
  --ink-dim:#e8e2c5;
  --muted:#a9acb3;
  --gold:#d7b24a;
  --gold-2:#ffd76a;
  --ok:#2ecc71;
  --warn:#ffb400;
  --danger:#e74c3c;
}

/* ============ LAYOUT ============ */
html,body{height:100%;background:var(--bg-0);color:#fff;font:16px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";}
*{box-sizing:border-box}
button{cursor:pointer}

.app{position:relative;min-height:100%;display:grid;grid-template-rows:auto 1fr auto}

/* Header */
.header{
  position:sticky; top:0; z-index:1200;
  height:82px;                                  /* just a touch taller */
  display:grid; grid-template-columns:auto 1fr auto; align-items:center;
  padding:0 16px;
  background:linear-gradient(180deg, rgba(15,18,23,.96), rgba(15,18,23,.86));
  border-bottom:1px solid rgba(255,255,255,.06);
  overflow:visible;
}
.brand-wrap{display:flex; justify-content:center; align-items:center; min-width:0}
.brand{
  letter-spacing:.6rem; font-weight:800; color:var(--ink); opacity:.95; user-select:none;
}

/* Symbol (kept as you liked it) */
.symbol{
  width:72px;height:72px;min-width:72px;border-radius:50%;
  background:
    radial-gradient(circle at 50% 50%, #ffefb0 0%, #ffd76a 35%, #d7b24a 60%, #8b6a20 100%);
  box-shadow:0 0 38px rgba(255,215,106,.55), inset 0 0 12px rgba(0,0,0,.35);
  margin-left:10px;
}

/* Account chip */
#acctChip{
  background:#212733; border:1px solid rgba(255,255,255,.1); color:#fff;
  padding:6px 10px;border-radius:10px; display:flex; align-items:center; gap:6px;
}
#acctChip:after{content:"â–¼"; font-size:11px; opacity:.7}

/* Body: sidebar + chat */
.body{position:relative;min-height:calc(100vh - 82px - 64px)}
.main{
  position:relative; display:grid; grid-template-columns:300px 1fr; gap:10px;
  padding:10px 10px 0 10px; height:100%;
}

/* Starfield */
#stars{position:absolute; inset:0; z-index:0;}
.main-inner{position:relative; z-index:1; display:contents}

/* Sidebar (persistent desktop) */
.sidebar{
  background:linear-gradient(180deg, rgba(20,24,31,.9), rgba(20,24,31,.8));
  border:1px solid rgba(255,255,255,.06);
  border-radius:10px; padding:10px; overflow:auto;
}
.section-title{font-weight:800; color:var(--ink-dim); margin:6px 0 8px 2px}
.row{display:flex; gap:8px; align-items:center}
.input{width:100%; background:#11161f; border:1px solid rgba(255,255,255,.12); color:#fff; padding:10px 12px; border-radius:12px; outline:none}
.btn{background:var(--gold-2); color:#000; font-weight:700; border:none; padding:8px 12px; border-radius:10px}
.btn-ghost{background:#2a303c; color:#fff; border:1px solid rgba(255,255,255,.12); padding:6px 10px; border-radius:10px}
.badge{padding:6px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.12); background:#202531}

.conv{
  display:flex; align-items:center; justify-content:space-between; gap:6px;
  padding:8px 10px; border:1px solid rgba(255,255,255,.08); background:#121823; color:#e9edf6; border-radius:10px; margin:8px 0;
}
.conv .title{flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
.conv .mini{display:flex; gap:6px}
.mini .select{background:#f0c958;color:#111; font-weight:800; border:none; padding:4px 8px; border-radius:8px}
.mini .del{background:#ef476f;color:#fff; border:none; padding:4px 8px; border-radius:8px}

/* Chat area */
.chat{
  position:relative; border:1px solid rgba(255,255,255,.06); border-radius:12px;
  background:linear-gradient(180deg, rgba(18,25,36,.66), rgba(18,25,36,.40));
  overflow:auto; padding:20px;
}
.stream{max-width:1200px; margin:0 auto;}

/* Message bubbles (classic look) */
.msg-wrap{position:relative}
.msg{
  max-width:min(70ch, 78%);
  display:inline-block;
  padding:10px 14px; border-radius:14px; margin:14px 0;
  word-wrap:break-word; overflow-wrap:anywhere; backdrop-filter:blur(2px);
}
.msg.left{ background:rgba(255,215,106,.06); border:1px solid var(--gold); color:#ede9dd }
.msg.right{ background:#3a4150; border:1px solid rgba(255,255,255,.2); color:#fff; margin-left:auto }
.msg .attachments{margin-top:8px; display:flex; gap:10px; flex-wrap:wrap}
.thumb{width:110px;height:140px;border-radius:10px;border:1px solid rgba(255,255,255,.12); background:#090c12; overflow:hidden}
.thumb img{width:100%;height:100%;object-fit:cover}

/* Hover actions */
.actions{
  position:absolute; right:6px; top:-28px; display:none; gap:8px; z-index:10;
}
.msg-wrap:hover .actions{display:flex}
.tag{background:#2a303c; border:1px solid rgba(255,255,255,.18); color:#fff; padding:4px 8px; font-size:12px; border-radius:8px}

/* Composer */
.footer{
  position:sticky; bottom:0; z-index:1000; padding:8px 10px 10px;
  background:linear-gradient(0deg, rgba(14,17,22,1), rgba(14,17,22,.80));
  border-top:1px solid rgba(255,255,255,.06);
}
.composer{max-width:1200px; margin:0 auto; display:grid; grid-template-columns:auto auto 1fr auto auto; gap:8px}
#msgInput{height:44px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background:#0f141d; color:#fff; padding:10px 12px}

/* Overlay (profile & library share this) */
.overlay{position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; z-index:5000}
.panel{
  position:fixed; left:50%; top:50%; transform:translate(-50%,-50%);
  width:min(720px, calc(100vw - 32px)); max-height:min(80vh, 900px);
  overflow:auto; background:rgba(24,28,36,.98); border:1px solid rgba(255,255,255,.18);
  border-radius:14px; padding:18px; z-index:6000; display:none;
}
.panel h2{margin:0 0 10px; font-size:24px}
.grid{display:grid; grid-template-columns:1fr 1fr; gap:10px}
.full{grid-column:1/-1}

/* Library cards */
#libraryGrid{display:grid; grid-template-columns:repeat(auto-fill, minmax(160px,1fr)); gap:12px}
.lib-card{background:#131821; border:1px solid rgba(255,255,255,.12); border-radius:12px; padding:10px}
.lib-card img{width:100%; height:120px; object-fit:cover; border-radius:8px; border:1px solid rgba(255,255,255,.08); margin-bottom:6px}
.lib-actions{display:flex; gap:8px}

/* Responsive */
@media(max-width:1100px){
  .main{grid-template-columns:260px 1fr}
  .symbol{width:64px;height:64px;min-width:64px}
}
@media(max-width:880px){
  .main{grid-template-columns:1fr}
  .sidebar{position:fixed; left:12px; top:96px; width:80vw; max-width:340px; height:70vh; display:none; z-index:3000}
  #menuBtn{display:inline-flex}
}
@media(min-width:881px){
  #menuBtn{display:none}
}

/* Small helpers */
hr.sep{border:none; height:1px; background:rgba(255,255,255,.08); margin:10px 0}
.toast{position:fixed; bottom:18px; left:50%; transform:translateX(-50%); background:#2a303c; border:1px solid rgba(255,255,255,.18); color:#fff; padding:8px 12px; border-radius:10px; display:none; z-index:7000}
.hidden{display:none!important}
</style>
</head>
<body>
<div class="app">
  <!-- ======= HEADER ======= -->
  <div class="header">
    <button id="menuBtn" class="btn-ghost">â˜°</button>
    <button id="acctChip">kyle</button>
    <div class="brand-wrap"><div class="brand" id="brand">L U C I D I A N</div></div>
    <div class="symbol" id="symbol" aria-hidden="true"></div>
  </div>

  <!-- ======= BODY ======= -->
  <div class="body">
    <div class="main">
      <canvas id="stars"></canvas>
      <div class="main-inner"></div>

      <!-- Sidebar -->
      <aside class="sidebar" id="sidebar">
        <div class="row" style="margin-bottom:10px">
          <button id="newBtn" class="btn" style="width:160px">New</button>
          <span class="badge" id="libOpen">Open</span>
        </div>

        <div class="section-title">Search</div>
        <div class="row" style="margin-bottom:8px">
          <input id="searchBox" class="input" placeholder="Search conversations..." />
          <button id="searchGo" class="btn-ghost">Go</button>
        </div>

        <div id="convList"></div>
      </aside>

      <!-- Chat -->
      <section class="chat" id="chat">
        <div class="stream" id="stream"></div>
      </section>
    </div>
  </div>

  <!-- ======= COMPOSER ======= -->
  <div class="footer">
    <div class="composer">
      <button id="attachBtn" class="btn-ghost">Attach</button>
      <button id="micBtn" class="btn-ghost">ðŸŽ¤ Mic</button>
      <input id="msgInput" class="input" placeholder="Type a message..." />
      <button id="sendBtn" class="btn">Send</button>
      <button id="voiceCallBtn" class="btn-ghost">Voice</button>
    </div>
  </div>
</div>

<!-- Hidden file input -->
<input id="fileInput" type="file" multiple class="hidden" />

<!-- Profile overlay -->
<div class="overlay" id="profileOverlay"></div>
<div class="panel" id="profilePanel" role="dialog" aria-modal="true">
  <h2>Profile</h2>
  <div class="grid">
    <div>
      <div class="section-title">Name</div>
      <input id="profName" class="input" />
    </div>
    <div>
      <div class="section-title">Email</div>
      <input id="profEmail" class="input" />
    </div>
    <div>
      <div class="section-title">Phone</div>
      <input id="profPhone" class="input" />
    </div>
    <div>
      <div class="section-title">Language</div>
      <select id="profLang" class="input">
        <option value="en">English</option>
        <option value="es">EspaÃ±ol</option>
        <option value="fr">FranÃ§ais</option>
        <option value="de">Deutsch</option>
      </select>
    </div>
    <div class="full">
      <button id="profSave" class="btn">Save</button>
      <button id="profSignOut" class="btn-ghost" style="margin-left:8px">Sign out</button>
    </div>
    <div class="full"><hr class="sep"></div>
    <div class="full">
      <div class="section-title">Memories</div>
      <div id="memoryList" style="color:var(--ink-dim)">No saved memories yet.</div>
    </div>
  </div>
</div>

<!-- Library overlay -->
<div class="overlay" id="libraryOverlay"></div>
<div class="panel" id="libraryPanel" role="dialog" aria-modal="true">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <h2 style="margin:0">Shared Library</h2>
    <button id="libClose" class="btn-ghost">Close</button>
  </div>
  <div id="libraryGrid" style="margin-top:10px"></div>
</div>

<div class="toast" id="toast"></div>

<script>
/* ========= UTIL ========= */
const $=sel=>document.querySelector(sel);
const el=(tag,cls,txt)=>{const n=document.createElement(tag); if(cls) n.className=cls; if(txt) n.textContent=txt; return n;}
const toast=(t)=>{const n=$("#toast"); n.textContent=t; n.style.display='block'; clearTimeout(n._t); n._t=setTimeout(()=>n.style.display='none',1600)}

/* ========= STARFIELD (instant) ========= */
(function stars(){
  const c=$("#stars"), ctx=c.getContext('2d');
  let W=0,H=0,stars=[];
  function size(){ W=c.width= c.offsetWidth; H=c.height=c.offsetHeight }
  function init(){
    size(); stars = Array.from({length: Math.floor((W*H)/12000)+120}, ()=>({
      x:Math.random()*W, y:Math.random()*H, r:Math.random()*1.2+0.2, s:Math.random()*0.6+0.2
    }));
  }
  function draw(){
    ctx.clearRect(0,0,W,H);
    for(const st of stars){
      st.x+=st.s*0.05; if(st.x>W) st.x=0;
      ctx.beginPath(); ctx.arc(st.x, st.y, st.r, 0, Math.PI*2);
      ctx.fillStyle="rgba(255,255,255,.85)"; ctx.fill();
    }
    requestAnimationFrame(draw);
  }
  const ro=new ResizeObserver(()=>{size();});
  ro.observe(c); init(); draw();
})();

/* ========= STATE (per-account) ========= */
const LS='lucidian-v12';
let state = JSON.parse(localStorage.getItem(LS)||'null') || {
  currentUserId:null,
  users:{},        // id -> {name,email,phone,lang}
  data:{}          // id -> { conversations:[], library:[] }
};
function saveState(){ localStorage.setItem(LS, JSON.stringify(state)); }
function uid(){ return Math.random().toString(36).slice(2)+Date.now().toString(36); }

function ensureUser(){
  if(!state.currentUserId){
    // bootstrap a simple default account named "kyle"
    const id=uid();
    state.currentUserId=id;
    state.users[id]={name:'kyle', email:'', phone:'', lang:'en'};
    state.data[id]={conversations:[], library:[]};
    saveState();
  }
  $("#acctChip").firstChild.nodeValue = (state.users[state.currentUserId].name||'user')+' ';
}
function userData(){ return state.data[state.currentUserId]; }

function ensureConversation(){
  const d=userData();
  if(!d.conversations.length) d.conversations.push({id:uid(), title:'New Conversation', msgs:[]});
}

/* ========= RENDER ========= */
function buildConversations(){
  const box=$("#convList"); box.innerHTML='';
  const list=userData().conversations;
  if(!list.length){ box.innerHTML='<div style="color:var(--muted)">No conversations yet.</div>'; return;}
  list.forEach(c=>{
    const row=el('div','conv');
    const title=el('div','title',c.title||'New Conversation');
    const mini=el('div','mini');
    const sel=el('button','select','Select'); sel.onclick=()=>{ currentId=c.id; renderStream(); };
    const del=el('button','del','Del'); del.onclick=()=>{ userData().conversations = list.filter(x=>x.id!==c.id); saveState(); buildConversations(); renderStream();}
    mini.append(sel,del);
    row.append(title, mini);
    box.append(row);
  });
}
let currentId=null;
function currentConv(){
  const d=userData(); if(!d.conversations.length) return null;
  const byId=d.conversations.find(x=>x.id===currentId) || d.conversations[0];
  currentId=byId.id; return byId;
}

function renderStream(){
  const s=$("#stream"); s.innerHTML='';
  const conv=currentConv(); if(!conv){ s.innerHTML=''; return; }
  conv.msgs.forEach((m, i)=>{
    const wrap=el('div','msg-wrap');
    const b=el('div','msg '+(m.role==='ai'?'left':'right'));
    b.textContent=m.text||'';
    if(m.attachments?.length){
      const at=el('div','attachments');
      m.attachments.forEach(a=>{
        const th=el('div','thumb');
        const im=el('img'); im.src=a.thumb||a.url; th.append(im); at.append(th);
      }); b.append(at);
    }
    const bar=el('div','actions');
    const copy=el('button','tag','Copy'); copy.onclick=()=>navigator.clipboard.writeText(m.text||'');
    const read=el('button','tag','Read'); read.onclick=()=>speak(m.text||'');
    bar.append(copy, read);
    if(m.role==='user'){
      const edit=el('button','tag','Edit');
      edit.onclick=()=>{
        const field=el('textarea','input'); field.style.height='84px'; field.value=m.text||'';
        b.replaceWith(field);
        edit.disabled=true;
        const done=el('button','tag','Save');
        done.onclick=()=>{
          m.text=field.value.trim();
          saveState(); renderStream();
        };
        bar.append(done);
      };
      bar.insertBefore(edit, read);
    }
    wrap.append(b,bar);
    s.append(wrap);
  });
  $("#chat").scrollTop = $("#chat").scrollHeight;
}

/* ========= LIBRARY ========= */
function buildLibrary(){
  const grid=$("#libraryGrid"); grid.innerHTML='';
  const lib=userData().library;
  if(!lib.length){ grid.innerHTML='<div style="color:var(--muted)">No shared files yet.</div>'; return; }
  lib.forEach(item=>{
    const card=el('div','lib-card');
    const img=el('img'); img.src=item.thumb||item.url; card.append(img);
    const name=el('div',null,item.name); name.style.fontWeight='700'; card.append(name);
    const actions=el('div','lib-actions');
    const open=el('button','btn-ghost','Open'); open.onclick=()=>window.open(item.url,'_blank');
    const dl=el('button','btn','Download'); dl.onclick=()=>{
      const a=document.createElement('a'); a.href=item.url; a.download=item.name||'file'; document.body.appendChild(a); a.click(); a.remove();
    };
    actions.append(open,dl); card.append(actions);
    grid.append(card);
  });
}

/* ========= PROFILE ========= */
function openProfile(){
  const u=state.users[state.currentUserId];
  $("#profName").value=u.name||'';
  $("#profEmail").value=u.email||'';
  $("#profPhone").value=u.phone||'';
  $("#profLang").value=u.lang||'en';

  const items = userData().conversations.flatMap(c=>c.msgs.filter(m=>m.role==='ai').map(m=>m.text)).slice(0,12);
  $("#memoryList").innerHTML = items.length
    ? "<ul style='margin:6px 0 0 18px'>" + items.map(x=>`<li>${x}</li>`).join("") + "</ul>"
    : "No saved memories yet.";

  $("#profileOverlay").style.display = $("#profilePanel").style.display = 'block';
}
function closeProfile(){ $("#profileOverlay").style.display = $("#profilePanel").style.display = 'none'; }
$("#acctChip").onclick=openProfile;
$("#profileOverlay").onclick=closeProfile;
$("#profSave").onclick=()=>{
  const u=state.users[state.currentUserId];
  u.name=$("#profName").value.trim(); u.email=$("#profEmail").value.trim();
  u.phone=$("#profPhone").value.trim(); u.lang=$("#profLang").value;
  saveState(); $("#acctChip").firstChild.nodeValue = (u.name||'user')+' '; toast('Saved'); closeProfile();
};
$("#profSignOut").onclick=()=>{
  toast('Signed out (demo)'); closeProfile();
};

/* ========= LIBRARY MODAL ========= */
$("#libOpen").onclick=()=>{ buildLibrary(); $("#libraryOverlay").style.display=$("#libraryPanel").style.display='block'; }
$("#libClose").onclick=()=>{ $("#libraryOverlay").style.display=$("#libraryPanel").style.display='none'; }
$("#libraryOverlay").onclick=()=>$("#libClose").click();

/* ========= ACTIONS ========= */
$("#menuBtn").onclick=()=>{ const sb=$("#sidebar"); sb.style.display = sb.style.display==='block' ? 'none' : 'block'; };
$("#newBtn").onclick=()=>{ userData().conversations.unshift({id:uid(), title:'New Conversation', msgs:[]}); saveState(); buildConversations(); renderStream(); };
$("#searchGo").onclick=()=>{
  const q=$("#searchBox").value.toLowerCase().trim(); if(!q) return buildConversations();
  const list = userData().conversations.filter(c=> (c.title||'').toLowerCase().includes(q) || c.msgs.some(m=>(m.text||'').toLowerCase().includes(q)));
  const box=$("#convList"); box.innerHTML='';
  list.forEach(c=>{
    const row=el('div','conv');
    row.append(el('div','title',c.title||'New Conversation'));
    const m=el('div','mini'); const sel=el('button','select','Select'); sel.onclick=()=>{ currentId=c.id; renderStream(); };
    m.append(sel); row.append(m); box.append(row);
  });
};

/* Attach / Mic / Send / Voice */
$("#attachBtn").onclick=()=>$("#fileInput").click();
$("#fileInput").onchange=(e)=>{
  const files=[...e.target.files]; if(!files.length) return;
  ensureConversation();
  const conv=currentConv();
  for(const f of files){
    const url=URL.createObjectURL(f);
    conv.msgs.push({role:'user', text:`(attachments queued) ${f.name}`, attachments:[{url,thumb:url,type:f.type}]});
    userData().library.unshift({name:f.name, url, type:f.type, thumb:url});
  }
  saveState(); renderStream(); buildLibrary(); toast(files.length+' file(s) added');
};
let micOn=false;
$("#micBtn").onclick=()=>{ micOn=!micOn; $("#micBtn").textContent= micOn? "ðŸŽ¤ Mic â€¢ On" : "ðŸŽ¤ Mic"; toast(micOn? "Mic listeningâ€¦" : "Mic paused") };
$("#voiceCallBtn").onclick=()=>toast("Voice call startingâ€¦");

$("#sendBtn").onclick=send;
$("#msgInput").addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); send(); }});
function send(){
  const t=$("#msgInput").value.trim(); if(!t) return;
  ensureConversation();
  const conv=currentConv();
  conv.msgs.push({role:'user', text:t});
  conv.msgs.push({role:'ai', text:`Echoing intention: ${t}`});
  $("#msgInput").value='';
  saveState(); renderStream();
}

/* TTS */
function speak(text){
  try{
    const u=new SpeechSynthesisUtterance(text); u.lang = (state.users[state.currentUserId].lang||'en');
    window.speechSynthesis.speak(u);
  }catch(e){ toast('Speech not available'); }
}

/* ========= BOOT ========= */
ensureUser(); ensureConversation(); buildConversations(); renderStream();
</script>
</body>
</html>
