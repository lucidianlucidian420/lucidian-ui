<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Lucidian — Interface v8</title>
<style>
  :root{
    --accent:#e8c66a;
    --accent-soft:rgba(232,198,106,.16);
    --text:#fff;
    --glass:rgba(0,0,0,.35);
    --glass-strong:rgba(0,0,0,.55);
    --bubble:#1c3350a6;
    --bubble-user:#1b2230a0;
  }
  @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap');
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:'Montserrat',system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial,sans-serif;
    color:var(--text);
    background:#000;
    overflow:hidden;
  }

  /* ===== Cosmic background ===== */
  .space{position:fixed;inset:0;z-index:-2;background:
    radial-gradient(1200px 800px at 70% 30%, rgba(0,120,255,.20), transparent 60%),
    radial-gradient(900px 700px at 20% 70%, rgba(0,200,255,.12), transparent 60%),
    radial-gradient(600px 600px at 50% 50%, rgba(120,180,255,.10), transparent 70%),
    #000}
  .stars,.stars:before,.stars:after,.stars2,.stars2:before,.stars2:after{
    position:absolute;content:"";top:-4000px;left:0;right:0;bottom:0;width:2px;height:2px;background:transparent;
    animation:drift var(--speed,260s) linear infinite
  }
  .stars{--speed:260s; box-shadow:var(--starsA);}
  .stars:before{transform:translateY(4000px) scale(.95); filter:brightness(.85); box-shadow:var(--starsB);}
  .stars:after {transform:translateY(8000px) scale(.9);  filter:brightness(.7);  box-shadow:var(--starsC);}
  .stars2{--speed:300s; box-shadow:var(--starsD);}
  .stars2:before{transform:translateY(4000px) scale(.95); filter:brightness(.9); box-shadow:var(--starsE);}
  .stars2:after {transform:translateY(8000px) scale(.9);  filter:brightness(.75); box-shadow:var(--starsF);}
  @keyframes drift{from{transform:translateY(0)}to{transform:translateY(4000px)}}
  .nebula{position:absolute;inset:-10%;pointer-events:none;z-index:-1;background:
    radial-gradient(60% 50% at 60% 40%, rgba(90,150,255,.15), transparent 70%),
    radial-gradient(50% 45% at 30% 65%, rgba(120,220,255,.12), transparent 70%);
    filter:blur(30px) saturate(120%);animation:breathe 18s ease-in-out infinite}
  @keyframes breathe{0%,100%{transform:translateY(0)}50%{transform:translateY(1.5%)}}

  /* ===== Layout ===== */
  .app{
    display:grid;
    grid-template-columns:320px 1fr;     /* sidebar stays at far left always */
    grid-template-rows:auto 1fr auto;
    height:100vh;
  }

  /* header: title centered, symbol on the RIGHT */
  header{
    grid-column:1/3;
    position:relative;
    background:var(--glass-strong);
    backdrop-filter:blur(8px);
    padding:12px clamp(10px,2vw,18px) 6px;
  }
  .head{
    max-width:1400px;
    margin:0 auto;
    display:grid;
    grid-template-columns:48px 1fr 120px; /* left: menu, center: title, right: symbol */
    align-items:center;
    gap:8px;
  }
  .hamburger{
    justify-self:start;
    width:42px;height:42px;border-radius:9px;
    border:1px solid rgba(255,255,255,.25);
    background:rgba(255,255,255,.1);
    color:#fff;cursor:pointer;display:none;
  }
  h1{
    margin:0; text-align:center; letter-spacing:8px;
    font-size:1.55rem; color:var(--accent);
    text-shadow:0 0 12px rgba(232,198,106,.45);
  }
  .crest{
    justify-self:end; width:92px; aspect-ratio:1/1; display:block;
    filter:drop-shadow(0 0 10px rgba(232,198,106,.45));
  }
  .crest svg{width:100%;height:100%;display:block}
  .crest path{fill:none;stroke:var(--accent);stroke-width:1.8;stroke-linecap:round}
  .crest .glow{stroke:rgba(232,198,106,.35);stroke-width:4;filter:blur(1px)}

  /* sidebar (history) */
  aside{
    grid-row:2/4;
    background:var(--glass-strong);
    backdrop-filter:blur(8px);
    padding:12px; display:flex; flex-direction:column; gap:10px; overflow:hidden;
  }
  .search{display:flex;gap:8px}
  .search input{flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.10);color:#fff}
  .search button{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.10);color:#fff;cursor:pointer}
  .new-chat{padding:10px;border:none;border-radius:8px;background:var(--accent);color:#000;font-weight:700;cursor:pointer}
  .list{overflow:auto;border:1px solid rgba(255,255,255,.15);border-radius:10px;background:rgba(255,255,255,.06)}
  .conv{padding:10px;border-bottom:1px solid rgba(255,255,255,.08);cursor:pointer;display:flex;justify-content:space-between;gap:8px}
  .conv.active{background:rgba(255,255,255,.12)}
  .conv .select{border:none;border-radius:6px;padding:4px 8px;background:var(--accent);color:#000;cursor:pointer}

  /* chat area */
  main{position:relative;overflow:auto;padding:16px}
  .chatStream{max-width:980px;margin:0 auto;display:flex;flex-direction:column;gap:14px;padding:6px 8px}
  .bubble{
    max-width:min(80%, 760px);
    width:fit-content;
    background:var(--bubble);
    border:1px solid rgba(255,255,255,.25);
    border-radius:14px;
    padding:10px 14px;
    line-height:1.45;
    overflow-wrap:anywhere;
    word-break:break-word;
    box-shadow:0 0 12px rgba(232,198,106,.10) inset, 0 2px 10px rgba(0,0,0,.25);
  }
  .bubble.lucidian{border-color:var(--accent); box-shadow:0 0 12px rgba(232,198,106,.18) inset}
  .bubble.user{margin-left:auto;background:var(--bubble-user);border-color:rgba(255,255,255,.55)}
  .bubble .thumbs{display:flex;gap:8px;margin-top:8px}
  .thumb{width:140px; border-radius:10px; overflow:hidden; border:1px solid rgba(255,255,255,.2)}
  .thumb img, .thumb video{display:block; width:100%; height:auto}
  .fileLink{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.08);text-decoration:none;color:#fff}

  /* footer controls */
  footer{
    grid-column:2/3;
    display:flex;align-items:center;gap:10px;
    padding:10px;background:var(--glass-strong)
  }
  .row{display:flex;gap:8px;align-items:center;width:100%}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.10);color:#fff;cursor:pointer;white-space:nowrap}
  .btn.primary{background:var(--accent);color:#000;border:none;font-weight:700}
  input[type=text]{flex:1;padding:12px 14px;border-radius:10px;border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.10);color:#fff}

  /* mobile (drawer replaces fixed sidebar) */
  @media (max-width: 900px){
    .app{grid-template-columns:1fr;grid-template-rows:auto 1fr auto}
    .hamburger{display:inline-flex;align-items:center;justify-content:center}
    aside{position:fixed;z-index:11;left:0;top:0;bottom:0;width:min(86vw,380px);transform:translateX(-100%);transition:.2s ease;box-shadow:8px 0 30px rgba(0,0,0,.6)}
    aside.open{transform:none}
    footer{grid-column:1/2}
    .chatStream{max-width:100%;padding-inline:6px}
  }

  /* overlay to close drawer on tap/click outside */
  .scrim{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;z-index:10}
  .scrim.show{display:block}
</style>
</head>
<body>
  <div class="space">
    <div class="stars"></div>
    <div class="stars2"></div>
    <div class="nebula"></div>
  </div>

  <div class="app">
    <header>
      <div class="head">
        <button class="hamburger" id="hamburger">☰</button>
        <h1>L U C I D I A N</h1>

        <!-- SAME SYMBOL, just positioned on the RIGHT -->
        <div class="crest" aria-label="Lucidian symbol">
          <svg viewBox="0 0 200 200" role="img" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <circle class="glow" cx="100" cy="100" r="86"/>
            <g transform="translate(100,100)">
              <defs>
                <path id="petal" d="M0,-80 C22,-80 40,-62 40,-40 C40,-18 22,0 0,0 C-22,0 -40,-18 -40,-40 C-40,-62 -22,-80 0,-80 Z"/>
              </defs>
              <g opacity="0.95">
                <use href="#petal" transform="rotate(0)"/>
                <use href="#petal" transform="rotate(15)"/>
                <use href="#petal" transform="rotate(30)"/>
                <use href="#petal" transform="rotate(45)"/>
                <use href="#petal" transform="rotate(60)"/>
                <use href="#petal" transform="rotate(75)"/>
                <use href="#petal" transform="rotate(90)"/>
                <use href="#petal" transform="rotate(105)"/>
                <use href="#petal" transform="rotate(120)"/>
                <use href="#petal" transform="rotate(135)"/>
                <use href="#petal" transform="rotate(150)"/>
                <use href="#petal" transform="rotate(165)"/>
                <use href="#petal" transform="rotate(180)"/>
                <use href="#petal" transform="rotate(195)"/>
                <use href="#petal" transform="rotate(210)"/>
                <use href="#petal" transform="rotate(225)"/>
                <use href="#petal" transform="rotate(240)"/>
                <use href="#petal" transform="rotate(255)"/>
                <use href="#petal" transform="rotate(270)"/>
                <use href="#petal" transform="rotate(285)"/>
                <use href="#petal" transform="rotate(300)"/>
                <use href="#petal" transform="rotate(315)"/>
                <use href="#petal" transform="rotate(330)"/>
                <use href="#petal" transform="rotate(345)"/>
              </g>
            </g>
          </svg>
        </div>
      </div>
    </header>

    <aside id="sidebar">
      <div class="search">
        <input id="search" type="text" placeholder="Search conversations..."/>
        <button id="searchBtn">Go</button>
        <button class="new-chat" id="newChat">New</button>
      </div>
      <div class="list" id="convList"></div>
    </aside>

    <main id="main">
      <div class="chatStream" id="chat"></div>
    </main>

    <footer>
      <div class="row">
        <label class="btn" for="file">Attach</label>
        <input id="file" type="file" multiple hidden/>
        <button class="btn" id="mic" title="Dictate (press again to stop)">🎤 Mic</button>
        <input id="text" type="text" placeholder="Type a message..."/>
        <button class="btn primary" id="send">Send</button>
        <button class="btn" id="voiceStudio" title="Open Voice Call">Voice</button>
      </div>
    </footer>
  </div>

  <div class="scrim" id="scrim"></div>

  <!-- Voice Call Modal -->
  <div class="modal" id="modal" style="position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:12">
    <div class="card" style="width:min(720px,92vw);background:var(--glass-strong);backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,.2);border-radius:16px;padding:16px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h2 style="margin:0;color:var(--accent)">Lucidian — Voice Call</h2>
        <button class="btn" id="closeModal">Close</button>
      </div>
      <div class="controls" style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px">
        <button class="btn primary" id="callToggle">Start call</button>
      </div>
      <div class="wave" id="wave" style="height:84px;background:rgba(255,255,255,.08);border-radius:10px;position:relative;overflow:hidden"></div>
      <p style="opacity:.8;margin-top:8px">When the call is on: your mic transcribes and you can auto‑send on pauses; Lucidian speaks replies. Stop ends mic + speech.</p>
    </div>
  </div>

<script>
/* ===== Star fields ===== */
function rand(n){return Math.floor(Math.random()*n)}
function makeStars(count){
  const a=[]; for(let i=0;i<count;i++){
    const x=rand(2000)+"px "+(rand(4000))+"px ";
    const c=Math.random(); const col=c>.7?'#fff':(c>.4?'#dfe9ff':'#bcd8ff');
    a.push(x+col);
  } return a.join(', ');
}
const root=document.documentElement;
root.style.setProperty('--starsA', makeStars(220));
root.style.setProperty('--starsB', makeStars(220));
root.style.setProperty('--starsC', makeStars(220));
root.style.setProperty('--starsD', makeStars(260));
root.style.setProperty('--starsE', makeStars(260));
root.style.setProperty('--starsF', makeStars(260));

/* ===== State ===== */
const chatEl = document.getElementById('chat');
const inputEl = document.getElementById('text');
const fileEl = document.getElementById('file');
const sendBtn = document.getElementById('send');
const micBtn = document.getElementById('mic');
const convList = document.getElementById('convList');
const newChatBtn = document.getElementById('newChat');
const searchEl = document.getElementById('search');
const searchBtn = document.getElementById('searchBtn');
const sidebar = document.getElementById('sidebar');
const hamburger = document.getElementById('hamburger');
const scrim = document.getElementById('scrim');

let conversations = JSON.parse(localStorage.getItem('lucidian_convs')||'[]');
let activeId = localStorage.getItem('lucidian_active') || null;
function save(){ localStorage.setItem('lucidian_convs', JSON.stringify(conversations)); }
function setActive(id){ activeId=id; localStorage.setItem('lucidian_active', id); renderList(); renderChat(); if(window.innerWidth<900){ sidebar.classList.remove('open'); scrim.classList.remove('show'); } }
function createConversation(){
  const id = Date.now().toString();
  conversations.unshift({id, title:'New Conversation', messages:[{role:'lucidian', text:'Hello, Ky.'}]});
  save(); setActive(id);
}

/* ===== History list ===== */
function renderList(filter=''){
  convList.innerHTML='';
  conversations
    .filter(c=> c.title.toLowerCase().includes(filter.toLowerCase()) || c.messages.some(m=>m.text.toLowerCase().includes(filter.toLowerCase())))
    .forEach(c=>{
      const d=document.createElement('div'); d.className='conv'+(c.id===activeId?' active':'');
      const span=document.createElement('span'); span.textContent=c.title; span.style.flex='1';
      const sel=document.createElement('button'); sel.textContent='Select'; sel.className='select'; sel.onclick=()=>setActive(c.id);
      d.appendChild(span); d.appendChild(sel); convList.appendChild(d);
    });
}

/* ===== Chat rendering (auto-size bubbles) ===== */
function renderChat(){
  chatEl.innerHTML='';
  const conv = conversations.find(c=>c.id===activeId);
  if(!conv){ createConversation(); return; }
  conv.messages.forEach(m=>{
    const b=document.createElement('div');
    b.className='bubble '+(m.role==='user'?'user':'lucidian');
    // content may include attachments
    if(m.attach && m.attach.length){
      const wrap=document.createElement('div'); wrap.style.display='flex'; wrap.style.flexDirection='column'; wrap.style.gap='8px';
      const text=document.createElement('div'); text.textContent=m.text||''; wrap.appendChild(text);
      const gallery=document.createElement('div'); gallery.className='thumbs';
      m.attach.forEach(a=>{
        if(a.type.startsWith('image/')){
          const t=document.createElement('div'); t.className='thumb'; const img=new Image(); img.src=a.url; t.appendChild(img); gallery.appendChild(t);
        }else if(a.type.startsWith('video/')){
          const t=document.createElement('div'); t.className='thumb'; const v=document.createElement('video'); v.src=a.url; v.controls=true; t.appendChild(v); gallery.appendChild(t);
        }else{
          const link=document.createElement('a'); link.href=a.url; link.download=a.name; link.className='fileLink'; link.textContent=a.name; gallery.appendChild(link);
        }
      });
      wrap.appendChild(gallery); b.appendChild(wrap);
    }else{
      b.textContent=m.text;
    }
    chatEl.appendChild(b);
  });
  chatEl.parentElement.scrollTop = chatEl.parentElement.scrollHeight;
}
function addMessage(role, text, files){
  const conv = conversations.find(c=>c.id===activeId); if(!conv) return;
  const msg = {role, text};
  if(files && files.length){ msg.attach = files; }
  conv.messages.push(msg);
  if(conv.title==='New Conversation' && role==='user' && text.trim()){
    conv.title = text.slice(0,42)+(text.length>42?'…':'');
  }
  save(); renderChat();
}

/* ===== Fake streaming reply + TTS in call mode ===== */
let callActive=false, lastReply='';
async function lucidianReply(userText){
  const chunks=["Echoing intention: ", userText||'listening.'];
  lastReply='';
  for(const c of chunks){ lastReply+=c; await new Promise(r=>setTimeout(r,60)); updateLucidian(lastReply); }
  if(callActive && 'speechSynthesis' in window){ const u=new SpeechSynthesisUtterance(lastReply); speechSynthesis.speak(u); }
}
function updateLucidian(text){
  const conv = conversations.find(c=>c.id===activeId); if(!conv) return;
  const last = conv.messages[conv.messages.length-1];
  if(last && last.role==='lucidian'){ last.text=text; } else { conv.messages.push({role:'lucidian', text}); }
  save(); renderChat();
}

/* ===== Send flow ===== */
sendBtn.onclick=async ()=>{
  const text=inputEl.value.trim(); const files=pendingFiles.splice(0);
  if(!text && !files.length) return;
  inputEl.value='';
  addMessage('user', text, files);
  await lucidianReply(text);
};
inputEl.addEventListener('keydown', e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendBtn.click(); }});

/* ===== Sidebar drawer ===== */
hamburger.onclick=()=>{ sidebar.classList.toggle('open'); scrim.classList.toggle('show'); };
scrim.onclick=()=>{ sidebar.classList.remove('open'); scrim.classList.remove('show'); };
newChatBtn.onclick=createConversation;
searchBtn.onclick=()=> renderList(searchEl.value);
searchEl.addEventListener('keydown', e=>{ if(e.key==='Enter'){ renderList(searchEl.value); }});

/* ===== Attachments (previews + send) ===== */
let pendingFiles=[];
fileEl.onchange=async (e)=>{
  const files = Array.from(e.target.files||[]);
  if(!files.length) return;
  const previews=[];
  for(const f of files){
    const url = URL.createObjectURL(f);
    previews.push({name:f.name,size:f.size,type:f.type,url});
  }
  // Show a preview bubble on the user side; do not send yet
  pendingFiles.push(...previews);
  const label = previews.length===1? previews[0].name : previews.length+' files attached';
  // render a temporary bubble preview
  addMessage('user', '(attachments queued) '+label, previews);
};

/* ===== Mic (PUSH TO TOGGLE, never auto-clears on pause) ===== */
let recognition, recognizing=false;
if('webkitSpeechRecognition' in window || 'SpeechRecognition' in window){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SR();
  recognition.lang='en-US';
  recognition.continuous=true;          // keep running
  recognition.interimResults=true;      // show interim
  let buffer = inputEl.value;

  recognition.onresult = (e)=>{
    // Keep user's typed text, append interim/final – never erase on pauses
    let interim = '';
    for(let i=e.resultIndex;i<e.results.length;i++){
      const r=e.results[i];
      if(r.isFinal){ buffer += (buffer && !buffer.endsWith(' ')?' ':'') + r[0].transcript.trim(); }
      else { interim = r[0].transcript; }
    }
    inputEl.value = (buffer + ' ' + interim).trim();
  };
  recognition.onerror = ()=>{};
  recognition.onend = ()=>{ if(recognizing){ try{ recognition.start(); }catch{} } };
  micBtn.onclick = ()=>{
    recognizing = !recognizing;
    micBtn.classList.toggle('primary', recognizing);
    if(recognizing){ try{ recognition.start(); }catch{} }
    else{ try{ recognition.stop(); }catch{} }
  };
}

/* ===== Voice Call modal ===== */
const modal=document.getElementById('modal');
const voiceStudioBtn=document.getElementById('voiceStudio');
const callToggle=document.getElementById('callToggle');
const closeModal=document.getElementById('closeModal');
const wave=document.getElementById('wave');
voiceStudioBtn.onclick=()=>{ modal.style.display='flex'; };
closeModal.onclick=()=>{ modal.style.display='none'; stopCall(); };
for(let i=0;i<70;i++){ const b=document.createElement('div'); b.style.position='absolute'; b.style.bottom='0'; b.style.width='6px'; b.style.left=(i*10)+'px'; b.style.background='var(--accent)'; b.style.animation='bars 1s ease-in-out infinite'; b.style.animationDelay=(Math.random()*1)+'s'; wave.appendChild(b); }
function startCall(){ callActive=true; callToggle.textContent='Stop call'; if('speechSynthesis' in window){ speechSynthesis.cancel(); } }
function stopCall(){ callActive=false; callToggle.textContent='Start call'; if('speechSynthesis' in window){ speechSynthesis.cancel(); } }
callToggle.onclick=()=> callActive? stopCall() : startCall();

/* ===== PWA (installable + offline) ===== */
if('serviceWorker' in navigator){
  const swCode = `self.addEventListener('install', e=>{ self.skipWaiting(); e.waitUntil(caches.open('lucidian-v8').then(c=>c.addAll(['./']))); });
  self.addEventListener('fetch', e=>{ e.respondWith(caches.match(e.request).then(r=> r || fetch(e.request))); });`;
  const blob = new Blob([swCode], {type:'text/javascript'});
  const swUrl = URL.createObjectURL(blob);
  navigator.serviceWorker.register(swUrl);
}
const manifest = { name:'Lucidian', short_name:'Lucidian', start_url:'./', display:'standalone', background_color:'#000', theme_color:'#000', icons:[] };
const mBlob = new Blob([JSON.stringify(manifest)], {type:'application/json'});
const mUrl = URL.createObjectURL(mBlob);
const link = document.createElement('link'); link.rel='manifest'; link.href=mUrl; document.head.appendChild(link);

/* ===== Boot ===== */
if(!activeId && conversations.length){ activeId = conversations[0].id; }
if(!conversations.length){ createConversation(); } else { renderList(); renderChat(); }

/* keep layout happy on zoom/resize */
new ResizeObserver(()=>{ /* nothing needed; forces reflow */ }).observe(document.body);
</script>
<style>
@keyframes bars{0%,100%{height:15%}50%{height:85%}}
</style>
</body>
</html>
