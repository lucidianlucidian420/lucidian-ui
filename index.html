import React, { useEffect, useMemo, useRef, useState } from "react";

/**
 * LUCIDIAN – single‑file React app you can drop into a Vite/Next project as <LucidianApp />
 *
 * What this file gives you (as requested):
 * - Header: wordmark centered, ROUND symbol on the RIGHT, Settings button on the TOP‑LEFT
 * - Sidebar: "New", "Library" (renamed from Open), conversation list, search
 * - Stars background
 * - Chat:
 *    • Bubbles auto-size to content
 *    • Edit a message -> all following messages are deleted (like ChatGPT)
 *    • Scrollable transcript + sticky "scroll to bottom" button
 * - Voice mic (Web Speech API): prevents duplicate lines by using final results only
 * - Voice call modal with animated circle (WebAudio analyser) that moves with voice
 * - Preferences: UI language switch (demo EN/ES) that actually changes labels
 * - Memories: add/view/delete memories (localStorage demo)
 * - Connectors: real URL fields (not just toggles)
 * - Danger Zone renamed to Delete Account
 * - Auth: login/register/logout screens that actually gate the app (localStorage demo)
 *
 * NOTE ABOUT "REAL" ACCOUNTS:
 *  This ships with a localStorage demo so you can test instantly. To turn on real auth,
 *  wire the three TODOs marked SUPABASE (or any provider) and set USE_DEMO_AUTH=false.
 */

// ---------- CONFIG ----------
const USE_DEMO_AUTH = true; // set to false and fill the SUPABASE TODOs for real accounts

const LANG = {
  en: {
    new: "New",
    library: "Library",
    settings: "Settings",
    searchConvos: "Search conversations…",
    typeMsg: "Type a message…",
    send: "Send",
    voice: "Voice",
    mic: "Mic",
    account: "Account",
    preferences: "Preferences",
    memories: "Memories",
    connectors: "Connectors",
    deleteAccount: "Delete account",
    signOut: "Sign out",
    uiLanguage: "UI language",
    spokenLanguage: "Spoken language",
    voiceModel: "Voice",
    save: "Save",
    login: "Log in",
    register: "Create account",
    name: "Name",
    email: "Email",
    phone: "Phone",
    password: "Password",
    confirmPassword: "Confirm password",
    addMemory: "Add memory",
    noMemories: "No memories yet",
    connectorsHelp: "Connect your apps by pasting links or OAuth in the future",
    startCall: "Start voice call",
    endCall: "End call",
    edited: "(edited)",
    edit: "Edit",
    delete: "Del",
    select: "Select",
    go: "Go",
  },
  es: {
    new: "Nuevo",
    library: "Biblioteca",
    settings: "Ajustes",
    searchConvos: "Buscar conversaciones…",
    typeMsg: "Escribe un mensaje…",
    send: "Enviar",
    voice: "Voz",
    mic: "Micrófono",
    account: "Cuenta",
    preferences: "Preferencias",
    memories: "Memorias",
    connectors: "Conectores",
    deleteAccount: "Eliminar cuenta",
    signOut: "Cerrar sesión",
    uiLanguage: "Idioma de la interfaz",
    spokenLanguage: "Idioma hablado",
    voiceModel: "Voz",
    save: "Guardar",
    login: "Iniciar sesión",
    register: "Crear cuenta",
    name: "Nombre",
    email: "Correo",
    phone: "Teléfono",
    password: "Contraseña",
    confirmPassword: "Confirmar contraseña",
    addMemory: "Agregar memoria",
    noMemories: "Aún no hay memorias",
    connectorsHelp: "Conecta tus apps pegando enlaces u OAuth en el futuro",
    startCall: "Iniciar llamada",
    endCall: "Terminar llamada",
    edited: "(editado)",
    edit: "Editar",
    delete: "Borrar",
    select: "Elegir",
    go: "Ir",
  },
};

// ---------- UTIL ----------
const uid = () => Math.random().toString(36).slice(2, 9);
const ls = {
  get: (k, v) => {
    try { return JSON.parse(localStorage.getItem(k) ?? "null") ?? v; } catch { return v; }
  },
  set: (k, v) => localStorage.setItem(k, JSON.stringify(v)),
  del: (k) => localStorage.removeItem(k),
};

// ---------- AUTH (demo) ----------
function useAuth() {
  const [user, setUser] = useState(() => ls.get("lucidian.user", null));

  const login = async (email, password) => {
    if (!USE_DEMO_AUTH) {
      // TODO SUPABASE: call supabase.auth.signInWithPassword({ email, password })
      return;
    }
    const db = ls.get("lucidian.users", []);
    const u = db.find((u) => u.email === email && u.password === password);
    if (!u) throw new Error("Invalid credentials");
    ls.set("lucidian.user", u);
    setUser(u);
  };

  const register = async (payload) => {
    if (!USE_DEMO_AUTH) {
      // TODO SUPABASE: call supabase.auth.signUp(payload)
      return;
    }
    const db = ls.get("lucidian.users", []);
    if (db.some((u) => u.email === payload.email)) throw new Error("Email in use");
    const u = { id: uid(), ...payload };
    db.push(u);
    ls.set("lucidian.users", db);
    ls.set("lucidian.user", u);
    setUser(u);
  };

  const logout = async () => {
    if (!USE_DEMO_AUTH) {
      // TODO SUPABASE: supabase.auth.signOut()
    }
    ls.del("lucidian.user");
    setUser(null);
  };

  const deleteAccount = () => {
    if (!user) return;
    const db = ls.get("lucidian.users", []);
    const rest = db.filter((u) => u.id !== user.id);
    ls.set("lucidian.users", rest);
    ["lucidian.mems", "lucidian.conns", "lucidian.convos"].forEach(ls.del);
    logout();
  };

  return { user, login, register, logout, deleteAccount };
}

// ---------- STARFIELD BG ----------
function Starfield() {
  const ref = useRef(null);
  useEffect(() => {
    const c = ref.current; if (!c) return; const ctx = c.getContext("2d");
    let w = (c.width = c.offsetWidth), h = (c.height = c.offsetHeight);
    const stars = Array.from({ length: 180 }, () => ({
      x: Math.random() * w,
      y: Math.random() * h,
      r: Math.random() * 1.1 + 0.2,
      a: Math.random() * 0.6 + 0.4,
      v: Math.random() * 0.4 + 0.2,
    }));
    let raf = 0;
    const draw = () => {
      ctx.clearRect(0, 0, w, h);
      stars.forEach((s) => {
        s.a += (Math.random() - 0.5) * 0.02; s.a = Math.max(0.1, Math.min(1, s.a));
        ctx.globalAlpha = s.a; ctx.beginPath(); ctx.arc(s.x, s.y, s.r, 0, Math.PI * 2); ctx.fillStyle = "#9fb7ff"; ctx.fill();
      });
      raf = requestAnimationFrame(draw);
    };
    draw();
    const onResize = () => { w = c.width = c.offsetWidth; h = c.height = c.offsetHeight; };
    window.addEventListener("resize", onResize);
    return () => { cancelAnimationFrame(raf); window.removeEventListener("resize", onResize); };
  }, []);
  return (
    <div className="absolute inset-0 -z-10">
      <div className="absolute inset-0 bg-gradient-to-b from-[#0b0f1a] to-[#04060b]" />
      <canvas ref={ref} className="w-full h-full block" />
    </div>
  );
}

// ---------- VOICE CALL MODAL ----------
function VoiceCall({ open, onClose, labels }) {
  const circle = useRef(null);
  const streamRef = useRef(null);
  const anim = useRef(0);

  useEffect(() => {
    if (!open) return;
    let audioCtx, analyser, source;
    navigator.mediaDevices.getUserMedia({ audio: true }).then((stream) => {
      streamRef.current = stream;
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 256;
      const bufferLength = analyser.frequencyBinCount;
      const dataArray = new Uint8Array(bufferLength);
      source = audioCtx.createMediaStreamSource(stream);
      source.connect(analyser);
      const step = () => {
        analyser.getByteFrequencyData(dataArray);
        const vol = dataArray.reduce((a, b) => a + b, 0) / (bufferLength * 255);
        if (circle.current) circle.current.style.transform = `scale(${1 + vol * 1.8})`;
        anim.current = requestAnimationFrame(step);
      };
      step();
    });
    return () => {
      cancelAnimationFrame(anim.current);
      if (streamRef.current) streamRef.current.getTracks().forEach((t) => t.stop());
    };
  }, [open]);

  if (!open) return null;
  return (
    <div className="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center p-6">
      <div className="bg-[#0d1324] border border-white/10 rounded-3xl shadow-2xl p-8 w-full max-w-md text-center relative">
        <div className="text-gray-300 mb-6">{labels.voice} • Live</div>
        <div className="mx-auto w-40 h-40 rounded-full bg-gradient-to-br from-indigo-500/30 to-cyan-400/30 grid place-items-center">
          <div ref={circle} className="w-28 h-28 rounded-full bg-white/20 transition-transform" />
        </div>
        <button onClick={onClose} className="mt-8 px-5 py-2 rounded-xl bg-white/10 hover:bg-white/20 text-white">
          {labels.endCall}
        </button>
      </div>
    </div>
  );
}

// ---------- SETTINGS MODAL ----------
function Settings({ open, onClose, user, setUser, lang, setLang, labels, onDeleteAccount }) {
  const [tab, setTab] = useState("account");
  const [form, setForm] = useState(user || {});
  const [mems, setMems] = useState(() => ls.get("lucidian.mems", []));
  const [conns, setConns] = useState(() => ls.get("lucidian.conns", { gmail: "", drive: "", docs: "", calendar: "", dropbox: "", box: "", notion: "" }));

  useEffect(() => setForm(user || {}), [user]);

  const saveAccount = () => { const merged = { ...user, ...form }; setUser(merged); ls.set("lucidian.user", merged); };
  const savePrefs = () => { /* lang handled by setLang */ };
  const saveConns = () => { ls.set("lucidian.conns", conns); };

  const addMemory = () => {
    const text = prompt("Memory text");
    if (!text) return; const m = { id: uid(), text, ts: Date.now() };
    const next = [m, ...mems]; setMems(next); ls.set("lucidian.mems", next);
  };
  const delMemory = (id) => { const next = mems.filter((m) => m.id !== id); setMems(next); ls.set("lucidian.mems", next); };

  if (!open) return null;
  return (
    <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-start justify-center p-6">
      <div className="bg-[#0d1324] border border-white/10 rounded-3xl shadow-2xl w-full max-w-3xl overflow-hidden">
        <div className="flex">
          <div className="w-56 border-r border-white/10 p-4 space-y-2">
            <SideTab active={tab === "account"} onClick={() => setTab("account")}>
              {labels.account}
            </SideTab>
            <SideTab active={tab === "preferences"} onClick={() => setTab("preferences")}>
              {labels.preferences}
            </SideTab>
            <SideTab active={tab === "memories"} onClick={() => setTab("memories")}>
              {labels.memories}
            </SideTab>
            <SideTab active={tab === "connectors"} onClick={() => setTab("connectors")}>
              {labels.connectors}
            </SideTab>
            <SideTab active={tab === "danger"} onClick={() => setTab("danger")}>
              {labels.deleteAccount}
            </SideTab>
            <button onClick={onClose} className="mt-4 w-full text-left text-white/60 hover:text-white">Close</button>
          </div>
          <div className="flex-1 p-6">
            {tab === "account" && (
              <div className="space-y-3">
                <LabeledInput label={labels.name} value={form.name || ""} onChange={(v) => setForm({ ...form, name: v })} />
                <LabeledInput label={labels.email} value={form.email || ""} onChange={(v) => setForm({ ...form, email: v })} />
                <LabeledInput label={labels.phone} value={form.phone || ""} onChange={(v) => setForm({ ...form, phone: v })} />
                <LabeledInput label={labels.password} type="password" value={form.password || ""} onChange={(v) => setForm({ ...form, password: v })} />
                <button className="px-4 py-2 rounded-xl bg-white/10 hover:bg-white/20" onClick={saveAccount}>{labels.save}</button>
              </div>
            )}
            {tab === "preferences" && (
              <div className="space-y-3">
                <div className="text-white/80">{labels.uiLanguage}</div>
                <select className="bg-white/10 rounded-xl p-2" value={lang} onChange={(e) => setLang(e.target.value)}>
                  <option value="en">English</option>
                  <option value="es">Español</option>
                </select>
                <div className="text-white/50 text-sm">(Demo: switches interface labels immediately)</div>
              </div>
            )}
            {tab === "memories" && (
              <div className="space-y-4">
                <div className="flex items-center justify-between">
                  <div className="text-white/80">{labels.memories}</div>
                  <button className="px-3 py-1.5 rounded-lg bg-white/10 hover:bg-white/20" onClick={addMemory}>{labels.addMemory}</button>
                </div>
                {mems.length === 0 && <div className="text-white/40">{labels.noMemories}</div>}
                <div className="space-y-2 max-h-72 overflow-auto pr-2">
                  {mems.map((m) => (
                    <div key={m.id} className="flex items-start gap-3 p-3 bg-white/5 rounded-xl">
                      <div className="text-white/80 flex-1">{m.text}</div>
                      <button onClick={() => delMemory(m.id)} className="text-red-300 hover:text-red-200">{labels.delete}</button>
                    </div>
                  ))}
                </div>
              </div>
            )}
            {tab === "connectors" && (
              <div className="space-y-3">
                <p className="text-white/60 text-sm">{labels.connectorsHelp}</p>
                {Object.entries(conns).map(([k, v]) => (
                  <LabeledInput key={k} label={k} value={v} onChange={(val) => setConns({ ...conns, [k]: val })} />
                ))}
                <button className="px-4 py-2 rounded-xl bg-white/10 hover:bg-white/20" onClick={saveConns}>{labels.save}</button>
              </div>
            )}
            {tab === "danger" && (
              <div className="space-y-4">
                <p className="text-white/70">This will remove your local data on this device (demo).</p>
                <button className="px-4 py-2 rounded-xl bg-red-600 hover:bg-red-500 text-white" onClick={onDeleteAccount}>{labels.deleteAccount}</button>
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
}

function SideTab({ children, active, onClick }) {
  return (
    <button onClick={onClick} className={`w-full text-left px-3 py-2 rounded-lg ${active ? "bg-white/15 text-white" : "text-white/70 hover:text-white hover:bg-white/5"}`}>
      {children}
    </button>
  );
}

function LabeledInput({ label, value, onChange, type = "text" }) {
  return (
    <label className="block">
      <div className="text-white/70 mb-1 capitalize">{label}</div>
      <input value={value} onChange={(e) => onChange(e.target.value)} type={type} className="w-full bg-white/10 rounded-xl px-3 py-2 text-white outline-none focus:ring-2 focus:ring-indigo-400" />
    </label>
  );
}

// ---------- CHAT ----------
function Chat({ labels, language }) {
  const listRef = useRef(null);
  const [input, setInput] = useState("");
  const [messages, setMessages] = useState(() => ls.get("lucidian.convos", []));
  const [editingId, setEditingId] = useState(null);
  const [atBottom, setAtBottom] = useState(true);
  const [callOpen, setCallOpen] = useState(false);

  // persist
  useEffect(() => { ls.set("lucidian.convos", messages); }, [messages]);

  // autoscroll when at bottom
  useEffect(() => {
    const el = listRef.current; if (!el) return;
    if (atBottom) el.scrollTop = el.scrollHeight;
  }, [messages, atBottom]);

  const onScroll = () => {
    const el = listRef.current; if (!el) return;
    setAtBottom(el.scrollTop + el.clientHeight >= el.scrollHeight - 20);
  };

  const send = (text) => {
    if (!text.trim()) return;
    if (editingId) {
      // Replace message by id, and DELETE anything after that id
      const idx = messages.findIndex((m) => m.id === editingId);
      if (idx !== -1) {
        const edited = { ...messages[idx], text, edited: true };
        setMessages([...messages.slice(0, idx), edited]);
      }
      setEditingId(null);
    } else {
      setMessages([...messages, { id: uid(), role: "user", text }]);
    }
    setInput("");
  };

  // Mic input – final results only (prevents duplicates)
  const recRef = useRef(null);
  const startMic = () => {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) { alert("SpeechRecognition not supported in this browser"); return; }
    const r = new SR();
    r.lang = language === "es" ? "es-ES" : "en-US";
    r.interimResults = false; // crucial to avoid duplicates
    r.maxAlternatives = 1;
    r.onresult = (e) => {
      const transcript = e.results[0][0].transcript;
      send(transcript);
    };
    r.onerror = (e) => console.error(e);
    r.onend = () => { recRef.current = null; };
    recRef.current = r; r.start();
  };

  const Bubble = ({ m }) => (
    <div className={`max-w-[80%] w-fit ${m.role === "user" ? "self-end" : "self-start"}`}>
      <div className={`rounded-2xl px-4 py-3 shadow ${m.role === "user" ? "bg-white/10" : "bg-emerald-900/30 border border-emerald-400/20"}`}>
        <div className="whitespace-pre-wrap break-words text-white/90 leading-relaxed">{m.text}</div>
        {m.edited && <div className="text-xs text-white/40 mt-1">{labels.edited}</div>}
      </div>
      <div className="flex gap-2 text-[12px] text-white/40 mt-1">
        <button onClick={() => { setEditingId(m.id); setInput(m.text); }} className="hover:text-white">{labels.edit}</button>
        <button onClick={() => setMessages(messages.filter((x) => x.id !== m.id))} className="hover:text-white">{labels.delete}</button>
      </div>
    </div>
  );

  return (
    <div className="relative h-full">
      <div ref={listRef} onScroll={onScroll} className="absolute inset-0 overflow-y-auto px-6 pb-28 pt-6 space-y-6 flex flex-col">
        {messages.map((m) => <Bubble key={m.id} m={m} />)}
      </div>

      {!atBottom && (
        <button onClick={() => { const el = listRef.current; if (el) el.scrollTop = el.scrollHeight; }} className="absolute bottom-28 left-1/2 -translate-x-1/2 px-3 py-1.5 rounded-full bg-white/10 text-white/80">↓</button>
      )}

      <div className="absolute bottom-0 inset-x-0 p-4">
        <div className="flex items-center gap-2 bg-white/5 border border-white/10 rounded-2xl p-2">
          <button onClick={startMic} className="px-3 py-2 rounded-xl bg-white/10 hover:bg-white/20 text-white/90">{labels.mic}</button>
          <input className="flex-1 bg-transparent outline-none text-white px-2" placeholder={labels.typeMsg} value={input} onChange={(e) => setInput(e.target.value)} onKeyDown={(e) => { if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); send(input); } }} />
          <button onClick={() => send(input)} className="px-4 py-2 rounded-xl bg-yellow-400 text-black font-medium hover:bg-yellow-300">{labels.send}</button>
          <button onClick={() => setCallOpen(true)} className="px-3 py-2 rounded-xl bg-white/10 hover:bg-white/20 text-white/90">{labels.voice}</button>
        </div>
      </div>

      <VoiceCall open={callOpen} onClose={() => setCallOpen(false)} labels={labels} />
    </div>
  );
}

// ---------- LOGIN / REGISTER ----------
function AuthScreen({ labels, onLogin, onRegister }) {
  const [mode, setMode] = useState("login");
  const [form, setForm] = useState({ name: "", email: "", phone: "", password: "", confirm: "" });
  const submit = async () => {
    try {
      if (mode === "login") await onLogin(form.email, form.password);
      else {
        if (form.password !== form.confirm) throw new Error("Passwords do not match");
        await onRegister({ name: form.name, email: form.email, phone: form.phone, password: form.password });
      }
    } catch (e) { alert(e.message); }
  };
  return (
    <div className="min-h-screen relative text-white">
      <Starfield />
      <header className="flex items-center justify-center py-10">
        <Wordmark />
      </header>
      <div className="max-w-md mx-auto p-6 bg-white/5 border border-white/10 rounded-3xl">
        <div className="flex gap-2 mb-4">
          <button onClick={() => setMode("login")} className={`px-3 py-1.5 rounded-xl ${mode === "login" ? "bg-white/15" : "bg-transparent hover:bg-white/10"}`}>{labels.login}</button>
          <button onClick={() => setMode("register")} className={`px-3 py-1.5 rounded-xl ${mode === "register" ? "bg-white/15" : "bg-transparent hover:bg-white/10"}`}>{labels.register}</button>
        </div>
        {mode === "register" && <LabeledInput label={labels.name} value={form.name} onChange={(v) => setForm({ ...form, name: v })} />}
        <div className="grid gap-3 mt-3">
          <LabeledInput label={labels.email} value={form.email} onChange={(v) => setForm({ ...form, email: v })} />
          {mode === "register" && <LabeledInput label={labels.phone} value={form.phone} onChange={(v) => setForm({ ...form, phone: v })} />}
          <LabeledInput label={labels.password} type="password" value={form.password} onChange={(v) => setForm({ ...form, password: v })} />
          {mode === "register" && <LabeledInput label={labels.confirmPassword} type="password" value={form.confirm} onChange={(v) => setForm({ ...form, confirm: v })} />}
        </div>
        <button onClick={submit} className="mt-4 w-full px-4 py-2 rounded-xl bg-yellow-400 text-black font-medium hover:bg-yellow-300">{mode === "login" ? labels.login : labels.register}</button>
      </div>
    </div>
  );
}

// ---------- HEADER ----------
function Wordmark() {
  return (
    <div className="w-full grid grid-cols-[1fr_auto_1fr] items-center px-6">
      {/* Settings on far left – as requested */}
      <div className="justify-self-start">
        <span className="px-3 py-1 rounded-lg bg-white/10 text-white/80">Settings</span>
      </div>
      {/* LUCIDIAN centered */}
      <div className="justify-self-center text-3xl tracking-[0.6em] text-yellow-300 font-semibold select-none">L U C I D I A N</div>
      {/* ROUND symbol on RIGHT */}
      <div className="justify-self-end">
        <LogoOrb />
      </div>
    </div>
  );
}

function LogoOrb() {
  return (
    <div className="w-10 h-10 rounded-full bg-yellow-300/20 border border-yellow-300/60 grid place-items-center shadow-inner">
      <svg width="22" height="22" viewBox="0 0 22 22" fill="none">
        <circle cx="11" cy="11" r="9" stroke="#f8e16a" strokeWidth="1.4"/>
        <circle cx="11" cy="5" r="1.1" fill="#f8e16a"/>
        <circle cx="6" cy="10" r="1" fill="#f8e16a"/>
        <circle cx="16" cy="10" r="1" fill="#f8e16a"/>
        <circle cx="11" cy="17" r="1" fill="#f8e16a"/>
        <path d="M11 5 L6 10 L11 17 L16 10 Z" stroke="#f8e16a" strokeWidth="1" fill="none"/>
      </svg>
    </div>
  );
}

// ---------- APP SHELL ----------
export default function LucidianApp() {
  const { user, login, register, logout, deleteAccount } = useAuth();
  const [lang, setLang] = useState(ls.get("lucidian.lang", "en"));
  const labels = useMemo(() => LANG[lang], [lang]);
  useEffect(() => ls.set("lucidian.lang", lang), [lang]);

  const [settingsOpen, setSettingsOpen] = useState(false);

  if (!user) return (
    <AuthScreen labels={labels} onLogin={login} onRegister={register} />
  );

  return (
    <div className="min-h-screen relative text-white">
      <Starfield />

      <div className="fixed top-4 left-4 z-20">
        <button onClick={() => setSettingsOpen(true)} className="px-3 py-1.5 rounded-lg bg-white/10 hover:bg-white/20">{labels.settings}</button>
      </div>

      {/* Header with centered wordmark and RIGHT orb */}
      <header className="py-5">
        <div className="w-full grid grid-cols-[1fr_auto_1fr] items-center px-6">
          <div className="justify-self-start" />
          <div className="justify-self-center text-3xl tracking-[0.6em] text-yellow-300 font-semibold select-none">L U C I D I A N</div>
          <div className="justify-self-end"><LogoOrb /></div>
        </div>
      </header>

      <main className="grid grid-cols-[290px_1fr] gap-4 px-6 pb-6 h-[calc(100vh-120px)]">
        {/* Sidebar */}
        <aside className="bg-white/5 border border-white/10 rounded-3xl p-4 flex flex-col">
          <div className="flex gap-2 mb-3">
            <button className="px-3 py-1.5 rounded-xl bg-yellow-400 text-black font-medium">{labels.new}</button>
            <button className="px-3 py-1.5 rounded-xl bg-white/10 hover:bg-white/20">{labels.library}</button>
          </div>
          <div className="mb-3">
            <input placeholder={labels.searchConvos} className="w-full bg-white/10 rounded-xl px-3 py-2 outline-none" />
            <button className="mt-2 w-full px-3 py-1.5 rounded-xl bg-white/10 hover:bg-white/20">{labels.go}</button>
          </div>
          <div className="text-white/50 text-sm mb-2">Conversations</div>
          <div className="space-y-2 overflow-auto pr-1">
            {Array.from({ length: 7 }).map((_, i) => (
              <div key={i} className="flex items-center justify-between bg-white/5 rounded-xl p-2">
                <div className="text-white/80 truncate">New Conversation</div>
                <div className="flex gap-2 text-[12px] text-white/50">
                  <button className="hover:text-white">{labels.select}</button>
                  <button className="hover:text-white">{labels.delete}</button>
                </div>
              </div>
            ))}
          </div>
          <div className="mt-auto pt-4 text-white/60 text-sm">
            <button onClick={logout} className="hover:text-white underline">{labels.signOut}</button>
          </div>
        </aside>

        {/* Chat Area */}
        <section className="bg-white/5 border border-white/10 rounded-3xl relative">
          <Chat labels={labels} language={lang} />
        </section>
      </main>

      <Settings
        open={settingsOpen}
        onClose={() => setSettingsOpen(false)}
        user={user}
        setUser={(u) => ls.set("lucidian.user", u)}
        lang={lang}
        setLang={setLang}
        labels={labels}
        onDeleteAccount={deleteAccount}
      />
    </div>
  );
}
