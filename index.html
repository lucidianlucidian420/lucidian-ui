<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="theme-color" content="#0b111a" />
<title>Lucidian</title>

<style>
/* ========== THEME ========== */
:root{
  --gold:#e7c76a;
  --panel:rgba(12,18,28,.34);
  --edge:rgba(32,45,65,.36);
  --bubble:rgba(18,28,44,.50);
  --bubbleUser:rgba(22,34,52,.50);
  --starSpeed:140s;    /* slower */
  --starSpeedSlow:195s;
  --maxw:1200px;

  /* Header sizing you can tweak quickly */
  --sigSizeMobile:86px;
  --sigSizeDesk:104px;
  --titleSizeMobile:22px;
  --titleSizeDesk:22px;
}

/* Reset-ish */
*{box-sizing:border-box}
html,body{
  margin:0;
  height:100%;
  background:#03060a;
  color:#d6e1f7;
  font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;
}

/* Use small/large viewport units so mobile toolbars donâ€™t hide content */
.app{
  min-height:100svh;
  display:grid;
  grid-template-rows:auto 1fr auto; /* header | content | footer */
}

/* ========== COSMIC BACKDROP ========== */
.space{
  position:fixed; inset:0; overflow:hidden;
  background:radial-gradient(1100px 760px at 50% 18%,#0b2540 0%,#07111d 46%,#03060a 100%);
  z-index:0;
}
.stars,.stars2,.stars3{
  position:absolute; inset:-200% -200% -200% -200%;
  background-repeat:repeat;
  background-image:
    radial-gradient(1px 1px at 20px 30px,#fff8,transparent 2px),
    radial-gradient(1px 1px at 80px 120px,#bde2ff88,transparent 2px),
    radial-gradient(1px 1px at 200px 80px,#fff8,transparent 2px),
    radial-gradient(1px 1px at 320px 40px,#9ad1ff66,transparent 2px),
    radial-gradient(1px 1px at 400px 160px,#fff8,transparent 2px),
    radial-gradient(1px 1px at 440px 260px,#cfe8ff77,transparent 2px),
    radial-gradient(1px 1px at 120px 300px,#fff8,transparent 2px),
    radial-gradient(1px 1px at 260px 340px,#fff6,transparent 2px);
  background-size:500px 500px;
  animation:drift var(--starSpeed) linear infinite;
  opacity:.75;
}
.stars2{filter:blur(.35px);opacity:.5;animation-duration:var(--starSpeedSlow)}
.stars3{filter:blur(.8px);opacity:.35;animation-direction:reverse}
@keyframes drift{from{transform:translate3d(0,0,0)} to{transform:translate3d(-25%,-25%,0)}}

/* ========== HEADER ========== */
header{
  position:sticky; top:0; z-index:3;
  padding:10px 16px;
  background:linear-gradient(#0b111add,#0b111a88 70%,transparent);
  border-bottom:1px solid #1b2738;
  backdrop-filter:blur(6px);
}
.brand{
  max-width:var(--maxw); margin:0 auto;
  display:flex; align-items:center; gap:14px; justify-content:flex-start;
}
#sig{
  width:var(--sigSizeMobile); height:var(--sigSizeMobile);
  object-fit:contain;
  filter:drop-shadow(0 0 10px #7ec4ff88);
}
h1{
  margin:0; color:var(--gold); font-weight:800;
  letter-spacing:.45em; font-size:var(--titleSizeMobile);
}
@media (min-width:900px){
  #sig{ width:var(--sigSizeDesk); height:var(--sigSizeDesk) }
  h1{ font-size:var(--titleSizeDesk) }
}

/* ========== CONTENT ROW ========== */
.content{
  max-width:var(--maxw); margin:8px auto 0; padding:0 16px;
  display:grid; grid-template-columns:280px 1fr; gap:14px;
  min-height:0; /* so children can scroll */
  position:relative; z-index:1;
}
@media (max-width:900px){ .content{ grid-template-columns:1fr } }

/* Sidebar (drawer on mobile) */
.hamburger{
  display:none; position:absolute; left:18px; top:-42px; /* sits inside header area */
  z-index:5; background:#0f1722cc; border:1px solid #233049; color:#cfe2ff;
  padding:8px 10px; border-radius:10px;
}
@media (max-width:900px){ .hamburger{ display:block } }

.sidebar{
  background:var(--panel); border:1px solid var(--edge); border-radius:12px; padding:12px;
  overflow-y:auto; overflow-x:hidden; min-height:0;
}
@media (max-width:900px){
  .sidebar{
    position:fixed; top:74px; left:0; bottom:72px;
    width:86vw; max-width:360px;
    transform:translateX(-120%); transition:transform .25s ease;
    border-radius:0 12px 12px 0; z-index:4;
  }
  .drawerOpen .sidebar{ transform:translateX(0) }
}
.searchRow{ display:flex; gap:6px }
.searchRow input{
  flex:1; padding:10px 12px; border-radius:10px;
  border:1px solid #233049; background:#0e1623; color:#d6e1f7;
}
.btn{
  background:#1c2636; border:1px solid #2a3850; color:#d6e1f7;
  padding:10px 12px; border-radius:10px; cursor:pointer; white-space:nowrap;
}
.list{ margin-top:10px; display:flex; flex-direction:column; gap:8px }
.conv{
  display:flex; align-items:center; justify-content:space-between;
  padding:10px 12px; background:rgba(15,23,36,.6);
  border:1px solid #223147; border-radius:10px;
}
.conv .ttl{
  overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:180px;
}

/* Chat panel: light, shows sky through */
.panel{
  background:var(--panel); border:1px solid var(--edge); border-radius:12px;
  display:flex; flex-direction:column; min-height:0; backdrop-filter:blur(3px);
}
.msgs{ flex:1; overflow:auto; padding:16px }
.bubble{
  background:var(--bubble); border:1px solid rgba(41,64,92,.6);
  color:#dbe8ff; padding:12px 14px; border-radius:12px;
  margin:10px 0; max-width:820px;
  box-shadow:0 0 24px rgba(231,199,106,.12);
}
.bubble.user{ background:var(--bubbleUser); border-color:#2e4765 }

/* ========== FOOTER (TRULY BOTTOM) ========== */
footer{
  position:sticky; bottom:0; z-index:3;
  background:rgba(8,12,20,.68); border-top:1px solid rgba(28,41,64,.6);
  backdrop-filter:blur(6px);
}
.footerInner{ max-width:var(--maxw); margin:0 auto; padding:10px 16px }
.inputRow{
  display:grid; grid-template-columns:auto auto 1fr auto auto;
  gap:8px; align-items:center;
}
.iconbtn{
  height:40px; min-width:40px; display:grid; place-items:center;
  border-radius:10px; border:1px solid #2a3850; background:#131c2a; color:#cfe2ff;
  cursor:pointer;
}
.inputRow input[type="file"]{ display:none }
.chatInput{
  height:40px; padding:10px 12px; border-radius:10px;
  border:1px solid #2a3850; background:#0f1724; color:#def;
}
.btn.gold{ background:linear-gradient(#e7c76a,#d2b252); color:#111; border:none; font-weight:700 }
.voiceDot{ width:10px;height:10px;border-radius:50%;background:#c22;box-shadow:0 0 10px #f55;display:none;margin-left:6px }
.callOn .voiceDot{ display:inline-block; background:#48d048; box-shadow:0 0 10px #2fe }
.footerNote{ opacity:.6; font-size:.82rem; padding:6px 4px 0 }

/* Modal */
.modal{ position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.55); z-index:6 }
.modal.open{ display:grid }
.modalCard{ width:min(92vw,620px); background:#0f1724; border:1px solid #223147; border-radius:14px; padding:16px }
.row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }
.meter{ height:10px; background:#122032; border:1px solid #23405d; border-radius:8px; overflow:hidden }
.meter>div{ height:100%; width:0; background:linear-gradient(90deg,#4df,#7fffb8); box-shadow:0 0 10px #3df }

/* No accidental horizontal scroll anywhere */
html, body{ overflow-x:hidden }
</style>
</head>
<body>
<div class="space"><div class="stars"></div><div class="stars2"></div><div class="stars3"></div></div>

<div class="app">
  <!-- HEADER -->
  <header>
    <div class="brand" role="banner">
      <button class="hamburger" aria-label="Open conversations">â˜° Conversations</button>
      <img id="sig" src="symbol.png" alt="Lucidian symbol" />
      <h1 aria-label="Lucidian">L U C I D I A N</h1>
    </div>
  </header>

  <!-- CONTENT -->
  <main class="content" id="content">
    <aside class="sidebar" id="sidebar" aria-label="Past conversations">
      <div class="searchRow">
        <input id="search" placeholder="Search conversationsâ€¦" />
        <button class="btn" id="goBtn">Go</button>
        <button class="btn" id="newBtn">New</button>
      </div>
      <div class="list" id="convList"></div>
    </aside>

    <section class="panel" aria-live="polite">
      <div class="msgs" id="msgs"></div>
    </section>
  </main>

  <!-- FOOTER -->
  <footer>
    <div class="footerInner">
      <div class="inputRow" role="group" aria-label="Compose">
        <!-- order: Attach â†’ Mic â†’ Chat â†’ Send â†’ Voice -->
        <label class="iconbtn" title="Attach">
          ğŸ“<input id="fileInput" type="file" multiple />
        </label>
        <button class="iconbtn" id="micBtn" title="Mic input" aria-label="Dictate with microphone">ğŸ™ï¸</button>
        <input class="chatInput" id="chat" placeholder="Type a messageâ€¦" aria-label="Message input" />
        <button class="btn gold" id="sendBtn" aria-label="Send">Send</button>
        <button class="iconbtn" id="voiceBtn" title="Call mode (speak replies)" aria-label="Voice call mode">
          ğŸ”Š<span class="voiceDot" id="voiceDot"></span>
        </button>
      </div>
      <div class="footerNote" id="attachNote" aria-live="polite"></div>
    </div>
  </footer>
</div>

<!-- Voice modal -->
<div class="modal" id="voiceModal" role="dialog" aria-modal="true" aria-labelledby="voiceTitle">
  <div class="modalCard">
    <h3 id="voiceTitle">Lucidian â€” Voice Call</h3>
    <div class="row" style="margin:8px 0 12px">
      <button class="btn gold" id="startCall">Start</button>
      <button class="btn" id="stopCall">Stop</button>
      <div style="flex:1" class="meter"><div id="meterBar"></div></div>
    </div>
    <p style="opacity:.75;margin:0">When call is on: your mic transcribes and autoâ€‘sends on pauses; Lucidian speaks replies.</p>
    <div style="text-align:right;margin-top:12px"><button class="btn" id="closeModal">Close</button></div>
  </div>
</div>

<script>
/* ---- helpers ---- */
const $ = id => document.getElementById(id);
const msgs=$('msgs'), chat=$('chat'), fileInput=$('fileInput'), attachNote=$('attachNote');
const micBtn=$('micBtn'), sendBtn=$('sendBtn'), voiceBtn=$('voiceBtn'), voiceDot=$('voiceDot');
const sidebar=$('sidebar'), hamburger=document.querySelector('.hamburger');
const voiceModal=$('voiceModal'), startCall=$('startCall'), stopCall=$('stopCall'), closeModal=$('closeModal'), meterBar=$('meterBar');
const convList=$('convList'), search=$('search'), goBtn=$('goBtn'), newBtn=$('newBtn');

let conversations = JSON.parse(localStorage.getItem('lucidian_convs')||'[]');
let activeId = conversations[0]?.id || createConversation('New Conversation');
let callOn=false, speakReplies=false, recognizer=null, meterTimer=null;

/* ---- conversation state ---- */
function save(){ localStorage.setItem('lucidian_convs', JSON.stringify(conversations)); }
function addBubble(role,text){
  const b=document.createElement('div');
  b.className='bubble'+(role==='user'?' user':'');
  b.textContent=text;
  msgs.appendChild(b);
  msgs.scrollTop=msgs.scrollHeight;
}
function setTitleFromFirstUser(conv){
  const first=conv.messages.find(m=>m.role==='user');
  if(first && first.text.trim()) conv.title=first.text.slice(0,28);
}
function refreshList(filter=''){
  convList.innerHTML='';
  conversations
    .filter(c=>c.title.toLowerCase().includes(filter.toLowerCase()))
    .forEach(c=>{
      const item=document.createElement('div'); item.className='conv';
      const ttl=document.createElement('div'); ttl.className='ttl'; ttl.textContent=c.title||'New Conversation';
      const sel=document.createElement('button'); sel.className='btn'; sel.textContent='Select'; sel.onclick=()=>openConv(c.id);
      item.appendChild(ttl); item.appendChild(sel);
      convList.appendChild(item);
    });
}
function openConv(id){
  activeId=id; msgs.innerHTML='';
  const c=conversations.find(x=>x.id===id);
  c.messages.forEach(m=>addBubble(m.role,m.text));
  if(window.innerWidth<900){ document.body.classList.remove('drawerOpen'); }
}
function createConversation(title='New Conversation'){
  const c={id:crypto.randomUUID(), title, messages:[]};
  conversations.unshift(c); save(); refreshList(); openConv(c.id); return c.id;
}

/* ---- boot ---- */
(function(){
  if(!conversations.length) createConversation('New Conversation');
  refreshList(); openConv(activeId);
  if(!conversations[0].messages.length) addBubble('lucidian','Hello, Ky.');
})();

/* ---- drawer + search ---- */
hamburger.onclick=()=>document.body.classList.toggle('drawerOpen');
goBtn.onclick = ()=>refreshList(search.value||'');

/* ---- attachments ---- */
fileInput.onchange=()=>{
  if(fileInput.files?.length){
    const names=[...fileInput.files].map(f=>f.name).join(', ');
    attachNote.textContent=`Attached: ${names}`;
  }else attachNote.textContent='';
};

/* ---- send (placeholder reply until backend is wired) ---- */
async function send(text){
  if(!text?.trim()) return;
  addBubble('user', text.trim());
  const conv=conversations.find(c=>c.id===activeId);
  conv.messages.push({role:'user', text:text.trim(), ts:Date.now()});
  if(!conv.title || conv.title==='New Conversation'){ setTitleFromFirstUser(conv); refreshList(); }
  save();

  const reply = "Echoing intention: " + text.trim(); // replace with API stream
  await streamAppend(reply);
}
async function streamAppend(full){
  const conv=conversations.find(c=>c.id===activeId);
  const b=document.createElement('div'); b.className='bubble'; b.textContent='';
  msgs.appendChild(b);
  for(const ch of full){
    b.textContent+=ch; msgs.scrollTop=msgs.scrollHeight;
    await new Promise(r=>setTimeout(r,12));
  }
  conv.messages.push({role:'lucidian', text:b.textContent, ts:Date.now()}); save();
  if(speakReplies) speak(b.textContent);
}
sendBtn.onclick=()=>{ const t=chat.value; chat.value=''; send(t); };
chat.addEventListener('keydown',e=>{ if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); sendBtn.click(); }});

/* ---- voice: singleâ€‘shot mic button ---- */
micBtn.onclick=()=>{
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR) return alert('Speech Recognition not supported in this browser (Chrome/Edge over HTTPS recommended).');
  const r=new SR(); r.lang='en-US'; r.interimResults=false;
  r.onresult=e=>{ chat.value=e.results[0][0].transcript.trim(); };
  r.start();
};

/* ---- voice: call mode ---- */
voiceBtn.onclick=()=>voiceModal.classList.add('open');
closeModal.onclick=()=>voiceModal.classList.remove('open');

function ensureRecognizer(){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR) return null;
  const r=new SR(); r.lang='en-US'; r.interimResults=true; r.continuous=true;
  return r;
}
function startRecognizer(){
  recognizer=ensureRecognizer();
  if(!recognizer){ alert('Speech Recognition not supported in this browser.'); return; }
  recognizer.onresult=e=>{
    let final='', interim='';
    for(let i=e.resultIndex;i<e.results.length;i++){
      const res=e.results[i];
      if(res.isFinal) final+=res[0].transcript;
      else interim+=res[0].transcript;
    }
    chat.value=(final||interim).trim();
    if(final.trim()){ const text=final.trim(); chat.value=''; send(text); }
  };
  recognizer.onend=()=>{ if(callOn) recognizer.start(); }; // keep alive during call
  recognizer.start();
}
function stopRecognizer(){ try{ recognizer && recognizer.stop(); }catch{} }
function speak(text){
  if(!('speechSynthesis' in window)) return;
  const u=new SpeechSynthesisUtterance(text);
  u.rate=1; u.pitch=1; u.volume=1;
  speechSynthesis.cancel(); speechSynthesis.speak(u);
}
function setMeter(active){
  clearInterval(meterTimer);
  if(!active){ meterBar.style.width='0%'; return; }
  meterTimer=setInterval(()=>{
    const w=15+Math.random()*70; meterBar.style.width=w.toFixed(0)+'%';
  },130);
}

startCall.onclick=()=>{
  callOn=true; speakReplies=true; document.body.classList.add('callOn'); voiceDot.style.display='inline-block';
  startRecognizer(); setMeter(true);
};
stopCall.onclick=()=>{
  callOn=false; speakReplies=false; document.body.classList.remove('callOn'); voiceDot.style.display='none';
  stopRecognizer(); speechSynthesis.cancel(); setMeter(false);
};

/* Close drawer if you tap outside on mobile */
document.addEventListener('click', (e)=>{
  if(window.innerWidth>=900) return;
  if(document.body.classList.contains('drawerOpen') && !sidebar.contains(e.target) && !hamburger.contains(e.target)){
    document.body.classList.remove('drawerOpen');
  }
});
</script>
</body>
</html>
