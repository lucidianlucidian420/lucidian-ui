<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Lucidian</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='48' fill='%230a0a0a' stroke='%23d7b24a' stroke-width='4'/%3E%3C/svg%3E">
<style>
/* ---------- Theme ---------- */
:root{
  --bg-0:#0e1014;           /* darker background */
  --bg-1:#0b0d11;
  --text:#ede9dd;
  --muted:#a7a7a7;
  --brand-gold:#ffd76a;
  --brand-gold-soft:rgba(255,215,106,.55);
  --accent-1:#2b2f36;
  --bubble-user:#3a4150;
  --bubble-ai: rgba(255,215,106,.06);
  --border-ai: #d7b24a;
  --border-user: rgba(255,255,255,.2);

  --header-h: 72px;         /* thinner header (was 84) */
  --symbol-size: 66px;      /* slightly smaller (was 74) */
  --radius: 14px;
  --shadow: 0 12px 40px rgba(0,0,0,.45);
}

/* ---------- Reset ---------- */
html,body{height:100%}
*{box-sizing:border-box}
body{
  margin:0; color:var(--text); background:var(--bg-0); font:16px/1.45 Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
  overflow:hidden;
}

/* ---------- Layout ---------- */
.header{
  position:sticky; top:0; z-index:1200;
  height:var(--header-h);
  background:linear-gradient(180deg, rgba(15,18,23,.95), rgba(15,18,23,.86));
  border-bottom:1px solid rgba(255,255,255,.06);
  display:grid; grid-template-columns:auto 1fr auto; align-items:center;
  gap:12px; padding:0 16px;
  overflow:visible; /* keep symbol usable even if it slightly overflows */
}
.brand-left{
  display:flex; align-items:center; gap:8px;
}
.account-chip{
  position:relative; z-index:1400;
  padding:6px 10px; border-radius:10px; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.12);
  color:#fff; cursor:pointer; user-select:none;
}
.brand-wrap{display:flex; align-items:center; justify-content:center; min-width:0;}
.logo{
  letter-spacing: .6rem; font-weight: 800; font-size: clamp(18px, 2.8vw, 36px);
  color:var(--brand-gold); text-align:center; user-select:none;
}
.logo span{display:inline-block; transform: translateY(.5px);}
.symbol{
  width:var(--symbol-size); height:var(--symbol-size);
  border-radius:50%;
  background: radial-gradient(circle at 50% 50%, #ffefb0 0%, #ffd76a 35%, #d7b24a 60%, #8b6a20 100%);
  box-shadow:0 0 40px rgba(255,215,106,.55), inset 0 0 12px rgba(0,0,0,.35);
}
@media (max-width:1024px){
  :root{ --symbol-size: clamp(48px, 7vw, 66px); }
}

/* Shell */
.app{display:grid; grid-template-columns: 320px 1fr; height: calc(100vh - var(--header-h));}
.sidebar{
  background: linear-gradient(180deg, rgba(20,20,24,.88), rgba(14,14,18,.88));
  border-right: 1px solid rgba(255,255,255,.06);
  padding:12px 10px; overflow:auto;
}
.main{
  position:relative;
  height:100%; overflow:hidden;
  background: radial-gradient(circle at 50% 30%, rgba(35,66,96,.25), transparent 55%), radial-gradient(circle at 40% 80%, rgba(18,45,67,.2), transparent 50%), var(--bg-1);
}
.canvas-wrap{position:absolute; inset:0; z-index:0}
#stars{position:absolute; inset:0; display:block}

/* Chat column */
.chat{
  position:relative; z-index:1; height:100%;
  display:grid; grid-template-rows: 1fr auto; gap:0;
}
.stream{overflow:auto; padding: 16px 18px 120px;}

/* Bubbles */
.msg{max-width:min(70ch, 78%); padding:10px 14px; border-radius:var(--radius);
  margin:14px 0; position:relative; backdrop-filter: blur(2px);
  word-wrap: break-word; overflow-wrap: anywhere;
  display:inline-flex; align-items:flex-start;
}
.msg.left{background:var(--bubble-ai); border:1px solid var(--border-ai); color:var(--text);}
.msg.right{background:var(--bubble-user); border:1px solid var(--border-user); margin-left:auto;}
.msg .actions{
  position:absolute; right:6px; top:-28px; display:none; gap:8px;
}
.msg:hover .actions{display:flex}
.msg .actions button{
  background:rgba(20,20,24,.9); color:#fff; border:1px solid rgba(255,255,255,.15); border-radius:8px; padding:4px 8px; cursor:pointer;
}
.msg img.thumb{display:block; max-width:220px; max-height:260px; border-radius:12px; border:1px solid rgba(255,255,255,.18);}

/* Composer */
.composer{
  position:absolute; left:0; right:0; bottom:0; z-index:2;
  padding:10px; background: linear-gradient(180deg, transparent, rgba(0,0,0,.55) 40%, rgba(0,0,0,.8));
  border-top:1px solid rgba(255,255,255,.06);
}
.composer .row{
  display:flex; gap:10px; align-items:center;
  background:rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.12); border-radius:12px; padding:8px;
}
button, .btn{
  background: #f2cb62; color:#201b0f; border:0; border-radius:10px; padding:8px 12px; font-weight:600; cursor:pointer;
}
.btn-ghost{ background:rgba(255,255,255,.08); color:#fff; border:1px solid rgba(255,255,255,.18);}
input[type="text"], textarea{
  flex:1; padding:10px 12px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.18); border-radius:10px; color:var(--text);
}

/* Sidebar bits */
.section-title{font-weight:700; margin:8px 4px 6px;}
.sidebar .pill{display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:10px; background:linear-gradient(180deg,#f0cc63,#d7b24a); color:#241f10; font-weight:700; cursor:pointer; user-select:none;}
.sidebar .search{display:flex; gap:8px; align-items:center; margin:10px 0 12px;}
.list{display:flex; flex-direction:column; gap:8px;}
.conv-item{display:grid; grid-template-columns:1fr auto auto; gap:8px; align-items:center; padding:8px; background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.1); border-radius:10px;}
.conv-item .danger{background:#d9534f; color:#fff;}
.sidebar .account-card{padding:10px; border:1px solid rgba(255,255,255,.1); border-radius:10px; background:rgba(255,255,255,.04); margin-bottom:10px}

/* Library modal */
#libraryOverlay{position:fixed; inset:0; background:rgba(0,0,0,.45); backdrop-filter: blur(2px); z-index:2400; display:none;}
#libraryPanel{
  position:fixed; left:50%; top:calc(var(--header-h) + 20px); transform:translateX(-50%);
  width:min(720px, calc(100vw - 36px)); max-height:min(70vh, 900px); overflow:auto;
  background:rgba(20,20,22,.98); border:1px solid var(--brand-gold-soft); border-radius:14px; padding:18px;
  z-index:2450; display:none; box-shadow: var(--shadow);
}
.library-grid{display:grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap:12px;}
.lib-card{background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.12); border-radius:12px; padding:10px;}
.lib-card img{display:block; width:100%; height:150px; object-fit:cover; border-radius:10px; margin-bottom:8px}
.lib-actions{display:flex; gap:8px;}

/* Profile overlay (ALWAYS on top) */
#profileOverlay{ position:fixed; inset:0; background:rgba(0,0,0,.45); backdrop-filter:blur(2px); z-index:3000; display:none;}
#profilePanel{
  position:fixed; top:calc(var(--header-h) + 10px); left:16px; width:min(380px, calc(100vw - 32px));
  max-height:min(78vh, 900px); overflow:auto; padding:16px;
  border-radius:12px; background:rgba(20,20,22,.98); border:1px solid var(--brand-gold-soft);
  box-shadow:0 18px 50px rgba(0,0,0,.6); z-index:3100; display:none;
}
#profilePanel .row{display:flex; gap:8px; margin:8px 0}
#profilePanel input{width:100%}

/* Responsive drawer on small screens */
@media (max-width: 880px){
  .app{grid-template-columns: 1fr}
  .sidebar{position:fixed; z-index:1300; left:0; top:var(--header-h); bottom:0; width:min(88vw, 360px); transform: translateX(-102%); transition:.25s transform ease;}
  .sidebar.open{transform: translateX(0)}
  .account-chip{order:2}
  .menu-btn{display:inline-flex}
}
.menu-btn{display:none; gap:6px; align-items:center}
.menu-btn .bar{width:18px; height:2px; background:#fff; opacity:.9}

/* Toast */
.toast{position:fixed; left:50%; bottom:16px; transform:translateX(-50%); background:#222; color:#fff; padding:8px 12px; border-radius:8px; border:1px solid rgba(255,255,255,.12); box-shadow:var(--shadow); z-index:4000; display:none}
</style>
</head>
<body>

<!-- Header -->
<header class="header">
  <div class="brand-left">
    <button class="menu-btn btn-ghost" id="menuBtn" title="Menu"><span class="bar"></span><span class="bar"></span><span class="bar"></span></button>
    <div class="account-chip" id="accountBtn"><span id="accountName">guest</span> â–¾</div>
  </div>
  <div class="brand-wrap"><div class="logo" aria-hidden="true"><span>L U C I D I A N</span></div></div>
  <div class="symbol" title="Lucidian"></div>
</header>

<!-- App -->
<div class="app">
  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="account-card">
      <div class="section-title">Profile</div>
      <div style="font-size:12px;color:var(--muted)">Signed in as <strong id="profileMiniName">guest</strong></div>
    </div>

    <div class="pill" id="newConvBtn">New</div>

    <div class="section-title" style="margin-top:12px">Library</div>
    <button class="btn-ghost" id="openLibBtn">Open</button>

    <div class="section-title" style="margin-top:14px">Search</div>
    <div class="search">
      <input id="searchInput" type="text" placeholder="Search conversations..." />
      <button class="btn-ghost" id="searchBtn">Go</button>
    </div>

    <div id="convList" class="list" aria-label="Conversations"></div>
  </aside>

  <!-- Main -->
  <main class="main">
    <div class="canvas-wrap"><canvas id="stars"></canvas></div>

    <section class="chat">
      <div id="stream" class="stream" aria-live="polite"></div>

      <div class="composer">
        <div class="row">
          <input type="file" id="fileInput" multiple hidden />
          <button class="btn-ghost" id="attachBtn">Attach</button>
          <button class="btn-ghost" id="micBtn">ðŸŽ¤ Mic</button>
          <input id="msgInput" type="text" placeholder="Type a message..." />
          <button class="btn" id="sendBtn">Send</button>
          <button class="btn-ghost" id="voiceCallBtn">Voice</button>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- Library Modal -->
<div id="libraryOverlay"></div>
<div id="libraryPanel" role="dialog" aria-modal="true" aria-labelledby="libTitle">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
    <h3 id="libTitle" style="margin:0">Shared Library</h3>
    <button class="btn-ghost" id="closeLibBtn">Close</button>
  </div>
  <div class="library-grid" id="libraryGrid"></div>
</div>

<!-- Profile Overlay -->
<div id="profileOverlay"></div>
<div id="profilePanel" role="dialog" aria-modal="true" aria-labelledby="profTitle">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
    <h3 id="profTitle" style="margin:0">Account</h3>
    <button class="btn-ghost" id="closeProfileBtn">Close</button>
  </div>
  <div class="row"><input id="profName" placeholder="Name"></div>
  <div class="row"><input id="profEmail" placeholder="Email"></div>
  <div class="row"><input id="profPhone" placeholder="Phone"></div>
  <div class="row"><input id="profLang" placeholder="Language (e.g., en, es)"></div>
  <div class="row" style="justify-content:flex-end; gap:8px">
    <button class="btn-ghost" id="signOutBtn">Sign out</button>
    <button class="btn" id="saveProfileBtn">Save</button>
  </div>
  <div class="section-title" style="margin-top:12px">Lucidian Memory</div>
  <div id="memoryList" style="font-size:13px; color:var(--muted)">No saved memories yet.</div>
</div>

<div class="toast" id="toast"></div>

<script>
/* ==================== Utilities & State ==================== */
const $ = sel => document.querySelector(sel);
const el = (tag, cls) => { const n=document.createElement(tag); if(cls) n.className=cls; return n; };

const state = {
  user: { id: '', name:'guest', email:'', phone:'', lang:'en' },
  conversations: [],           // [{id,title,msgs:[{role:'user'|'ai', text, attachments:[] }]}]
  convId: null,
  library: []                  // [{name,url,type,thumb}]
};
function loadState(){
  const raw = localStorage.getItem('lucidian_state_v3');
  if(raw){ try{ const s=JSON.parse(raw); Object.assign(state,s);}catch{} }
  if(!state.user.id){ state.user.id = 'u_' + Math.random().toString(36).slice(2,9); }
}
function saveState(){ localStorage.setItem('lucidian_state_v3', JSON.stringify(state)); }
function toast(t){ const n=$("#toast"); n.textContent=t; n.style.display='block'; setTimeout(()=>n.style.display='none', 1600); }

/* ==================== Stars (instant) ==================== */
const starsCanvas = $("#stars");
const ctx = starsCanvas.getContext("2d");
let W=0,H=0,stars=[];
function resizeStars(){
  W = starsCanvas.width = starsCanvas.offsetWidth = starsCanvas.parentElement.clientWidth;
  H = starsCanvas.height = starsCanvas.offsetHeight = starsCanvas.parentElement.clientHeight;
  stars = Array.from({length: 230}, ()=>({
    x: Math.random()*W, y: Math.random()*H, r: Math.random()*1.3+0.3, v: Math.random()*0.25+0.05
  }));
}
function tick(){
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle="#dfe7ff";
  for(const s of stars){
    ctx.globalAlpha=0.6+Math.sin((performance.now()/1000)*s.v + s.x)*0.35;
    ctx.beginPath(); ctx.arc(s.x, s.y, s.r, 0, Math.PI*2); ctx.fill();
    s.x += s.v*0.18; if(s.x>W+4) s.x = -4;
  }
  requestAnimationFrame(tick);
}
resizeStars(); requestAnimationFrame(tick);
addEventListener('resize', ()=>{resizeStars()});

/* ==================== Sidebar & Conversations ==================== */
function renderSidebar(){
  $("#accountName").textContent = state.user.name || 'guest';
  $("#profileMiniName").textContent = state.user.name || 'guest';

  const list=$("#convList"); list.innerHTML='';
  state.conversations.forEach(c=>{
    const row=el('div','conv-item');
    const title=el('div'); title.textContent = c.title || 'New Conversation';
    const sel=el('button','btn-ghost'); sel.textContent='Select'; sel.onclick=()=>openConv(c.id);
    const del=el('button','danger'); del.textContent='Del'; del.onclick=()=>{ state.conversations=state.conversations.filter(x=>x.id!==c.id); if(state.convId===c.id) {state.convId=null; $("#stream").innerHTML='';} saveState(); renderSidebar(); };
    row.append(title, sel, del);
    list.append(row);
  });
}
function ensureConversation(){
  if(!state.convId){
    const id = 'c_'+Math.random().toString(36).slice(2,9);
    state.conversations.unshift({id, title:'New Conversation', msgs:[]});
    state.convId=id; saveState(); renderSidebar();
  }
}
function currentConv(){ return state.conversations.find(c=>c.id===state.convId); }
function openConv(id){ state.convId=id; saveState(); renderStream(); }

/* ==================== Stream & Bubbles ==================== */
function bubble(msg){
  const m=el('div','msg ' + (msg.role==='user'?'right':'left'));
  if(msg.attachments?.length){
    const img=el('img','thumb'); img.src=msg.attachments[0].thumb || msg.attachments[0].url; m.append(img);
  }
  const text=el('div'); text.textContent=msg.text || ''; m.append(text);

  const tools=el('div','actions');
  const copy=el('button'); copy.textContent='Copy'; copy.onclick=()=>{ navigator.clipboard.writeText(msg.text||''); toast('Copied'); };
  const read=el('button'); read.textContent='Read'; read.onclick=()=>speak(msg.text||'');
  tools.append(copy, read);
  if(msg.role==='user'){
    const edit=el('button'); edit.textContent='Edit';
    edit.onclick=()=>{
      const val=prompt('Edit your message:', msg.text||''); if(val!=null){ msg.text=val; saveState(); renderStream(); }
    };
    tools.insertBefore(edit, read);
  }
  m.append(tools);
  return m;
}
function renderStream(){
  const area=$("#stream"); area.innerHTML='';
  const conv=currentConv(); if(!conv) return;
  conv.msgs.forEach(m=> area.append(bubble(m)));
  area.scrollTop = area.scrollHeight;
}

/* ==================== Composer ==================== */
$("#attachBtn").onclick=()=>$("#fileInput").click();
$("#fileInput").addEventListener('change', async (e)=>{
  const files=[...e.target.files]; if(!files.length) return;
  ensureConversation();
  const conv=currentConv();
  for(const f of files){
    const url = URL.createObjectURL(f);
    conv.msgs.push({role:'user', text:`(attachments queued) ${f.name}`, attachments:[{url, thumb:url, type:f.type}]});
    // also drop in library
    state.library.unshift({name:f.name, url, type:f.type, thumb:url});
  }
  saveState(); renderStream(); buildLibrary();
});
$("#sendBtn").onclick=send;
$("#msgInput").addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); send(); }});

function send(){
  const t=$("#msgInput").value.trim(); if(!t) return;
  ensureConversation();
  const conv=currentConv();
  conv.msgs.push({role:'user', text:t});
  conv.msgs.push({role:'ai', text:`Echoing intention: ${t}`});  // placeholder; will be Lumina later
  $("#msgInput").value='';
  saveState(); renderStream();
}

/* ==================== Library Modal ==================== */
function buildLibrary(){
  const grid=$("#libraryGrid"); grid.innerHTML='';
  if(!state.library.length){ grid.innerHTML='<div style="color:var(--muted)">No shared files yet.</div>'; return; }
  state.library.forEach(item=>{
    const card=el('div','lib-card');
    const img=el('img'); img.src=item.thumb||item.url; card.append(img);
    const name=el('div'); name.style.fontWeight='700'; name.textContent=item.name; card.append(name);
    const actions=el('div','lib-actions');
    const open=el('button','btn-ghost'); open.textContent='Open'; open.onclick=()=>window.open(item.url, '_blank');
    const dl=el('button','btn'); dl.textContent='Download'; dl.onclick=()=>{
      const a=document.createElement('a'); a.href=item.url; a.download=item.name||'download'; document.body.appendChild(a); a.click(); a.remove();
    };
    actions.append(open, dl); card.append(actions);
    grid.append(card);
  });
}
$("#openLibBtn").onclick=()=>{ buildLibrary(); $("#libraryOverlay").style.display=$("#libraryPanel").style.display='block'; };
$("#closeLibBtn").onclick=()=>{ $("#libraryOverlay").style.display=$("#libraryPanel").style.display='none'; };
$("#libraryOverlay").onclick=()=>$("#closeLibBtn").click();

/* ==================== Profile Overlay ==================== */
function openProfile(){
  $("#profName").value=state.user.name||'';
  $("#profEmail").value=state.user.email||'';
  $("#profPhone").value=state.user.phone||'';
  $("#profLang").value=state.user.lang||'en';
  $("#profileOverlay").style.display=$("#profilePanel").style.display='block';
}
function closeProfile(){ $("#profileOverlay").style.display=$("#profilePanel").style.display='none'; }
$("#accountBtn").onclick=openProfile;
$("#closeProfileBtn").onclick=closeProfile;
$("#profileOverlay").onclick=closeProfile;
$("#saveProfileBtn").onclick=()=>{
  state.user.name=$("#profName").value.trim()||'guest';
  state.user.email=$("#profEmail").value.trim();
  state.user.phone=$("#profPhone").value.trim();
  state.user.lang=$("#profLang").value.trim()||'en';
  saveState(); renderSidebar(); toast('Profile saved'); closeProfile();
};
$("#signOutBtn").onclick=()=>{
  localStorage.removeItem('lucidian_state_v3');
  location.reload();
};

/* ==================== Mobile sidebar toggle ==================== */
$("#menuBtn").onclick=()=> $("#sidebar").classList.toggle('open');

/* ==================== Search (local) ==================== */
$("#searchBtn").onclick=()=>{
  const q=$("#searchInput").value.trim().toLowerCase();
  if(!q){ renderSidebar(); return; }
  const list=$("#convList"); list.innerHTML='';
  state.conversations.filter(c=> (c.title||'').toLowerCase().includes(q) || c.msgs.some(m=> (m.text||'').toLowerCase().includes(q)))
    .forEach(c=>{
      const row=el('div','conv-item');
      row.append(Object.assign(el('div'),{textContent:c.title||'New Conversation'}));
      const sel=el('button','btn-ghost'); sel.textContent='Select'; sel.onclick=()=>openConv(c.id);
      row.append(sel, Object.assign(el('button','danger'),{textContent:'Del',onclick:()=>{ state.conversations=state.conversations.filter(x=>x.id!==c.id); saveState(); renderSidebar(); }}));
      list.append(row);
    });
};

/* ==================== TTS ==================== */
function speak(text){
  try{
    const u=new SpeechSynthesisUtterance(text); u.lang=state.user.lang||'en'; speechSynthesis.speak(u);
  }catch{ toast('Speech not supported in this browser'); }
}

/* ==================== Boot ==================== */
loadState();
renderSidebar();
ensureConversation();
renderStream();
buildLibrary();
</script>
</body>
</html>
