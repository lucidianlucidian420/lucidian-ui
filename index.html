<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Lucidian</title>
<style>
  :root{
    --gold:#f2cf66;
    --gold-soft:rgba(242,207,102,.28);
    --ink:#d9dde7;
    --header-h:92px;                 /* thicker bar so symbol sits inside */
    --sidebar-w:320px;
    --symbol-size:82px;              /* change 70‚Äì92 if you want */
    --bubble-me:rgba(255,255,255,.14);
    --bubble-ai:rgba(242,207,102,.12);
    --outline:rgba(255,255,255,.12);
    --shadow:0 12px 38px rgba(0,0,0,.6);
  }

  *{box-sizing:border-box}
  html,body{height:100%;margin:0;color:var(--ink);
    font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
  body{
    overflow:hidden;
    background: radial-gradient(1400px 900px at 50% 42%, #0c1220 0%, #08101a 34%, #060a10 62%, #05080c 100%);
  }

  .app{height:100%;display:grid;grid-template-rows:var(--header-h) 1fr auto}

  /* header */
  .header{position:sticky;top:0;z-index:20;display:grid;grid-template-columns:auto 1fr auto;align-items:center;
    padding:0 16px;border-bottom:1px solid rgba(255,255,255,.08);
    background:linear-gradient(180deg,rgba(12,14,18,.98),rgba(12,14,18,.9));}
  .brand{display:flex;justify-content:center;align-items:center;letter-spacing:.48rem;color:var(--gold);font-weight:800;font-size:34px}
  .symbol{width:var(--symbol-size);height:var(--symbol-size);display:grid;place-items:center;margin-left:10px;
    border-radius:50%;background:radial-gradient(circle at 50% 50%,rgba(242,207,102,.85),rgba(242,207,102,.25) 55%,transparent 58%);
    box-shadow:0 0 18px rgba(242,207,102,.5),inset 0 0 16px rgba(242,207,102,.22);}
  .symbol svg{width:86%;height:86%;display:block}

  .hamburger{display:none;padding:8px 10px;border-radius:10px;background:rgba(255,255,255,.06);
    border:1px solid var(--outline);color:var(--ink);cursor:pointer}

  /* stars */
  #stars{position:absolute;inset:0;pointer-events:none;z-index:0}

  /* main row */
  .main{position:relative;z-index:1;height:100%;display:grid;grid-template-columns:var(--sidebar-w) 1fr}

  /* sidebar */
  .sidebar{background:linear-gradient(180deg,rgba(15,18,23,.9),rgba(15,18,23,.72));
    border-right:1px solid rgba(255,255,255,.08);padding:12px;overflow:hidden}
  .sidebar-scroll{height:100%;overflow:auto;padding-right:4px}
  .row{display:flex;gap:8px;align-items:center;margin:10px 0}
  .btn{background:linear-gradient(180deg,rgba(242,207,102,.95),rgba(242,207,102,.86));border:0;color:#2b2300;
    font-weight:800;padding:10px 14px;border-radius:12px;cursor:pointer}
  .btn.secondary{background:rgba(255,255,255,.06);color:var(--ink);border:1px solid var(--outline);font-weight:600}
  .pill{padding:6px 10px;border-radius:999px;border:1px solid var(--outline);background:rgba(255,255,255,.06);cursor:pointer;user-select:none}
  .pill.danger{background:rgba(240,70,70,.18);border-color:rgba(240,70,70,.34);color:#ffdada}
  .input{flex:1;background:rgba(0,0,0,.28);border:1px solid var(--outline);color:var(--ink);padding:10px 12px;border-radius:12px}
  .conv{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:8px;border-radius:10px;
    background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);margin:8px 0}
  .conv .title{flex:1;overflow:hidden;white-space:nowrap;text-overflow:ellipsis}
  .mini{display:flex;gap:6px}

  /* chat */
  .chat-wrap{position:relative;overflow:auto;height:100%;padding:18px 18px 112px;overscroll-behavior:contain}
  .chat{max-width:1100px;margin:0 auto}
  .row-bubble{display:flex}
  .row-bubble.me{justify-content:flex-end}
  .row-bubble.ai{justify-content:flex-start}
  .bubble{
    display:inline-block;max-width:62%;margin:10px 12px;padding:10px 12px;border-radius:12px;
    white-space:pre-wrap;word-break:break-word;line-height:1.35;position:relative;
    backdrop-filter: blur(2px); border:1px solid var(--outline);}
  .bubble.me{background:var(--bubble-me)}
  .bubble.ai{background:var(--bubble-ai);border-color:var(--gold-soft)}
  .actions{position:absolute;right:-4px;top:-30px;display:flex;gap:6px;opacity:0;pointer-events:none;transition:.12s}
  .bubble:hover .actions{opacity:1;pointer-events:auto}
  .action{font-size:12px;padding:5px 8px;border-radius:999px;border:1px solid var(--outline);background:rgba(0,0,0,.55);cursor:pointer}
  .thumb{display:block;max-width:260px;max-height:200px;border-radius:10px;border:1px solid var(--outline)}
  .file-meta{font-size:12px;opacity:.85;margin-top:6px}

  /* composer */
  .composer{position:sticky;bottom:0;z-index:10;border-top:1px solid rgba(255,255,255,.08);
    background:linear-gradient(180deg,rgba(12,14,18,0),rgba(12,14,18,.95));padding:10px 14px}
  .composer-row{max-width:1100px;margin:0 auto;display:flex;gap:8px}
  .composer .btn,.composer .input{height:44px}

  /* library modal */
  #library-modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:1500}
  #library-scrim{position:absolute;inset:0;background:rgba(0,0,0,.5);backdrop-filter:blur(2px)}
  #library-card{position:relative;width:min(900px,92vw);max-height:min(72vh,800px);overflow:auto;padding:16px;border-radius:16px;
    background:rgba(18,19,23,.97);border:1px solid var(--outline);box-shadow:var(--shadow)}
  .lib-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(230px,1fr));gap:12px}
  .lib-item{border:1px solid var(--outline);background:rgba(255,255,255,.04);border-radius:12px;padding:10px}
  .lib-item .thumb{display:block;width:100%;height:150px;object-fit:cover;border-radius:8px;border:1px solid var(--outline)}
  .lib-actions{display:flex;gap:8px;margin-top:6px}
  .close-x{position:absolute;right:14px;top:12px;padding:6px 10px;border-radius:10px;background:rgba(255,255,255,.08);
    border:1px solid rgba(255,255,255,.18);cursor:pointer}

  /* settings overlay */
  #settings-overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);backdrop-filter:blur(2px);display:none;z-index:1600}
  #settings{position:fixed;top:92px;left:50%;transform:translateX(-50%);width:min(980px,96vw);max-height:min(80vh,900px);
    overflow:auto;background:rgba(20,20,22,.98);border:1px solid var(--gold-soft);border-radius:14px;padding:0;box-shadow:var(--shadow);display:none;z-index:1700}
  .settings-head{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.08)}
  .settings-body{display:grid;grid-template-columns:220px 1fr;min-height:360px}
  .settings-nav{border-right:1px solid rgba(255,255,255,.08);padding:10px}
  .settings-nav .item{padding:10px 12px;border-radius:10px;cursor:pointer}
  .settings-nav .item.active{background:rgba(255,255,255,.06);border:1px solid var(--outline)}
  .settings-pane{padding:16px}
  .field{display:flex;flex-direction:column;gap:6px;margin:10px 0}
  .field input,.field select{background:rgba(0,0,0,.28);border:1px solid var(--outline);color:var(--ink);padding:10px 12px;border-radius:10px}
  .links a{display:inline-block;margin:6px 10px 0 0;padding:8px 12px;border:1px solid var(--outline);border-radius:10px;text-decoration:none;color:var(--ink);background:rgba(255,255,255,.06)}

  /* responsive */
  @media (max-width:1024px){
    .hamburger{display:block}
    .main{grid-template-columns:1fr}
    .sidebar{position:fixed;z-index:25;top:var(--header-h);left:0;height:calc(100% - var(--header-h));width:min(86vw,360px);transform:translateX(-110%);transition:transform .18s}
    .sidebar.open{transform:translateX(0)}
    .chat-wrap{padding:16px 12px 104px}
    .bubble{max-width:86%}
    :root{--symbol-size:64px}
  }
</style>
</head>
<body>
<div class="app">
  <!-- header -->
  <div class="header">
    <button id="hamburger" class="hamburger">‚ò∞</button>
    <div class="brand">L U C I D I A N</div>
    <div class="symbol" aria-hidden="true">
      <!-- classic rosette (concentric interlaced circles) -->
      <svg viewBox="0 0 100 100">
        <g stroke="#f2cf66" stroke-width="1.2" fill="none" opacity=".96">
          <defs><circle id="r" cx="50" cy="18" r="32"/></defs>
          <!-- 24 rotations to create the rosette look -->
          <use href="#r"/><use href="#r" transform="rotate(15,50,50)"/>
          <use href="#r" transform="rotate(30,50,50)"/><use href="#r" transform="rotate(45,50,50)"/>
          <use href="#r" transform="rotate(60,50,50)"/><use href="#r" transform="rotate(75,50,50)"/>
          <use href="#r" transform="rotate(90,50,50)"/><use href="#r" transform="rotate(105,50,50)"/>
          <use href="#r" transform="rotate(120,50,50)"/><use href="#r" transform="rotate(135,50,50)"/>
          <use href="#r" transform="rotate(150,50,50)"/><use href="#r" transform="rotate(165,50,50)"/>
          <use href="#r" transform="rotate(180,50,50)"/><use href="#r" transform="rotate(195,50,50)"/>
          <use href="#r" transform="rotate(210,50,50)"/><use href="#r" transform="rotate(225,50,50)"/>
          <use href="#r" transform="rotate(240,50,50)"/><use href="#r" transform="rotate(255,50,50)"/>
          <use href="#r" transform="rotate(270,50,50)"/><use href="#r" transform="rotate(285,50,50)"/>
          <use href="#r" transform="rotate(300,50,50)"/><use href="#r" transform="rotate(315,50,50)"/>
          <use href="#r" transform="rotate(330,50,50)"/><use href="#r" transform="rotate(345,50,50)"/>
        </g>
      </svg>
    </div>
  </div>

  <!-- stars -->
  <canvas id="stars"></canvas>

  <!-- main -->
  <div class="main">
    <!-- sidebar -->
    <aside id="sidebar" class="sidebar">
      <div class="sidebar-scroll">
        <div class="row" style="margin-top:2px">
          <button id="newConv" class="btn" style="flex:1"></button>
          <button id="openLibrary" class="btn secondary"></button>
          <button id="openSettings" class="btn secondary"></button>
        </div>
        <div class="row">
          <input id="searchBox" class="input"/>
          <button id="searchGo" class="btn secondary"></button>
        </div>
        <div id="convList"></div>
      </div>
    </aside>

    <!-- chat -->
    <div id="chatWrap" class="chat-wrap">
      <div id="chat" class="chat"></div>
    </div>
  </div>

  <!-- composer -->
  <div class="composer">
    <div class="composer-row">
      <input id="fileInput" type="file" multiple style="display:none"
             accept="image/*,video/*,application/pdf,.txt,.md,.doc,.docx,.xlsx,.ppt,.pptx,application/*">
      <button id="attach" class="btn secondary"></button>
      <button id="mic" class="btn secondary">üéôÔ∏è</button>
      <input id="msg" class="input"/>
      <button id="send" class="btn"></button>
      <button id="voice" class="btn secondary"></button>
    </div>
  </div>
</div>

<!-- Library modal -->
<div id="library-modal">
  <div id="library-scrim"></div>
  <div id="library-card">
    <button id="libraryClose" class="close-x"></button>
    <h3 id="libraryTitle" style="margin:0 0 12px 0"></h3>
    <div id="libraryGrid" class="lib-grid"></div>
  </div>
</div>

<!-- Settings overlay -->
<div id="settings-overlay"></div>
<div id="settings" role="dialog" aria-modal="true" aria-labelledby="settings-title">
  <div class="settings-head">
    <strong id="settings-title">Settings</strong>
    <button id="settingsClose" class="close-x"></button>
  </div>
  <div class="settings-body">
    <nav class="settings-nav" id="settingsNav">
      <div class="item active" data-pane="account" id="navAccount"></div>
      <div class="item" data-pane="preferences" id="navPrefs"></div>
      <div class="item" data-pane="memories" id="navMems"></div>
      <div class="item" data-pane="connectors" id="navConn"></div>
      <div class="item" data-pane="danger" id="navDanger"></div>
      <div class="item" id="signOutBtn"></div>
    </nav>
    <section class="settings-pane" id="pane-account">
      <div class="field"><label id="lblName"></label><input id="s_name" type="text"></div>
      <div class="field"><label id="lblEmail"></label><input id="s_email" type="email"></div>
      <div class="field"><label id="lblPhone"></label><input id="s_phone" type="tel"></div>
      <div class="field"><label id="lblPass"></label><input id="s_pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
      <button id="saveAccount" class="btn"></button>
    </section>
    <section class="settings-pane" id="pane-preferences" hidden>
      <div class="field"><label id="lblUILang"></label>
        <select id="s_lang">
          <option>English</option><option>Espa√±ol</option><option>Fran√ßais</option><option>Deutsch</option>
          <option>Portugu√™s</option><option>Italiano</option><option>‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option>
          <option>‰∏≠Êñá</option><option>Êó•Êú¨Ë™û</option><option>ÌïúÍµ≠Ïñ¥</option>
        </select>
      </div>
      <div class="field"><label id="lblSpoken"></label>
        <select id="s_spoken">
          <option>Auto</option><option>English</option><option>Espa√±ol</option><option>Fran√ßais</option>
          <option>Deutsch</option><option>Portugu√™s</option><option>Italiano</option>
          <option>‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option><option>‰∏≠Êñá</option><option>Êó•Êú¨Ë™û</option><option>ÌïúÍµ≠Ïñ¥</option>
        </select>
      </div>
      <div class="field"><label id="lblVoice"></label>
        <select id="s_voice">
          <option>Orion</option><option>Lyra</option><option>Atlas</option><option>Selene</option><option>Quill</option>
        </select>
      </div>
      <button id="savePrefs" class="btn"></button>
    </section>
    <section class="settings-pane" id="pane-memories" hidden>
      <p id="memListTitle" style="opacity:.85"></p>
      <ul id="memList"></ul>
    </section>
    <section class="settings-pane" id="pane-connectors" hidden>
      <p id="connNote" style="opacity:.85"></p>
      <div class="links" id="connLinks">
        <a href="https://mail.google.com" target="_blank" rel="noopener">Gmail</a>
        <a href="https://drive.google.com" target="_blank" rel="noopener">Google Drive</a>
        <a href="https://calendar.google.com" target="_blank" rel="noopener">Google Calendar</a>
        <a href="https://docs.google.com" target="_blank" rel="noopener">Google Docs</a>
        <a href="https://nextcloud.com" target="_blank" rel="noopener">Nextcloud (open-source)</a>
        <a href="https://www.onlyoffice.com" target="_blank" rel="noopener">ONLYOFFICE (open-source)</a>
      </div>
    </section>
    <section class="settings-pane" id="pane-danger" hidden>
      <div class="danger-zone">
        <strong id="dangerTitle"></strong>
        <p id="dangerText" style="opacity:.85;margin:.4rem 0 1rem"></p>
        <button id="deleteAccount" class="btn pill danger" style="border-radius:10px"></button>
      </div>
    </section>
  </div>
</div>

<script>
/* ========= tiny state ========= */
const state = {
  currentConvId:null,
  conversations: JSON.parse(localStorage.getItem('convs')||'[]'),
  library: JSON.parse(localStorage.getItem('library')||'[]'),
  profile: JSON.parse(localStorage.getItem('profile')||'{"name":"kyle","email":"kylejenkins2468@gmail.com"}'),
  settings: JSON.parse(localStorage.getItem('settings')||'{"lang":"English","spoken":"Auto","voice":"Orion"}'),
  memories: JSON.parse(localStorage.getItem('memories')||'[]')
};
const $=s=>document.querySelector(s), $$=s=>document.querySelectorAll(s);
const el={
  chat:$('#chat'), chatWrap:$('#chatWrap'), convList:$('#convList'), msg:$('#msg'),
  fileInput:$('#fileInput'), mic:$('#mic'), voice:$('#voice'),
  libModal:$('#library-modal'), libScrim:$('#library-scrim'), libClose:$('#libraryClose'), libGrid:$('#libraryGrid'),
  sOverlay:$('#settings-overlay'), settings:$('#settings'), settingsNav:$('#settingsNav'),
  panes:{account:$('#pane-account'), preferences:$('#pane-preferences'), memories:$('#pane-memories'), connectors:$('#pane-connectors'), danger:$('#pane-danger')}
};

/* ========= i18n ========= */
const tr={
  English:{New:"New",OpenLibrary:"Open",Settings:"Settings",SearchPh:"Search conversations...",Go:"Go",
    Attach:"Attach",Send:"Send",Voice:"Voice",Close:"Close",SharedLibrary:"Shared Library",
    Select:"Select",Del:"Del",DeleteConfirm:"Delete this conversation? This cannot be undone.",
    Echo:"Echoing intention:", Copy:"Copy", Edit:"Edit", Read:"Read", Reply:"Reply",
    Account:"Account",Preferences:"Preferences",Memories:"Memories",Connectors:"Connectors",Danger:"Danger Zone",
    SignOut:"Sign out", Name:"Name",Email:"Email",Phone:"Phone",Password:"Password",Save:"Save",
    UILang:"UI language",Spoken:"Spoken language",VoiceLbl:"Voice",MemList:"Saved memories (demo):",
    ConnNote:"Open links to connect your accounts or services.",
    DangerTitle:"Delete account", DangerText:"This clears local data on this device (demo). You will be asked to confirm.",
    DeleteAccount:"Delete account"},
  Espa√±ol:{New:"Nuevo",OpenLibrary:"Abrir",Settings:"Ajustes",SearchPh:"Buscar conversaciones...",Go:"Ir",
    Attach:"Adjuntar",Send:"Enviar",Voice:"Voz",Close:"Cerrar",SharedLibrary:"Biblioteca compartida",
    Select:"Elegir",Del:"Borrar",DeleteConfirm:"¬øBorrar esta conversaci√≥n? No se puede deshacer.",
    Echo:"Intenci√≥n reflejada:", Copy:"Copiar", Edit:"Editar", Read:"Leer", Reply:"Responder",
    Account:"Cuenta",Preferences:"Preferencias",Memories:"Memorias",Connectors:"Conectores",Danger:"Zona de riesgo",
    SignOut:"Cerrar sesi√≥n", Name:"Nombre",Email:"Correo",Phone:"Tel√©fono",Password:"Contrase√±a",Save:"Guardar",
    UILang:"Idioma de la interfaz",Spoken:"Idioma hablado",VoiceLbl:"Voz",MemList:"Memorias guardadas (demo):",
    ConnNote:"Abre enlaces para conectar tus cuentas o servicios.",
    DangerTitle:"Eliminar cuenta", DangerText:"Esto borra los datos locales en este dispositivo (demo). Se te pedir√° confirmaci√≥n.",
    DeleteAccount:"Eliminar cuenta"},
  Fran√ßais:{New:"Nouveau",OpenLibrary:"Ouvrir",Settings:"R√©glages",SearchPh:"Rechercher des conversations‚Ä¶",Go:"Aller",
    Attach:"Joindre",Send:"Envoyer",Voice:"Voix",Close:"Fermer",SharedLibrary:"Biblioth√®que partag√©e",
    Select:"S√©lect.",Del:"Suppr.",DeleteConfirm:"Supprimer cette conversation ? Action irr√©versible.",
    Echo:"Intention refl√©t√©e :", Copy:"Copier", Edit:"Modifier", Read:"Lire", Reply:"R√©pondre",
    Account:"Compte",Preferences:"Pr√©f√©rences",Memories:"M√©moires",Connectors:"Connecteurs",Danger:"Zone dangereuse",
    SignOut:"Se d√©connecter", Name:"Nom",Email:"Email",Phone:"T√©l√©phone",Password:"Mot de passe",Save:"Enregistrer",
    UILang:"Langue de l‚Äôinterface",Spoken:"Langue parl√©e",VoiceLbl:"Voix",MemList:"M√©moires enregistr√©es (d√©mo) :",
    ConnNote:"Ouvrez les liens pour connecter vos services.",
    DangerTitle:"Supprimer le compte", DangerText:"Efface les donn√©es locales sur cet appareil (d√©mo). Confirmation requise.",
    DeleteAccount:"Supprimer le compte"},
  Deutsch:{New:"Neu",OpenLibrary:"√ñffnen",Settings:"Einstellungen",SearchPh:"Unterhaltungen suchen‚Ä¶",Go:"Los",
    Attach:"Anh√§ngen",Send:"Senden",Voice:"Sprache",Close:"Schlie√üen",SharedLibrary:"Geteilte Bibliothek",
    Select:"W√§hlen",Del:"L√∂schen",DeleteConfirm:"Diese Unterhaltung l√∂schen? Dies kann nicht r√ºckg√§ngig gemacht werden.",
    Echo:"Absicht wiedergegeben:", Copy:"Kopieren", Edit:"Bearbeiten", Read:"Vorlesen", Reply:"Antworten",
    Account:"Konto",Preferences:"Voreinstellungen",Memories:"Erinnerungen",Connectors:"Verbinder",Danger:"Gefahrenzone",
    SignOut:"Abmelden", Name:"Name",Email:"E-Mail",Phone:"Telefon",Password:"Passwort",Save:"Speichern",
    UILang:"UI-Sprache",Spoken:"Gesprochene Sprache",VoiceLbl:"Stimme",MemList:"Gespeicherte Erinnerungen (Demo):",
    ConnNote:"√ñffnen Sie Links, um Ihre Dienste zu verbinden.",
    DangerTitle:"Konto l√∂schen", DangerText:"L√∂scht lokale Daten auf diesem Ger√§t (Demo). Best√§tigung erforderlich.",
    DeleteAccount:"Konto l√∂schen"},
  Portugu√™s:{New:"Novo",OpenLibrary:"Abrir",Settings:"Configura√ß√µes",SearchPh:"Buscar conversas‚Ä¶",Go:"Ir",
    Attach:"Anexar",Send:"Enviar",Voice:"Voz",Close:"Fechar",SharedLibrary:"Biblioteca compartilhada",
    Select:"Selecionar",Del:"Excluir",DeleteConfirm:"Excluir esta conversa? N√£o pode ser desfeito.",
    Echo:"Inten√ß√£o refletida:", Copy:"Copiar", Edit:"Editar", Read:"Ler", Reply:"Responder",
    Account:"Conta",Preferences:"Prefer√™ncias",Memories:"Mem√≥rias",Connectors:"Conectores",Danger:"Zona de risco",
    SignOut:"Sair", Name:"Nome",Email:"Email",Phone:"Telefone",Password:"Senha",Save:"Salvar",
    UILang:"Idioma da interface",Spoken:"Idioma falado",VoiceLbl:"Voz",MemList:"Mem√≥rias salvas (demo):",
    ConnNote:"Abra links para conectar servi√ßos.",
    DangerTitle:"Excluir conta", DangerText:"Apaga os dados locais neste dispositivo (demo). Confirma√ß√£o ser√° solicitada.",
    DeleteAccount:"Excluir conta"},
  Italiano:{New:"Nuova",OpenLibrary:"Apri",Settings:"Impostazioni",SearchPh:"Cerca conversazioni‚Ä¶",Go:"Vai",
    Attach:"Allega",Send:"Invia",Voice:"Voce",Close:"Chiudi",SharedLibrary:"Libreria condivisa",
    Select:"Selez.",Del:"Elim.",DeleteConfirm:"Eliminare la conversazione? Operazione irreversibile.",
    Echo:"Intenzione rispecchiata:", Copy:"Copia", Edit:"Modifica", Read:"Leggi", Reply:"Rispondi",
    Account:"Account",Preferences:"Preferenze",Memories:"Memorie",Connectors:"Connettori",Danger:"Zona pericolosa",
    SignOut:"Esci", Name:"Nome",Email:"Email",Phone:"Telefono",Password:"Password",Save:"Salva",
    UILang:"Lingua dell‚Äôinterfaccia",Spoken:"Lingua parlata",VoiceLbl:"Voce",MemList:"Memorie salvate (demo):",
    ConnNote:"Apri i link per collegare i servizi.",
    DangerTitle:"Elimina account", DangerText:"Cancella i dati locali su questo dispositivo (demo). Richiesta conferma.",
    DeleteAccount:"Elimina account"},
  "Êó•Êú¨Ë™û":{New:"Êñ∞Ë¶è",OpenLibrary:"„É©„Ç§„Éñ„É©„É™",Settings:"Ë®≠ÂÆö",SearchPh:"‰ºöË©±„ÇíÊ§úÁ¥¢‚Ä¶",Go:"Ê§úÁ¥¢",
    Attach:"Ê∑ª‰ªò",Send:"ÈÄÅ‰ø°",Voice:"Èü≥Â£∞",Close:"Èñâ„Åò„Çã",SharedLibrary:"ÂÖ±Êúâ„É©„Ç§„Éñ„É©„É™",
    Select:"ÈÅ∏Êäû",Del:"ÂâäÈô§",DeleteConfirm:"„Åì„ÅÆ‰ºöË©±„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºüÂÖÉ„Å´Êàª„Åõ„Åæ„Åõ„Çì„ÄÇ",
    Echo:"ÊÑèÂõ≥„ÇíÂèçÊò†Ôºö", Copy:"„Ç≥„Éî„Éº", Edit:"Á∑®ÈõÜ", Read:"Ë™≠„Åø‰∏ä„Åí", Reply:"Ëøî‰ø°",
    Account:"„Ç¢„Ç´„Ç¶„É≥„Éà",Preferences:"Áí∞Â¢ÉË®≠ÂÆö",Memories:"„É°„É¢„É™„Éº",Connectors:"„Ç≥„Éç„ÇØ„Çø",Danger:"Âç±Èô∫„Çæ„Éº„É≥",
    SignOut:"„Çµ„Ç§„É≥„Ç¢„Ç¶„Éà", Name:"ÂêçÂâç",Email:"„É°„Éº„É´",Phone:"ÈõªË©±",Password:"„Éë„Çπ„ÉØ„Éº„Éâ",Save:"‰øùÂ≠ò",
    UILang:"UIË®ÄË™û",Spoken:"Ë©±„ÅóË®ÄËëâ",VoiceLbl:"„Éú„Ç§„Çπ",MemList:"‰øùÂ≠òÊ∏à„Åø„É°„É¢„É™„ÉºÔºà„Éá„É¢Ôºâ:",
    ConnNote:"„Çµ„Éº„Éì„Çπ„Å∏Êé•Á∂ö„Åô„Çã„É™„É≥„ÇØ„ÇíÈñã„Åç„Åæ„Åô„ÄÇ",
    DangerTitle:"„Ç¢„Ç´„Ç¶„É≥„ÉàÂâäÈô§", DangerText:"„Åì„ÅÆÁ´ØÊú´„ÅÆ„É≠„Éº„Ç´„É´„Éá„Éº„Çø„ÇíÊ∂àÂéª„Åó„Åæ„ÅôÔºà„Éá„É¢Ôºâ„ÄÇÁ¢∫Ë™ç„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ",
    DeleteAccount:"„Ç¢„Ç´„Ç¶„É≥„ÉàÂâäÈô§"},
  "ÌïúÍµ≠Ïñ¥":{New:"ÏÉà ÎåÄÌôî",OpenLibrary:"Ïó¥Í∏∞",Settings:"ÏÑ§Ï†ï",SearchPh:"ÎåÄÌôî Í≤ÄÏÉâ‚Ä¶",Go:"Ïù¥Îèô",
    Attach:"Ï≤®Î∂Ä",Send:"Î≥¥ÎÇ¥Í∏∞",Voice:"ÏùåÏÑ±",Close:"Îã´Í∏∞",SharedLibrary:"Í≥µÏú† ÎùºÏù¥Î∏åÎü¨Î¶¨",
    Select:"ÏÑ†ÌÉù",Del:"ÏÇ≠Ï†ú",DeleteConfirm:"Ïù¥ ÎåÄÌôîÎ•º ÏÇ≠Ï†úÌï†ÍπåÏöî? ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§.",
    Echo:"ÏùòÎèÑ Î∞òÏòÅ:", Copy:"Î≥µÏÇ¨", Edit:"Ìé∏Ïßë", Read:"ÏùΩÍ∏∞", Reply:"ÎãµÏû•",
    Account:"Í≥ÑÏ†ï",Preferences:"ÌôòÍ≤ΩÏÑ§Ï†ï",Memories:"Î©îÎ™®Î¶¨",Connectors:"Ïó∞Í≤∞",Danger:"ÏúÑÌóò ÏòÅÏó≠",
    SignOut:"Î°úÍ∑∏ÏïÑÏõÉ", Name:"Ïù¥Î¶Ñ",Email:"Ïù¥Î©îÏùº",Phone:"Ï†ÑÌôî",Password:"ÎπÑÎ∞ÄÎ≤àÌò∏",Save:"Ï†ÄÏû•",
    UILang:"UI Ïñ∏Ïñ¥",Spoken:"ÏùåÏÑ± Ïñ∏Ïñ¥",VoiceLbl:"Î≥¥Ïù¥Ïä§",MemList:"Ï†ÄÏû•Îêú Î©îÎ™®Î¶¨(Îç∞Î™®):",
    ConnNote:"ÏÑúÎπÑÏä§ Ïó∞Í≤∞ÏùÑ ÏúÑÌï¥ ÎßÅÌÅ¨Î•º Ïó¨ÏÑ∏Ïöî.",
    DangerTitle:"Í≥ÑÏ†ï ÏÇ≠Ï†ú", DangerText:"Ïù¥ Í∏∞Í∏∞Ïùò Î°úÏª¨ Îç∞Ïù¥ÌÑ∞Î•º ÏÇ≠Ï†úÌï©ÎãàÎã§(Îç∞Î™®). ÌôïÏù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.",
    DeleteAccount:"Í≥ÑÏ†ï ÏÇ≠Ï†ú"},
  "‰∏≠Êñá":{New:"Êñ∞‰ºöËØù",OpenLibrary:"ÊâìÂºÄ",Settings:"ËÆæÁΩÆ",SearchPh:"ÊêúÁ¥¢‰ºöËØù‚Ä¶",Go:"ÂâçÂæÄ",
    Attach:"ÈôÑ‰ª∂",Send:"ÂèëÈÄÅ",Voice:"ËØ≠Èü≥",Close:"ÂÖ≥Èó≠",SharedLibrary:"ÂÖ±‰∫´Â∫ì",
    Select:"ÈÄâÊã©",Del:"Âà†Èô§",DeleteConfirm:"Âà†Èô§Ê≠§‰ºöËØùÔºüËØ•Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ„ÄÇ",
    Echo:"ÊÑèÂõæÂõûÂ£∞Ôºö", Copy:"Â§çÂà∂", Edit:"ÁºñËæë", Read:"ÊúóËØª", Reply:"ÂõûÂ§ç",
    Account:"Ë¥¶Êà∑",Preferences:"ÂÅèÂ•Ω",Memories:"ËÆ∞ÂøÜ",Connectors:"ËøûÊé•Âô®",Danger:"Âç±Èô©Âå∫Âüü",
    SignOut:"ÈÄÄÂá∫ÁôªÂΩï", Name:"ÂßìÂêç",Email:"ÈÇÆÁÆ±",Phone:"ÁîµËØù",Password:"ÂØÜÁ†Å",Save:"‰øùÂ≠ò",
    UILang:"ÁïåÈù¢ËØ≠Ë®Ä",Spoken:"Âè£ËØ≠ËØ≠Ë®Ä",VoiceLbl:"Â£∞Èü≥",MemList:"Â∑≤‰øùÂ≠òËÆ∞ÂøÜÔºàÊºîÁ§∫ÔºâÔºö",
    ConnNote:"ÊâìÂºÄÈìæÊé•‰ª•ËøûÊé•ÊÇ®ÁöÑÊúçÂä°„ÄÇ",
    DangerTitle:"Âà†Èô§Ë¥¶Êà∑", DangerText:"Ê∏ÖÈô§Ê≠§ËÆæÂ§á‰∏äÁöÑÊú¨Âú∞Êï∞ÊçÆÔºàÊºîÁ§∫Ôºâ„ÄÇÈúÄË¶ÅÁ°ÆËÆ§„ÄÇ",
    DeleteAccount:"Âà†Èô§Ë¥¶Êà∑"},
  "‡§π‡§ø‡§®‡•ç‡§¶‡•Ä":{New:"‡§®‡§Ø‡§æ",OpenLibrary:"‡§ñ‡•ã‡§≤‡•á‡§Ç",Settings:"‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏",SearchPh:"‡§µ‡§æ‡§∞‡•ç‡§§‡§æ‡§≤‡§æ‡§™ ‡§ñ‡•ã‡§ú‡•á‡§Ç‚Ä¶",Go:"‡§ú‡§æ‡§è‡§Å",
    Attach:"‡§∏‡§Ç‡§≤‡§ó‡•ç‡§® ‡§ï‡§∞‡•á‡§Ç",Send:"‡§≠‡•á‡§ú‡•á‡§Ç",Voice:"‡§Ü‡§µ‡§æ‡§ú‡§º",Close:"‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç",SharedLibrary:"‡§∏‡§æ‡§ù‡§æ ‡§≤‡§æ‡§á‡§¨‡•ç‡§∞‡•á‡§∞‡•Ä",
    Select:"‡§ö‡•Å‡§®‡•á‡§Ç",Del:"‡§π‡§ü‡§æ‡§è‡§Å",DeleteConfirm:"‡§ï‡•ç‡§Ø‡§æ ‡§µ‡§æ‡§∞‡•ç‡§§‡§æ‡§≤‡§æ‡§™ ‡§π‡§ü‡§æ‡§è‡§Å? ‡§á‡§∏‡•á ‡§µ‡§æ‡§™‡§∏ ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ ‡§∏‡§ï‡§§‡§æ‡•§",
    Echo:"‡§â‡§¶‡•ç‡§¶‡•á‡§∂‡•ç‡§Ø ‡§™‡•ç‡§∞‡§§‡§ø‡§ß‡•ç‡§µ‡§®‡§ø:", Copy:"‡§ï‡•â‡§™‡•Ä", Edit:"‡§∏‡§Ç‡§™‡§æ‡§¶‡§ø‡§§", Read:"‡§™‡§¢‡§º‡•á‡§Ç", Reply:"‡§ú‡§µ‡§æ‡§¨",
    Account:"‡§ñ‡§æ‡§§‡§æ",Preferences:"‡§µ‡§∞‡•Ä‡§Ø‡§§‡§æ‡§è‡§Å",Memories:"‡§∏‡•ç‡§Æ‡•É‡§§‡§ø‡§Ø‡§æ‡§Å",Connectors:"‡§ï‡§®‡•á‡§ï‡•ç‡§ü‡§∞‡•ç‡§∏",Danger:"‡§ñ‡§§‡§∞‡•á ‡§ï‡§æ ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞",
    SignOut:"‡§∏‡§æ‡§á‡§® ‡§Ü‡§â‡§ü", Name:"‡§®‡§æ‡§Æ",Email:"‡§à‡§Æ‡•á‡§≤",Phone:"‡§´‡§º‡•ã‡§®",Password:"‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°",Save:"‡§∏‡§π‡•á‡§ú‡•á‡§Ç",
    UILang:"UI ‡§≠‡§æ‡§∑‡§æ",Spoken:"‡§¨‡•ã‡§≤‡•Ä ‡§ú‡§æ‡§®‡•á ‡§µ‡§æ‡§≤‡•Ä ‡§≠‡§æ‡§∑‡§æ",VoiceLbl:"‡§µ‡•â‡§Ø‡§∏",MemList:"‡§∏‡§π‡•á‡§ú‡•Ä ‡§ó‡§à ‡§∏‡•ç‡§Æ‡•É‡§§‡§ø‡§Ø‡§æ‡§Å (‡§°‡•á‡§Æ‡•ã):",
    ConnNote:"‡§∏‡•á‡§µ‡§æ‡§è‡§Å ‡§ú‡•ã‡§°‡§º‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§≤‡§ø‡§Ç‡§ï ‡§ñ‡•ã‡§≤‡•á‡§Ç‡•§",
    DangerTitle:"‡§ñ‡§æ‡§§‡§æ ‡§π‡§ü‡§æ‡§è‡§Å", DangerText:"‡§á‡§∏ ‡§°‡§ø‡§µ‡§æ‡§á‡§∏ ‡§ï‡•á ‡§∏‡•ç‡§•‡§æ‡§®‡•Ä‡§Ø ‡§°‡•á‡§ü‡§æ ‡§∏‡§æ‡§´‡§º ‡§π‡•ã‡§Ç‡§ó‡•á (‡§°‡•á‡§Æ‡•ã)‡•§ ‡§™‡•Å‡§∑‡•ç‡§ü‡§ø ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡•§",
    DeleteAccount:"‡§ñ‡§æ‡§§‡§æ ‡§π‡§ü‡§æ‡§è‡§Å"}
};
function t(k){ return tr[state.settings.lang||'English'][k]||tr.English[k]||k }
function applyI18n(){
  // buttons & labels
  $('#newConv').textContent=t('New');
  $('#openLibrary').textContent=t('OpenLibrary');
  $('#openSettings').textContent=t('Settings');
  $('#searchBox').placeholder=t('SearchPh');
  $('#searchGo').textContent=t('Go');
  $('#attach').textContent=t('Attach');
  $('#send').textContent=t('Send');
  $('#voice').textContent=t('Voice');
  $('#libraryTitle').textContent=t('SharedLibrary');
  $('#libraryClose').textContent=t('Close');

  // settings nav/labels
  $('#settings-title').textContent=t('Settings');
  $('#settingsClose').textContent=t('Close');
  $('#navAccount').textContent=t('Account');
  $('#navPrefs').textContent=t('Preferences');
  $('#navMems').textContent=t('Memories');
  $('#navConn').textContent=t('Connectors');
  $('#navDanger').textContent=t('Danger');
  $('#signOutBtn').textContent=t('SignOut');

  $('#lblName').textContent=t('Name');
  $('#lblEmail').textContent=t('Email');
  $('#lblPhone').textContent=t('Phone');
  $('#lblPass').textContent=t('Password');
  $('#saveAccount').textContent=t('Save');

  $('#lblUILang').textContent=t('UILang');
  $('#lblSpoken').textContent=t('Spoken');
  $('#lblVoice').textContent=t('VoiceLbl');
  $('#savePrefs').textContent=t('Save');

  $('#memListTitle').textContent=t('MemList');
  $('#connNote').textContent=t('ConnNote');
  $('#dangerTitle').textContent=t('DangerTitle');
  $('#dangerText').textContent=t('DangerText');
  $('#deleteAccount').textContent=t('DeleteAccount');
}

/* ========= stars (dense + darker space) ========= */
(function stars(){
  const c=$('#stars'), ctx=c.getContext('2d');
  function resize(){ c.width=innerWidth; c.height=innerHeight }
  resize();
  const num=Math.round((c.width*c.height)/6500); // more stars
  const stars=Array.from({length:num},()=>({x:Math.random()*c.width,y:Math.random()*c.height,z:Math.random()*0.9+0.2,tw:Math.random()*0.8+0.2}));
  function tick(){
    ctx.clearRect(0,0,c.width,c.height);
    for(const s of stars){
      const size=s.z*1.7;
      ctx.fillStyle=`rgba(255,255,255,${0.75*s.tw})`;
      ctx.fillRect(s.x,s.y,size,size);
      s.x+=0.03*s.z; if(s.x>c.width+2) s.x=-2;
      s.tw+= (Math.random()-.5)*0.02; s.tw=Math.min(1,Math.max(.2,s.tw));
    }
    requestAnimationFrame(tick);
  }
  addEventListener('resize',resize); tick();
})();

/* ========= helpers ========= */
const uuid=()=>crypto.randomUUID?crypto.randomUUID():
 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>((c==='x'?Math.random()*16:Math.random()*16&0x3|0x8)|0).toString(16));
const byId=id=>state.conversations.find(c=>c.id===id);
const saveConvs=()=>localStorage.setItem('convs',JSON.stringify(state.conversations));
const saveLib=()=>localStorage.setItem('library',JSON.stringify(state.library));
const saveProfile=()=>localStorage.setItem('profile',JSON.stringify(state.profile));
const saveSettings=()=>localStorage.setItem('settings',JSON.stringify(state.settings));
function ensureConv(){
  if(!state.currentConvId){
    const id=uuid(); state.conversations.unshift({id,title:"New Conversation",items:[]});
    state.currentConvId=id; saveConvs();
  }
}
function escapeHtml(s){return (s||'').replace(/[&<>"']/g,ch=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[ch]))}

/* ========= render ========= */
function renderSidebar(){
  $('#convList').innerHTML=state.conversations.map(c=>`
    <div class="conv" data-id="${c.id}">
      <div class="title">${escapeHtml(c.title||'New Conversation')}</div>
      <div class="mini">
        <div class="pill select">${t('Select')}</div>
        <div class="pill danger del">${t('Del')}</div>
      </div>
    </div>`).join('');
}
function bubbleActions(){
  return `<div class="actions">
    <div class="action act-copy">${t('Copy')}</div>
    <div class="action act-reply">${t('Reply')}</div>
    <div class="action act-read">${t('Read')}</div>
    <div class="action act-edit">${t('Edit')}</div>
  </div>`;
}
function renderChat(){
  const conv=byId(state.currentConvId);
  $('#chat').innerHTML=(conv?.items||[]).map(m=>{
    const side=m.role==='ai'?'ai':'me';
    const acts=bubbleActions();
    if(m.type==='file'){
      const isImg=(m.mime||'').startsWith('image/');
      const isVid=(m.mime||'').startsWith('video/');
      const thumb=isImg?`<img src="${m.url}" class="thumb" alt="${escapeHtml(m.name)}">`
                : isVid?`<video src="${m.url}" class="thumb" controls></video>`
                : `<div class="file-meta">üìÑ ${escapeHtml(m.name)}</div>`;
      return `<div class="row-bubble ${side}">
        <div class="bubble ${side}">
          ${acts}
          ${thumb}
          <div class="file-meta">
            <a href="${m.url}" target="_blank" rel="noopener">Open</a> ¬∑
            <a href="${m.url}" download>Download</a>
          </div>
        </div>
      </div>`;
    }
    return `<div class="row-bubble ${side}">
      <div class="bubble ${side}">
        ${acts}
        ${escapeHtml(m.text)}
      </div>
    </div>`;
  }).join('');
  // keep the newest visible
  const wrap=$('#chatWrap');
  wrap.scrollTop=wrap.scrollHeight;
}

/* ========= sending & echo ========= */
function send(text){
  ensureConv();
  const conv=byId(state.currentConvId);
  conv.items.push({role:'me',text}); saveConvs(); renderChat();
  setTimeout(()=>{
    conv.items.push({role:'ai',text:`${t('Echo')} ${text}`});
    saveConvs(); renderChat();
    if(isSpeaking) speak(conv.items.at(-1).text);
  },220);
}

/* ========= events ========= */
/* search/new/select/delete (with confirm) */
$('#newConv').addEventListener('click',()=>{state.currentConvId=null;ensureConv();renderSidebar();renderChat()});
$('#searchGo').addEventListener('click',()=>{
  const q=($('#searchBox').value||'').toLowerCase();
  const found=state.conversations.find(c=>(c.title||'new conversation').toLowerCase().includes(q));
  if(found){state.currentConvId=found.id;renderSidebar();renderChat()}
});
$('#convList').addEventListener('click',(e)=>{
  const row=e.target.closest('.conv'); if(!row)return;
  const id=row.dataset.id;
  if(e.target.classList.contains('del')){
    if(confirm(t('DeleteConfirm'))){
      const i=state.conversations.findIndex(c=>c.id===id);
      if(i>-1){state.conversations.splice(i,1); if(state.currentConvId===id) state.currentConvId=null; ensureConv(); saveConvs(); renderSidebar(); renderChat()}
    }
  }else if(e.target.classList.contains('select')||e.target.classList.contains('title')){
    state.currentConvId=id; renderSidebar(); renderChat();
  }
});

/* composer */
$('#send').addEventListener('click',()=>{const v=$('#msg').value.trim(); if(v){$('#msg').value=''; send(v)}})
$('#msg').setAttribute('placeholder', tr[state.settings.lang||'English'].SearchPh.replace('Buscar conversaciones‚Ä¶','Type a message...').replace('‰ºöË©±„ÇíÊ§úÁ¥¢‚Ä¶','Type a message...'));
$('#msg').addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();$('#send').click()}})

/* bubble actions (Copy/Edit/Read/Reply) */
$('#chat').addEventListener('click',async(e)=>{
  const bubble=e.target.closest('.bubble'); if(!bubble) return;
  const idx=[...document.querySelectorAll('.bubble')].indexOf(bubble);
  const conv=byId(state.currentConvId); if(!conv) return;
  const msg=conv.items[idx];

  if(e.target.classList.contains('act-copy')){
    const text=msg.type==='file'?msg.name:msg.text; try{await navigator.clipboard.writeText(text||'')}catch{}
  }
  if(e.target.classList.contains('act-edit') && msg && msg.type!=='file'){
    const next=prompt(t('Edit'), msg.text||''); if(next!=null){ msg.text=next; saveConvs(); renderChat(); }
  }
  if(e.target.classList.contains('act-read')){
    const ttxt=msg.type==='file'?msg.name:msg.text; speak(ttxt);
  }
  if(e.target.classList.contains('act-reply')){
    const ttxt=msg.type==='file'?msg.name:msg.text; const box=$('#msg');
    box.value = (box.value ? box.value+'\n' : '') + '> ' + ttxt + '\n'; box.focus();
  }
});

/* attachments with previews + AI acknowledgement */
$('#attach').addEventListener('click',()=>$('#fileInput').click());
$('#fileInput').addEventListener('change',(e)=>{
  const files=[...e.target.files]; if(!files.length) return; ensureConv();
  const conv=byId(state.currentConvId); const names=[];
  for(const f of files){
    const url=URL.createObjectURL(f);
    conv.items.push({role:'me',type:'file',url,name:f.name,mime:f.type}); names.push(f.name);
    state.library.unshift({name:f.name,url,mime:f.type,ts:Date.now()});
  }
  saveConvs(); saveLib(); renderChat(); e.target.value="";
  // AI reply acknowledging attachments
  setTimeout(()=>{ conv.items.push({role:'ai',text:`${t('Echo')} ${names.join(', ')}`}); saveConvs(); renderChat(); if(isSpeaking) speak(conv.items.at(-1).text); },220);
});

/* library modal */
$('#openLibrary').addEventListener('click',()=>{ renderLibrary(); $('#library-modal').style.display='flex' });
$('#libraryClose').addEventListener('click',()=>$('#library-modal').style.display='none');
$('#library-scrim').addEventListener('click',()=>$('#library-modal').style.display='none');
function renderLibrary(){
  $('#libraryGrid').innerHTML = state.library.map(f=>{
    const isImg=(f.mime||'').startsWith('image/'); const isVid=(f.mime||'').startsWith('video/');
    const thumb=isImg?`<img src="${f.url}" class="thumb" alt="${escapeHtml(f.name)}">`
              : isVid?`<video src="${f.url}" class="thumb" muted></video>`
              : `<div class="thumb" style="display:grid;place-items:center;font-weight:700;color:var(--gold);background:rgba(0,0,0,.35)">FILE</div>`;
    const when=new Date(f.ts||Date.now()).toLocaleString();
    return `<div class="lib-item">
      ${thumb}
      <div style="margin-top:6px;font-weight:700">${escapeHtml(f.name)}</div>
      <div style="font-size:12px;opacity:.8">${when}</div>
      <div class="lib-actions">
        <a class="btn secondary" href="${f.url}" target="_blank" rel="noopener">${t('OpenLibrary')}</a>
        <a class="btn secondary" href="${f.url}" download>Download</a>
      </div>
    </div>`;
  }).join('') || `<div style="opacity:.75">Nothing shared yet.</div>`;
}

/* settings overlay */
$('#openSettings').addEventListener('click',openSettings);
$('#settingsClose').addEventListener('click',closeSettings);
$('#settings-overlay').addEventListener('click',closeSettings);
$('#settingsNav').addEventListener('click',(e)=>{
  const item=e.target.closest('.item'); if(!item) return;
  [...$('#settingsNav').children].forEach(x=>x.classList.remove('active')); item.classList.add('active');
  const pane=item.dataset.pane; Object.entries(el.panes).forEach(([k,v])=>v.hidden=(k!==pane));
});
$('#saveAccount').addEventListener('click',()=>{
  state.profile={name:$('#s_name').value,email:$('#s_email').value,phone:$('#s_phone').value}; saveProfile(); alert(t('Save'));
});
$('#savePrefs').addEventListener('click',()=>{
  state.settings.lang=$('#s_lang').value;
  state.settings.spoken=$('#s_spoken').value;
  state.settings.voice=$('#s_voice').value; saveSettings();
  applyI18n(); renderSidebar(); renderChat(); alert(t('Save'));
});
$('#signOutBtn').addEventListener('click',()=>{ alert('Signed out (demo). Hook to your auth when ready.'); closeSettings(); });
$('#deleteAccount').addEventListener('click',()=>{
  if(confirm(t('DeleteConfirm')) && confirm(t('DeleteAccount')+'?')){ localStorage.clear(); location.reload(); }
});
function openSettings(){
  // populate
  $('#s_name').value=state.profile.name||''; $('#s_email').value=state.profile.email||''; $('#s_phone').value=state.profile.phone||''; $('#s_pass').value='';
  $('#s_lang').value=state.settings.lang||'English'; $('#s_spoken').value=state.settings.spoken||'Auto'; $('#s_voice').value=state.settings.voice||'Orion';
  $('#memList').innerHTML = (state.memories||[]).map(m=>`<li>${escapeHtml(m)}</li>`).join('') || '<li style="opacity:.7">No memories yet</li>';
  $('#settings-overlay').style.display='block'; $('#settings').style.display='block';
}
function closeSettings(){ $('#settings').style.display='none'; $('#settings-overlay').style.display='none' }

/* mobile drawer */
$('#hamburger').addEventListener('click',()=>$('#sidebar').classList.toggle('open'));
addEventListener('click',(e)=>{ if(innerWidth<=1024){ if(!e.target.closest('#sidebar')&&!e.target.closest('#hamburger')) $('#sidebar').classList.remove('open'); }});

/* speech: mic (dictation) */
let recog, recognizing=false;
function langToCode(name){
  return {English:'en-US','Espa√±ol':'es-ES','Fran√ßais':'fr-FR','Deutsch':'de-DE',
          'Portugu√™s':'pt-PT','Italiano':'it-IT','Êó•Êú¨Ë™û':'ja-JP','ÌïúÍµ≠Ïñ¥':'ko-KR','‰∏≠Êñá':'zh-CN','‡§π‡§ø‡§®‡•ç‡§¶‡•Ä':'hi-IN'}[name] || 'en-US';
}
function setupRecog(){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition; if(!SR) return null;
  const r=new SR(); r.lang=langToCode(state.settings.spoken||state.settings.lang||'English'); r.interimResults=true; r.continuous=true;
  r.onresult=(ev)=>{ let final=''; for(const res of ev.results){ if(res.isFinal) final+=res[0].transcript+' '; }
    if(final){ const box=$('#msg'); box.value=(box.value+' '+final).trim(); } };
  r.onerror=()=>{}; r.onend=()=>{ recognizing=false; $('#mic').textContent='üéôÔ∏è'; };
  return r;
}
$('#mic').addEventListener('click',()=>{
  recog=recog||setupRecog();
  if(!recog){ alert('Speech recognition not supported in this browser.'); return; }
  if(!recognizing){ recognizing=true; $('#mic').textContent='‚ñ†'; recog.lang=langToCode(state.settings.spoken||state.settings.lang||'English'); try{recog.start()}catch{} }
  else { recognizing=false; $('#mic').textContent='üéôÔ∏è'; try{recog.stop()}catch{} }
});

/* speech: voice (read aloud) */
let isSpeaking=false;
function speak(text){
  if(!('speechSynthesis' in window)) { alert('Speech synthesis not supported.'); return; }
  window.speechSynthesis.cancel();
  const u=new SpeechSynthesisUtterance(text||'');
  const lang=langToCode(state.settings.spoken||state.settings.lang||'English');
  u.lang=lang; u.rate=1; u.pitch=1;
  const voices=window.speechSynthesis.getVoices();
  const match=voices.find(v=>v.lang===lang)||voices.find(v=>v.lang.startsWith(lang.split('-')[0]))||voices[0];
  if(match) u.voice=match;
  window.speechSynthesis.speak(u);
}
$('#voice').addEventListener('click',()=>{
  isSpeaking=!isSpeaking; $('#voice').textContent=isSpeaking? t('Voice')+' ‚ñ£' : t('Voice');
  if(isSpeaking){ const conv=byId(state.currentConvId); const last=(conv?.items||[]).slice().reverse().find(m=>m.role==='ai'&&!m.type); if(last) speak(last.text); }
  else { window.speechSynthesis.cancel(); }
});

/* init */
(function init(){
  applyI18n();
  ensureConv(); renderSidebar(); renderChat();
})();
</script>
</body>
</html>
