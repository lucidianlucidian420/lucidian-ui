<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Lucidian â€” Interface v8</title>
<style>
  :root{
    --accent:#e8c66a;
    --accent-soft:rgba(232,198,106,.16);
    --text:#fff;
    --glass:rgba(0,0,0,.35);
    --glass-strong:rgba(0,0,0,.55);
    --bubble-w: min(92vw, 840px);
  }
  @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap');
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:'Montserrat',system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial,sans-serif;
    color:var(--text);
    background:#000;
    overflow:hidden; /* app scrolls internally */
  }

  /* â€”â€” COSMIC BACKGROUND â€”â€” */
  .space{position:fixed;inset:0;z-index:-2;background:
    radial-gradient(1200px 800px at 70% 30%, rgba(0,120,255,.20), transparent 60%),
    radial-gradient(900px 700px at 20% 70%, rgba(0,200,255,.12), transparent 60%),
    radial-gradient(600px 600px at 50% 50%, rgba(120,180,255,.10), transparent 70%),
    #000}
  .stars,.stars:before,.stars:after,.stars2,.stars2:before,.stars2:after{
    position:absolute;content:"";top:-4000px;left:0;right:0;bottom:0;width:2px;height:2px;background:transparent;
    animation:drift var(--speed,260s) linear infinite
  }
  .stars{--speed:260s; box-shadow: var(--starsA);}
  .stars:before{transform:translateY(4000px) scale(.95); filter:brightness(.85); box-shadow: var(--starsB);}
  .stars:after {transform:translateY(8000px) scale(.9);  filter:brightness(.7);  box-shadow: var(--starsC);}
  .stars2{--speed:300s; box-shadow: var(--starsD);}
  .stars2:before{transform:translateY(4000px) scale(.95); filter:brightness(.9); box-shadow: var(--starsE);}
  .stars2:after {transform:translateY(8000px) scale(.9);  filter:brightness(.75); box-shadow: var(--starsF);}
  @keyframes drift{from{transform:translateY(0)}to{transform:translateY(4000px)}}
  .nebula{position:absolute;inset:-10%;pointer-events:none;z-index:-1;background:
    radial-gradient(60% 50% at 60% 40%, rgba(90,150,255,.15), transparent 70%),
    radial-gradient(50% 45% at 30% 65%, rgba(120,220,255,.12), transparent 70%);
    filter:blur(30px) saturate(120%);animation:breathe 18s ease-in-out infinite}
  @keyframes breathe{0%,100%{transform:translateY(0)}50%{transform:translateY(1.5%)}}

  /* â€”â€” APP LAYOUT â€”â€” */
  .app{
    display:grid;
    grid-template-columns: 300px 1fr;
    grid-template-rows: auto 1fr auto;
    height:100vh;
  }

  /* Header: title centered, symbol to the RIGHT, menu on the LEFT */
  header{
    grid-column:1/3;
    position:relative;
    display:grid;
    grid-template-columns: 48px 1fr 120px; /* left slot, center title, right symbol */
    align-items:center;
    padding:10px 12px 6px;
    background:var(--glass-strong);
    backdrop-filter:blur(8px);
  }
  .hamburger{
    grid-column:1/2;
    justify-self:start;
    background:rgba(255,255,255,.1);
    border:1px solid rgba(255,255,255,.25);
    color:#fff;border-radius:8px;padding:8px 10px;cursor:pointer;display:inline-flex
  }
  h1{
    grid-column:2/3;
    justify-self:center;
    margin:6px 0 0;
    letter-spacing:8px;
    font-size:1.5rem;
    color:var(--accent);
    text-shadow:0 0 12px rgba(232,198,106,.45)
  }
  .crest{
    grid-column:3/4;
    justify-self:end;
    width:84px;display:block
  }
  .crest svg{width:100%;height:auto;display:block;filter:drop-shadow(0 0 10px rgba(232,198,106,.45))}
  .crest path{fill:none;stroke:var(--accent);stroke-width:1.8;stroke-linecap:round}
  .crest .glow{stroke:rgba(232,198,106,.35);stroke-width:4;filter:blur(1px)}

  /* History drawer (left) */
  aside{
    grid-row:2/4;
    background:var(--glass-strong);
    backdrop-filter:blur(8px);
    padding:12px;
    display:flex;flex-direction:column;gap:10px;overflow:hidden
  }
  .search{display:flex;gap:8px}
  .search input{flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.10);color:#fff}
  .search button{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.10);color:#fff;cursor:pointer}
  .new-chat{padding:10px;border:none;border-radius:8px;background:var(--accent);color:#000;font-weight:700;cursor:pointer}
  .list{overflow:auto;border:1px solid rgba(255,255,255,.15);border-radius:10px;background:rgba(255,255,255,.06)}
  .conv{padding:10px;border-bottom:1px solid rgba(255,255,255,.08);cursor:pointer;display:flex;justify-content:space-between;gap:8px}
  .conv.active{background:rgba(255,255,255,.12)}
  .conv .select{border:none;border-radius:6px;padding:4px 8px;background:var(--accent);color:#000;cursor:pointer}

  /* Chat stream (no giant box; just bubbles) */
  main{
    position:relative;overflow:auto;padding:16px;
    background: transparent; /* show stars */
  }
  .stream{max-width:var(--bubble-w);margin:0 auto;display:flex;flex-direction:column;gap:14px;}
  .bubble{
    display:inline-block;
    max-width:100%;
    width:fit-content;
    padding:12px 16px;
    border-radius:12px;
    line-height:1.45;
    word-break:break-word;
    overflow-wrap:break-word;
    backdrop-filter:blur(2px)
  }
  .bubble.lucidian{
    border:1px solid var(--accent);
    color:var(--accent);
    background:var(--accent-soft);
    box-shadow:0 0 12px rgba(232,198,106,.18);
    align-self:flex-start;
  }
  .bubble.user{
    border:1px solid rgba(255,255,255,.7);
    background:rgba(255,255,255,.15);
    color:#fff;
    align-self:flex-end;
  }

  /* Attachments preview inside bubbles */
  .files{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
  .thumb{
    border:1px solid rgba(255,255,255,.2);
    background:rgba(255,255,255,.06);
    padding:6px;border-radius:10px;max-width:160px
  }
  .thumb img{max-width:100%;display:block;border-radius:6px}
  .thumb a{color:#fff;text-decoration:none;font-size:.9rem;display:block;margin-top:6px;word-break:break-all}

  /* Footer input bar pinned */
  footer{
    grid-column:1/3;
    display:flex;gap:10px;align-items:center;padding:10px;background:var(--glass-strong)
  }
  .row{display:flex;gap:8px;align-items:center;width:100%}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.10);color:#fff;cursor:pointer;white-space:nowrap}
  .btn.primary{background:var(--accent);color:#000;border:none;font-weight:700}
  input[type=text]{flex:1;padding:12px 14px;border-radius:10px;border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.10);color:#fff}

  /* Modal (call mode) */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:10}
  .modal.open{display:flex}
  .card{width:min(720px,92vw);background:var(--glass-strong);backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,.2);border-radius:16px;padding:16px}
  .card h2{margin:0 0 8px;color:var(--accent)}
  .controls{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px}
  .wave{height:84px;background:rgba(255,255,255,.08);border-radius:10px;position:relative;overflow:hidden}
  .bar{position:absolute;bottom:0;width:6px;background:var(--accent);left:0;animation:bars 1s ease-in-out infinite}
  @keyframes bars{0%,100%{height:15%}50%{height:85%}}

  /* Mobile */
  @media (max-width: 900px){
    .app{grid-template-columns:1fr;grid-template-rows:auto 1fr auto}
    aside{
      position:fixed;z-index:11;left:0;top:0;bottom:0;width:86vw;
      transform:translateX(-100%);transition:.2s ease;box-shadow:8px 0 30px rgba(0,0,0,.6)
    }
    aside.open{transform:none}
    .hamburger{display:inline-flex}
    footer{grid-column:1/2}
    :root{ --bubble-w: 96vw; }
  }
</style>
</head>
<body>
  <div class="space">
    <div class="stars"></div>
    <div class="stars2"></div>
    <div class="nebula"></div>
  </div>

  <div class="app">
    <header>
      <button class="hamburger" id="hamburger">â˜°</button>
      <h1>LUCIDIAN</h1>

      <!-- SYMBOL â€” unchanged, just positioned on the RIGHT by the grid -->
      <div class="crest" aria-label="Lucidian Crest">
        <svg viewBox="0 0 200 200" role="img" xmlns="http://www.w3.org/2000/svg">
          <circle class="glow" cx="100" cy="100" r="86" />
          <g transform="translate(100,100)">
            <defs>
              <path id="petal" d="M0,-80 C22,-80 40,-62 40,-40 C40,-18 22,0 0,0 C-22,0 -40,-18 -40,-40 C-40,-62 -22,-80 0,-80 Z" />
            </defs>
            <g opacity="0.95">
              <!-- 24 rotated petals (same shape as before) -->
              <use href="#petal" transform="rotate(0)" />
              <use href="#petal" transform="rotate(15)" />
              <use href="#petal" transform="rotate(30)" />
              <use href="#petal" transform="rotate(45)" />
              <use href="#petal" transform="rotate(60)" />
              <use href="#petal" transform="rotate(75)" />
              <use href="#petal" transform="rotate(90)" />
              <use href="#petal" transform="rotate(105)" />
              <use href="#petal" transform="rotate(120)" />
              <use href="#petal" transform="rotate(135)" />
              <use href="#petal" transform="rotate(150)" />
              <use href="#petal" transform="rotate(165)" />
              <use href="#petal" transform="rotate(180)" />
              <use href="#petal" transform="rotate(195)" />
              <use href="#petal" transform="rotate(210)" />
              <use href="#petal" transform="rotate(225)" />
              <use href="#petal" transform="rotate(240)" />
              <use href="#petal" transform="rotate(255)" />
              <use href="#petal" transform="rotate(270)" />
              <use href="#petal" transform="rotate(285)" />
              <use href="#petal" transform="rotate(300)" />
              <use href="#petal" transform="rotate(315)" />
              <use href="#petal" transform="rotate(330)" />
              <use href="#petal" transform="rotate(345)" />
            </g>
          </g>
        </svg>
      </div>
    </header>

    <!-- History drawer (always anchored to far LEFT; click outside to close on mobile) -->
    <aside id="sidebar" aria-label="Conversation history">
      <div class="search">
        <input id="search" type="text" placeholder="Search conversations..." />
        <button id="searchBtn">Go</button>
        <button class="new-chat" id="newChat">New</button>
      </div>
      <div class="list" id="convList"></div>
    </aside>

    <main>
      <div id="stream" class="stream"></div>
    </main>

    <footer>
      <div class="row">
        <label class="btn" for="file">Attach</label>
        <input id="file" type="file" multiple hidden />
        <button class="btn" id="mic" title="Dictate to input (tap to start/stop)">ðŸŽ¤ Mic</button>
        <input id="text" type="text" placeholder="Type a message..." />
        <button class="btn primary" id="send">Send</button>
        <button class="btn" id="voiceStudio" title="Open Voice Studio">Voice</button>
      </div>
    </footer>
  </div>

  <!-- Voice Studio (call mode) -->
  <div class="modal" id="modal">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h2>Lucidian â€” Voice Call</h2>
        <button class="btn" id="closeModal">Close</button>
      </div>
      <div class="controls">
        <button class="btn primary" id="callToggle">Start call</button>
      </div>
      <div class="wave" id="wave"></div>
      <p style="opacity:.8;margin-top:8px">When the call is on: your mic transcribes and you hear spoken replies. Stop ends mic + speech.</p>
    </div>
  </div>

<script>
/* ---------- Stars ---------- */
function rand(n){return Math.floor(Math.random()*n)}
function makeStars(count){
  const arr=[]; for(let i=0;i<count;i++){
    const x=rand(2000)+"px "+(rand(4000))+"px ";
    const c=Math.random(); const col=c>.7? '#fff' : (c>.4? '#dfe9ff' : '#bcd8ff');
    arr.push(x+col);
  } return arr.join(', ');
}
const root=document.documentElement;
root.style.setProperty('--starsA', makeStars(220));
root.style.setProperty('--starsB', makeStars(220));
root.style.setProperty('--starsC', makeStars(220));
root.style.setProperty('--starsD', makeStars(260));
root.style.setProperty('--starsE', makeStars(260));
root.style.setProperty('--starsF', makeStars(260));

/* ---------- State ---------- */
const streamEl = document.getElementById('stream');
const inputEl  = document.getElementById('text');
const fileEl   = document.getElementById('file');
const sendBtn  = document.getElementById('send');
const micBtn   = document.getElementById('mic');
const convList = document.getElementById('convList');
const newChatBtn = document.getElementById('newChat');
const searchEl = document.getElementById('search');
const searchBtn= document.getElementById('searchBtn');
const voiceStudioBtn = document.getElementById('voiceStudio');
const sidebar = document.getElementById('sidebar');
const hamburger = document.getElementById('hamburger');

/* conversations stored locally for now */
let conversations = JSON.parse(localStorage.getItem('lucidian_convs')||'[]');
let activeId = localStorage.getItem('lucidian_active') || null;
function save(){ localStorage.setItem('lucidian_convs', JSON.stringify(conversations)); }
function setActive(id){ activeId=id; localStorage.setItem('lucidian_active', id); renderList(); renderChat(); if(window.innerWidth<900) sidebar.classList.remove('open'); }
function createConversation(){
  const id = Date.now().toString();
  conversations.unshift({id, title:'New Conversation', messages:[]}); // NO "Hello, Ky."
  save(); setActive(id);
}
function renderList(filter=''){
  convList.innerHTML = '';
  conversations
    .filter(c => (c.title||'').toLowerCase().includes(filter.toLowerCase()) ||
                 c.messages.some(m => (m.text||'').toLowerCase().includes(filter.toLowerCase())))
    .forEach(c=>{
      const d=document.createElement('div'); d.className='conv'+(c.id===activeId?' active':'');
      const span=document.createElement('span'); span.textContent=c.title||'Untitled'; span.style.flex='1';
      const sel=document.createElement('button'); sel.textContent='Select'; sel.className='select'; sel.onclick=()=>setActive(c.id);
      d.appendChild(span); d.appendChild(sel); convList.appendChild(d);
    });
}
function renderChat(){
  streamEl.innerHTML='';
  const conv = conversations.find(c=>c.id===activeId);
  if(!conv){ createConversation(); return; }
  conv.messages.forEach(m => appendBubble(m.role, m.text, m.files));
  streamEl.parentElement.scrollTop = streamEl.parentElement.scrollHeight;
}
function appendBubble(role, text, files){
  const b = document.createElement('div');
  b.className = 'bubble '+(role==='user'?'user':'lucidian');
  if(text){ b.appendChild(document.createTextNode(text)); }
  if(files && files.length){
    const wrap=document.createElement('div'); wrap.className='files';
    files.forEach(f=>{
      const card=document.createElement('div'); card.className='thumb';
      if(f.type.startsWith('image/')){
        const img=document.createElement('img'); img.src=f.url; card.appendChild(img);
      }
      const link=document.createElement('a'); link.href=f.url; link.download=f.name; link.textContent=f.name;
      card.appendChild(link); wrap.appendChild(card);
    });
    b.appendChild(wrap);
  }
  streamEl.appendChild(b);
}
function addMessage(role, text, files){
  const conv = conversations.find(c=>c.id===activeId); if(!conv) return;
  const entry = {role, text};
  if(files && files.length){ entry.files = files; }
  conv.messages.push(entry);
  if((conv.title==='New Conversation' || !conv.title) && role==='user' && text && text.trim()){
    conv.title = text.slice(0,42)+(text.length>42?'â€¦':'');
  }
  save(); appendBubble(role, text, files);
  streamEl.parentElement.scrollTop = streamEl.parentElement.scrollHeight;
}

/* ---------- Fake streamed reply so UI feels alive ---------- */
let lastReply = '';
async function lucidianReply(userText){
  const chunks = ["Echoing intention: ", userText||'listening.'];
  lastReply='';
  for(const c of chunks){
    lastReply+=c; await new Promise(r=>setTimeout(r,60));
    updateOrAppendLucidian(lastReply);
  }
  if(callActive && 'speechSynthesis' in window){
    const u=new SpeechSynthesisUtterance(lastReply); speechSynthesis.speak(u);
  }
}
function updateOrAppendLucidian(text){
  const conv = conversations.find(c=>c.id===activeId); if(!conv) return;
  const last = conv.messages[conv.messages.length-1];
  if(last && last.role==='lucidian'){ last.text=text; }
  else { conv.messages.push({role:'lucidian', text}); }
  save(); renderChat();
}

/* ---------- Send flow ---------- */
sendBtn.onclick=async ()=>{
  const text=inputEl.value.trim();
  const filesPayload = pendingFiles.splice(0).map(f=>({name:f.name, type:f.type, url:f.url}));
  if(!text && !filesPayload.length) return;
  addMessage('user', text, filesPayload);
  inputEl.value='';
  await lucidianReply(text);
};
inputEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendBtn.click(); }});

/* ---------- File attachments (preview + send) ---------- */
let pendingFiles=[];
fileEl.onchange = async (e)=>{
  const files=[...e.target.files];
  for(const f of files){
    const url = URL.createObjectURL(f);
    pendingFiles.push({name:f.name,type:f.type,url});
  }
  // show a temporary preview bubble on user side
  if(pendingFiles.length){
    // remove existing temp preview if any
    const previews = document.querySelectorAll('.bubble.user.pending');
    previews.forEach(p=>p.remove());
    const b = document.createElement('div'); b.className='bubble user pending';
    const wrap=document.createElement('div'); wrap.className='files';
    pendingFiles.forEach(f=>{
      const card=document.createElement('div'); card.className='thumb';
      if(f.type.startsWith('image/')){ const img=document.createElement('img'); img.src=f.url; card.appendChild(img); }
      const a=document.createElement('a'); a.href=f.url; a.download=f.name; a.textContent=f.name; card.appendChild(a);
      wrap.appendChild(card);
    });
    b.appendChild(wrap); streamEl.appendChild(b);
    streamEl.parentElement.scrollTop = streamEl.parentElement.scrollHeight;
  }
};

/* ---------- Sidebar toggle + click-outside close (mobile) ---------- */
hamburger.onclick=()=> sidebar.classList.toggle('open');
document.addEventListener('click', (e)=>{
  if(window.innerWidth>=900) return;
  const withinSidebar = sidebar.contains(e.target);
  const clickedHamburger = hamburger.contains(e.target);
  if(!withinSidebar && !clickedHamburger) sidebar.classList.remove('open');
});
newChatBtn.onclick=createConversation;
searchBtn.onclick=()=> renderList(searchEl.value);
searchEl.addEventListener('keydown', e=>{ if(e.key==='Enter'){ renderList(searchEl.value); }});

/* ---------- Voice Call mode ---------- */
const modal = document.getElementById('modal');
const callToggle = document.getElementById('callToggle');
const closeModal = document.getElementById('closeModal');
const wave=document.getElementById('wave');
voiceStudioBtn.onclick=()=>{ modal.classList.add('open'); };
closeModal.onclick=()=>{ modal.classList.remove('open'); stopCall(); };
for(let i=0;i<70;i++){ const b=document.createElement('div'); b.className='bar'; b.style.left=(i*10)+'px'; b.style.animationDelay=(Math.random()*1)+'s'; wave.appendChild(b); }

let recognition, recognizing=false, callActive=false;
if('webkitSpeechRecognition' in window || 'SpeechRecognition' in window){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SR(); recognition.lang='en-US'; recognition.continuous=true; recognition.interimResults=true;

  recognition.onresult = (e)=>{
    // live transcription to input; DO NOT auto-send; never clear on pause
    let finalTxt=""; let interimTxt="";
    for(let i=0;i<e.results.length;i++){
      const res=e.results[i];
      if(res.isFinal) finalTxt += res[0].transcript;
      else interimTxt += res[0].transcript;
    }
    inputEl.value = (finalTxt || interimTxt || '').trim();
  };
  recognition.onend = ()=>{ if(callActive){ recognition.start(); } else { recognizing=false; } };
}
function startCall(){
  if(!recognition){ alert('Speech Recognition not supported in this browser.'); return; }
  callActive=true; callToggle.textContent='Stop call'; if(!recognizing){ recognition.start(); recognizing=true; }
}
function stopCall(){
  callActive=false; callToggle.textContent='Start call';
  if(recognition){ try{ recognition.stop(); }catch{} } recognizing=false;
  if('speechSynthesis' in window){ speechSynthesis.cancel(); }
}
callToggle.onclick=()=> callActive? stopCall() : startCall();

/* Quick mic (dictate into box, tap to stop/start) */
let quickMic=false;
micBtn.onclick=()=>{
  if(!recognition){ alert('Speech Recognition not supported in this browser.'); return; }
  if(!quickMic){ recognition.start(); recognizing=true; quickMic=true; micBtn.classList.add('on'); }
  else { try{recognition.stop();}catch{} quickMic=false; micBtn.classList.remove('on'); }
};

/* ---------- PWA (installable + offline) ---------- */
if('serviceWorker' in navigator){
  const swCode = `
self.addEventListener('install', e=>{ self.skipWaiting(); e.waitUntil(caches.open('lucidian-v3').then(c=>c.addAll(['./']))); });
self.addEventListener('fetch', e=>{ e.respondWith(caches.match(e.request).then(r=> r || fetch(e.request))); });`;
  const blob = new Blob([swCode], {type:'text/javascript'});
  const swUrl = URL.createObjectURL(blob);
  navigator.serviceWorker.register(swUrl);
}
const manifest = { name:'Lucidian', short_name:'Lucidian', start_url:'./', display:'standalone', background_color:'#000', theme_color:'#000', icons:[] };
const mBlob = new Blob([JSON.stringify(manifest)], {type:'application/json'});
const mUrl = URL.createObjectURL(mBlob);
const link = document.createElement('link'); link.rel='manifest'; link.href=mUrl; document.head.appendChild(link);

/* ---------- Boot ---------- */
if(!activeId && conversations.length){ activeId = conversations[0].id; }
if(!conversations.length){ createConversation(); } else { renderList(); renderChat(); }
</script>
</body>
</html>
