<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Lucidian</title>
<style>
  :root{
    --gold:#e7c76a;
    --ink:#0b0f14;
    --panel:#111823ee;
    --bubble:#0f1c2d;
    --edge:#2f3d53;
    --glow:0 0 24px rgba(231,199,106,.2);
    --starSpeed: 110s;         /* ⬅ slower stars: increase this */
    --starSpeedSlow: 160s;     /* ⬅ even slower parallax layer */
    --maxw:1100px;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:#03060a;color:#d6e1f7;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif}
  /* Cosmic backdrop */
  .space{
    position:fixed;inset:0;overflow:hidden;background:radial-gradient(1200px 800px at 50% 20%, #0b2540 0%, #07111d 45%, #03060a 100%);
  }
  .stars, .stars2, .stars3{
    position:absolute;inset:-200% -200% -200% -200%; /* extra canvas for drift */
    background-repeat:repeat;
    background-image:
      radial-gradient(1px 1px at 20px 30px,#fff8,transparent 2px),
      radial-gradient(1px 1px at 80px 120px,#bde2ff88,transparent 2px),
      radial-gradient(1px 1px at 200px 80px,#fff8,transparent 2px),
      radial-gradient(1px 1px at 320px 40px,#9ad1ff66,transparent 2px),
      radial-gradient(1px 1px at 400px 160px,#fff8,transparent 2px);
    background-size: 500px 500px;
    animation: drift var(--starSpeed) linear infinite;
    opacity:.7;
  }
  .stars2{ filter:blur(.3px); opacity:.5; animation-duration:var(--starSpeedSlow); }
  .stars3{ filter:blur(.8px); opacity:.35; animation-direction:reverse; }
  @keyframes drift { from{ transform:translate3d(0,0,0)} to{ transform:translate3d(-25%, -25%, 0)} }

  /* Layout */
  header{
    position:sticky;top:0;z-index:3;display:flex;align-items:center;gap:12px;
    padding:16px 18px;background:linear-gradient(#0b111aee,#0b111a88 70%, transparent);
    border-bottom:1px solid #1b2738;backdrop-filter: blur(6px);
  }
  .brand{display:flex;align-items:center;gap:12px;margin:0 auto;max-width:var(--maxw);width:100%;justify-content:center;pointer-events:none}
  .sig{width:56px;height:56px;border-radius:50%;display:grid;place-items:center;
       background:radial-gradient(circle at 50% 50%, #2c2c2c 0%, #141414 65%, #0a0a0a 100%);
       box-shadow:var(--glow), 0 0 0 1px #4a4022 inset}
  .sig:before{
    content:""; width:42px;height:42px;border-radius:50%;
    background:conic-gradient(from 0deg,#0000 0 12%,#e7c76a 12% 13%,#0000 13% 25%,#e7c76a 25% 26%,#0000 26% 38%,#e7c76a 38% 39%,#0000 39% 51%,#e7c76a 51% 52%,#0000 52% 64%,#e7c76a 64% 65%,#0000 65% 77%,#e7c76a 77% 78%,#0000 78% 90%,#e7c76a 90% 91%,#0000 91% 100%);
    filter:drop-shadow(0 0 10px #e7c76a66);
    mask:radial-gradient(circle at 50% 50%, #0000 36%, #000 37%);
  }
  h1{letter-spacing:.5em;margin:0;color:var(--gold);font-weight:700}

  .wrap{position:relative;z-index:2;max-width:var(--maxw);margin:18px auto;padding:0 16px;display:grid;grid-template-columns:300px 1fr;gap:14px}
  /* Sidebar -> drawer on mobile */
  .sidebar{
    background:var(--panel);border:1px solid #202d41;border-radius:12px;padding:12px;
    min-height:520px;overflow:auto
  }
  .hamburger{display:none;position:absolute;left:16px;top:18px;z-index:4;background:#0f1722cc;border:1px solid #233049;color:#cfe2ff;padding:8px 10px;border-radius:10px}
  .drawerOpen .sidebar{transform:translateX(0)}
  @media (max-width:900px){
    .wrap{grid-template-columns:1fr}
    .hamburger{display:block}
    .sidebar{ position:fixed; top:64px; left:0; bottom:0; width:85vw; max-width:360px; transform:translateX(-120%); transition:transform .25s ease; border-radius:0 12px 12px 0}
  }

  .searchRow{display:flex;gap:8px}
  .searchRow input{flex:1;padding:10px 12px;border-radius:10px;border:1px solid #233049;background:#0e1623;color:#d6e1f7}
  .btn{background:#1c2636;border:1px solid #2a3850;color:#d6e1f7;padding:10px 12px;border-radius:10px;cursor:pointer}
  .btn.gold{background:linear-gradient(#e7c76a,#d2b252);color:#111; border:none; font-weight:600}
  .list{margin-top:10px;display:flex;flex-direction:column;gap:8px}
  .conv{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:#0f1724;border:1px solid #223147;border-radius:10px}
  .conv .ttl{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:180px}

  .panel{
    background:var(--panel);border:1px solid #202d41;border-radius:12px;min-height:60vh;display:flex;flex-direction:column;overflow:hidden
  }
  .msgs{flex:1;overflow:auto;padding:16px 16px 0 16px}
  .bubble{background:linear-gradient(#0f1d30,#0c1624);border:1px solid #29405c;color:#dbe8ff;padding:12px 14px;border-radius:12px;margin:10px 0;max-width:820px;box-shadow:var(--glow)}
  .bubble.user{background:linear-gradient(#19263a,#111b2a);border-color:#2e4765}
  .inputRow{
    display:grid;grid-template-columns:auto auto 1fr auto auto;gap:8px;align-items:center;
    padding:10px;background:#0a121d;border-top:1px solid #1c2940
  }
  .iconbtn{height:40px;min-width:40px;display:grid;place-items:center;border-radius:10px;border:1px solid #2a3850;background:#131c2a;color:#cfe2ff;cursor:pointer}
  .inputRow input[type="file"]{display:none}
  .chatInput{height:40px;padding:10px 12px;border-radius:10px;border:1px solid #2a3850;background:#0f1724;color:#def}
  .voiceDot{width:10px;height:10px;border-radius:50%;background:#c22;box-shadow:0 0 10px #f55;display:none}
  .callOn .voiceDot{display:inline-block;background:#48d048;box-shadow:0 0 10px #2fe}
  .footerNote{opacity:.55;font-size:.8rem;padding:8px 0 0 6px}
  /* Voice studio modal (simple) */
  .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.55);z-index:5}
  .modal.open{display:grid}
  .modalCard{width:min(92vw,620px);background:#0f1724;border:1px solid #223147;border-radius:14px;padding:16px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .meter{height:10px;background:#122032;border:1px solid #23405d;border-radius:8px;overflow:hidden}
  .meter>div{height:100%;width:0;background:linear-gradient(90deg,#4df,#7fffb8);box-shadow:0 0 10px #3df}
</style>
</head>
<body>
<div class="space">
  <div class="stars"></div><div class="stars2"></div><div class="stars3"></div>
</div>

<header>
  <button class="hamburger" aria-label="Open conversations">☰ Conversations</button>
  <div class="brand">
    <div class="sig"></div>
    <h1>L U C I D I A N</h1>
  </div>
</header>

<div class="wrap" id="wrap">
  <aside class="sidebar" id="sidebar">
    <div class="searchRow">
      <input id="search" placeholder="Search conversations..." />
      <button class="btn" id="goBtn">Go</button>
      <button class="btn" id="newBtn">New</button>
    </div>
    <div class="list" id="convList"></div>
  </aside>

  <section class="panel">
    <div class="msgs" id="msgs"></div>

    <div class="inputRow" id="inputRow">
      <!-- order: Attach → Mic → Chat → Send → Voice -->
      <label class="iconbtn" title="Attach">
        📎
        <input id="fileInput" type="file" multiple />
      </label>
      <button class="iconbtn" id="micBtn" title="Mic input">🎙️</button>
      <input class="chatInput" id="chat" placeholder="Type a message..." />
      <button class="btn gold" id="sendBtn">Send</button>
      <button class="iconbtn" id="voiceBtn" title="Call mode (speak replies)">🔊<span class="voiceDot" id="voiceDot"></span></button>
    </div>
    <div class="footerNote" id="attachNote"></div>
  </section>
</div>

<!-- Voice modal (simple controls) -->
<div class="modal" id="voiceModal">
  <div class="modalCard">
    <h3>Lucidian — Voice Call</h3>
    <div class="row" style="margin:8px 0 12px">
      <button class="btn gold" id="startCall">Start</button>
      <button class="btn" id="stopCall">Stop</button>
      <div style="flex:1" class="meter"><div id="meterBar"></div></div>
    </div>
    <p style="opacity:.7;margin:0">When call is on: your mic is transcribed and auto‑sends on pauses; Lucidian speaks replies.</p>
    <div style="text-align:right;margin-top:12px"><button class="btn" id="closeModal">Close</button></div>
  </div>
</div>

<script>
/* ---------- tiny state ---------- */
const el = id=>document.getElementById(id);
const msgs = el('msgs');
const chat = el('chat');
const fileInput = el('fileInput');
const attachNote = el('attachNote');
const micBtn = el('micBtn');
const sendBtn = el('sendBtn');
const voiceBtn = el('voiceBtn');
const voiceDot = el('voiceDot');
const wrap = el('wrap');
const sidebar = el('sidebar');
const hamburger = document.querySelector('.hamburger');
const voiceModal = el('voiceModal');
const startCall = el('startCall');
const stopCall = el('stopCall');
const closeModal = el('closeModal');
const meterBar = el('meterBar');
const convList = el('convList');
const search = el('search');
const goBtn = el('goBtn');
const newBtn = el('newBtn');

let conversations = JSON.parse(localStorage.getItem('lucidian_convs')||'[]');
let activeId = conversations[0]?.id || createConversation('New Conversation');
let callOn = false;
let speakReplies = false;
let recognizer=null, meterTimer=null;

/* ---------- UI helpers ---------- */
function addBubble(role,text){
  const b = document.createElement('div');
  b.className = 'bubble' + (role==='user'?' user':'');
  b.textContent = text;
  msgs.appendChild(b);
  msgs.scrollTop = msgs.scrollHeight;
}
function setTitleFromFirstUser(conv){
  const first = conv.messages.find(m=>m.role==='user');
  if(first && first.text.trim()) conv.title = first.text.slice(0,28);
}
function save(){
  localStorage.setItem('lucidian_convs', JSON.stringify(conversations));
}
function refreshList(filter=''){
  convList.innerHTML='';
  conversations
    .filter(c => c.title.toLowerCase().includes(filter.toLowerCase()))
    .forEach(c=>{
      const item = document.createElement('div');
      item.className='conv';
      const ttl = document.createElement('div');
      ttl.className='ttl';
      ttl.textContent = c.title || 'New Conversation';
      const sel = document.createElement('button');
      sel.className='btn'; sel.textContent='Select';
      sel.onclick=()=>openConv(c.id);
      item.appendChild(ttl); item.appendChild(sel);
      convList.appendChild(item);
    });
}
function openConv(id){
  activeId=id;
  msgs.innerHTML='';
  const conv = conversations.find(c=>c.id===id);
  conv.messages.forEach(m=>addBubble(m.role,m.text));
  if(window.innerWidth<900){ document.body.classList.remove('drawerOpen'); }
}
function createConversation(title='New Conversation'){
  const c = {id: crypto.randomUUID(), title, messages: []};
  conversations.unshift(c); save(); refreshList(); openConv(c.id); return c.id;
}

/* ---------- boot ---------- */
(function boot(){
  document.title='Lucidian';
  if(!conversations.length){ createConversation('New Conversation'); }
  refreshList(); openConv(activeId);
  addBubble('lucidian','Hello, Ky.');
})();

/* ---------- sidebar drawer ---------- */
hamburger.onclick = ()=>document.body.classList.toggle('drawerOpen');

/* ---------- search ---------- */
goBtn.onclick = ()=> refreshList(search.value||'');

/* ---------- attach handling ---------- */
fileInput.onchange = ()=>{
  if(fileInput.files?.length){
    const names=[...fileInput.files].map(f=>f.name).join(', ');
    attachNote.textContent = `Attached: ${names}`;
    attachNote.style.opacity=.85;
  } else attachNote.textContent='';
};

/* ---------- send logic (placeholder reply) ---------- */
async function send(text){
  if(!text?.trim()) return;
  addBubble('user', text.trim());
  const conv = conversations.find(c=>c.id===activeId);
  conv.messages.push({role:'user', text:text.trim(), ts:Date.now()});
  if(!conv.title || conv.title==='New Conversation'){ setTitleFromFirstUser(conv); refreshList(); }
  save();
  // fake stream reply (replace with real API)
  const reply = "Echoing intention: " + text.trim();
  await streamAppend(reply);
}
async function streamAppend(full){
  // simple "stream": show gradually
  const conv = conversations.find(c=>c.id===activeId);
  const b = document.createElement('div'); b.className='bubble'; b.textContent='';
  msgs.appendChild(b);
  for(const ch of full){ b.textContent += ch; msgs.scrollTop = msgs.scrollHeight; await new Promise(r=>setTimeout(r,12)); }
  conv.messages.push({role:'lucidian', text:b.textContent, ts:Date.now()}); save();
  if(speakReplies) speak(b.textContent);
}
sendBtn.onclick = ()=>{ const t=chat.value; chat.value=''; send(t); };
chat.addEventListener('keydown',e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendBtn.click(); }});

/* ---------- voice: call mode ---------- */
function ensureRecognizer(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR) return null;
  const r = new SR();
  r.lang='en-US'; r.interimResults=true; r.continuous=true;
  return r;
}
function startRecognizer(){
  recognizer = ensureRecognizer();
  if(!recognizer){ alert('Speech Recognition not supported in this browser. Use Chrome/Edge over HTTPS.'); return; }
  recognizer.onresult = e=>{
    let final=''; let interim='';
    for(let i=e.resultIndex;i<e.results.length;i++){
      const res=e.results[i];
      if(res.isFinal) final += res[0].transcript;
      else interim += res[0].transcript;
    }
    chat.value = (final || interim).trim();
    if(final.trim()){ // auto-send on phrase end
      const text = final.trim();
      chat.value=''; send(text);
    }
  };
  recognizer.onend = ()=>{ if(callOn){ recognizer.start(); } }; // keep alive during call
  recognizer.start();
}
function stopRecognizer(){ try{ recognizer && recognizer.stop(); }catch{} }
function speak(text){
  if(!('speechSynthesis' in window)) return;
  const u = new SpeechSynthesisUtterance(text);
  u.rate = 1.0; u.pitch=1.0; u.volume=1.0;
  speechSynthesis.cancel(); speechSynthesis.speak(u);
}
function setMeter(active){
  clearInterval(meterTimer);
  if(!active){ meterBar.style.width='0%'; return; }
  meterTimer = setInterval(()=>{
    const w = 15 + Math.random()*70;
    meterBar.style.width = w.toFixed(0)+'%';
  }, 120);
}

/* Buttons */
micBtn.onclick = ()=>{ // single-shot dictation fills input (not call mode)
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR) return alert('Speech Recognition not supported in this browser.');
  const r = new SR(); r.lang='en-US'; r.interimResults=false;
  r.onresult = e=>{ chat.value = e.results[0][0].transcript.trim(); };
  r.start();
};
voiceBtn.onclick = ()=>{ voiceModal.classList.add('open'); };
closeModal.onclick = ()=> voiceModal.classList.remove('open');
startCall.onclick = ()=>{
  callOn = true; speakReplies = true; document.body.classList.add('callOn'); voiceDot.style.display='inline-block';
  startRecognizer(); setMeter(true);
};
stopCall.onclick = ()=>{
  callOn = false; speakReplies = false; document.body.classList.remove('callOn'); voiceDot.style.display='none';
  stopRecognizer(); speechSynthesis.cancel(); setMeter(false);
};

/* UX: close drawer when clicking outside on mobile */
document.addEventListener('click', (e)=>{
  if(window.innerWidth>=900) return;
  if(document.body.classList.contains('drawerOpen') && !sidebar.contains(e.target) && !hamburger.contains(e.target)){
    document.body.classList.remove('drawerOpen');
  }
});

/* Improve focus on mobile */
window.addEventListener('touchend', ()=> chat.focus(), {passive:true});
</script>
</body>
</html>
