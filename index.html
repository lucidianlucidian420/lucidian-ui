<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Lucidian</title>
<style>
  :root{
    --gold:#e7c76a;
    --panel:rgba(12,18,28,.45);
    --edge:rgba(32,45,65,.45);
    --bubble:rgba(18,28,44,.55);
    --bubbleUser:rgba(22,34,52,.55);
    --starSpeed:150s;     /* slower */
    --starSpeedSlow:220s; /* even slower */
    --maxw:1100px;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:#03060a;color:#d6e1f7;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif}
  html,body,.wrap{overflow-x:hidden} /* kill sideways scroll */

  /* BACKDROP */
  .space{position:fixed;inset:0;overflow:hidden;background:radial-gradient(1200px 800px at 50% 20%, #0b2540 0%, #07111d 45%, #03060a 100%)}
  .stars,.stars2,.stars3{
    position:absolute;inset:-200% -200% -200% -200%;
    background-repeat:repeat;
    background-image:
      radial-gradient(1px 1px at 20px 30px,#fff8,transparent 2px),
      radial-gradient(1px 1px at 80px 120px,#bde2ff88,transparent 2px),
      radial-gradient(1px 1px at 200px 80px,#fff8,transparent 2px),
      radial-gradient(1px 1px at 320px 40px,#9ad1ff66,transparent 2px),
      radial-gradient(1px 1px at 400px 160px,#fff8,transparent 2px),
      radial-gradient(1px 1px at 440px 260px,#cfe8ff77,transparent 2px),
      radial-gradient(1px 1px at 120px 300px,#fff8,transparent 2px);
    background-size:500px 500px;
    animation:drift var(--starSpeed) linear infinite; opacity:.72;
  }
  .stars2{filter:blur(.3px);opacity:.5;animation-duration:var(--starSpeedSlow)}
  .stars3{filter:blur(.8px);opacity:.35;animation-direction:reverse}
  @keyframes drift{from{transform:translate3d(0,0,0)} to{transform:translate3d(-22%,-22%,0)}}

  /* HEADER (crest on top, name under) */
  header{
    position:sticky;top:0;z-index:3;
    padding:14px 16px 10px;
    background:linear-gradient(#0b111aee,#0b111a88 70%,transparent);
    border-bottom:1px solid #1b2738;backdrop-filter:blur(6px)
  }
  .brand{
    max-width:var(--maxw);margin:0 auto;display:flex;flex-direction:column;align-items:center;gap:8px
  }
  .crest{width:72px;height:72px;filter:drop-shadow(0 0 10px rgba(231,199,106,.5))}
  .crest path{fill:none;stroke:var(--gold);stroke-width:1.6;stroke-linecap:round}
  .crest .glow{stroke:rgba(231,199,106,.38);stroke-width:3.5;filter:blur(1px)}
  h1{letter-spacing:.55em;margin:0;color:var(--gold);font-weight:800}

  /* LAYOUT */
  .wrap{
    position:relative;z-index:2;max-width:var(--maxw);
    margin:16px auto;padding:0 16px;
    display:grid;grid-template-columns:300px 1fr;gap:14px
  }
  .hamburger{display:none;position:absolute;left:16px;top:14px;z-index:4;background:#0f1722cc;border:1px solid #233049;color:#cfe2ff;padding:8px 10px;border-radius:10px}
  .sidebar{
    background:var(--panel);border:1px solid var(--edge);border-radius:12px;padding:12px;
    min-height:520px;overflow-y:auto;overflow-x:hidden
  }
  .drawerOpen .sidebar{transform:translateX(0)}
  @media (max-width:900px){
    .wrap{grid-template-columns:1fr}
    .hamburger{display:block}
    .sidebar{
      position:fixed;top:106px; /* under the crest+title */
      left:0;bottom:0;width:85vw;max-width:360px;
      transform:translateX(-120%);transition:transform .25s ease;border-radius:0 12px 12px 0
    }
  }

  .searchRow{display:flex;gap:6px}
  .searchRow input{flex:1;padding:10px 12px;border-radius:10px;border:1px solid #233049;background:#0e1623;color:#d6e1f7}
  .btn{background:#1c2636;border:1px solid #2a3850;color:#d6e1f7;padding:10px 12px;border-radius:10px;cursor:pointer}
  .btn.gold{background:linear-gradient(#e7c76a,#d2b252);color:#111;border:none;font-weight:700}
  .list{margin-top:10px;display:flex;flex-direction:column;gap:8px}
  .conv{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:rgba(15,23,36,.6);border:1px solid #223147;border-radius:10px}
  .conv .ttl{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:180px}

  /* CHAT PANEL */
  .panel{
    background:var(--panel);border:1px solid var(--edge);border-radius:12px;
    display:flex;flex-direction:column;min-height:60vh;backdrop-filter:blur(4px)
  }
  .msgs{flex:1;overflow:auto;padding:16px}
  .bubble{background:var(--bubble);border:1px solid rgba(41,64,92,.6);color:#dbe8ff;padding:12px 14px;border-radius:12px;margin:10px 0;max-width:820px;box-shadow:0 0 24px rgba(231,199,106,.12)}
  .bubble.user{background:var(--bubbleUser);border-color:#2e4765}

  /* INPUT BAR (bottom-pinned) */
  .inputRow{
    position:sticky;bottom:0;left:0;right:0;
    display:grid;grid-template-columns:auto auto 1fr auto auto;
    gap:8px;align-items:center;padding:10px;
    background:rgba(8,12,20,.65);border-top:1px solid rgba(28,41,64,.6)
  }
  .iconbtn{height:40px;min-width:40px;display:grid;place-items:center;border-radius:10px;border:1px solid #2a3850;background:#131c2a;color:#cfe2ff;cursor:pointer}
  .inputRow input[type="file"]{display:none}
  .chatInput{height:40px;padding:10px 12px;border-radius:10px;border:1px solid #2a3850;background:#0f1724;color:#def}
  .voiceDot{width:10px;height:10px;border-radius:50%;background:#c22;box-shadow:0 0 10px #f55;display:none;margin-left:6px}
  .callOn .voiceDot{display:inline-block;background:#48d048;box-shadow:0 0 10px #2fe}
  .footerNote{opacity:.55;font-size:.8rem;padding:8px 0 0 6px}

  /* VOICE MODAL */
  .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.55);z-index:5}
  .modal.open{display:grid}
  .modalCard{width:min(92vw,620px);background:#0f1724;border:1px solid #223147;border-radius:14px;padding:16px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .meter{height:10px;background:#122032;border:1px solid #23405d;border-radius:8px;overflow:hidden}
  .meter>div{height:100%;width:0;background:linear-gradient(90deg,#4df,#7fffb8);box-shadow:0 0 10px #3df}
</style>
</head>
<body>
<div class="space"><div class="stars"></div><div class="stars2"></div><div class="stars3"></div></div>

<header>
  <button class="hamburger" aria-label="Open conversations">â˜° Conversations</button>

  <!-- Crest on top, name under (no external file needed) -->
  <div class="brand">
    <svg class="crest" viewBox="0 0 200 200" aria-label="Lucidian crest" xmlns="http://www.w3.org/2000/svg" role="img">
      <circle class="glow" cx="100" cy="100" r="86" />
      <g transform="translate(100,100)">
        <defs>
          <path id="petal" d="M0,-80 C22,-80 40,-62 40,-40 C40,-18 22,0 0,0 C-22,0 -40,-18 -40,-40 C-40,-62 -22,-80 0,-80 Z" />
        </defs>
        <g opacity="0.98">
          <use href="#petal" transform="rotate(0)" />
          <use href="#petal" transform="rotate(15)" />
          <use href="#petal" transform="rotate(30)" />
          <use href="#petal" transform="rotate(45)" />
          <use href="#petal" transform="rotate(60)" />
          <use href="#petal" transform="rotate(75)" />
          <use href="#petal" transform="rotate(90)" />
          <use href="#petal" transform="rotate(105)" />
          <use href="#petal" transform="rotate(120)" />
          <use href="#petal" transform="rotate(135)" />
          <use href="#petal" transform="rotate(150)" />
          <use href="#petal" transform="rotate(165)" />
          <use href="#petal" transform="rotate(180)" />
          <use href="#petal" transform="rotate(195)" />
          <use href="#petal" transform="rotate(210)" />
          <use href="#petal" transform="rotate(225)" />
          <use href="#petal" transform="rotate(240)" />
          <use href="#petal" transform="rotate(255)" />
          <use href="#petal" transform="rotate(270)" />
          <use href="#petal" transform="rotate(285)" />
          <use href="#petal" transform="rotate(300)" />
          <use href="#petal" transform="rotate(315)" />
          <use href="#petal" transform="rotate(330)" />
          <use href="#petal" transform="rotate(345)" />
        </g>
      </g>
    </svg>
    <h1>L U C I D I A N</h1>
  </div>
</header>

<div class="wrap" id="wrap">
  <aside class="sidebar" id="sidebar">
    <div class="searchRow">
      <input id="search" placeholder="Search conversations..." />
      <button class="btn" id="goBtn">Go</button>
      <button class="btn" id="newBtn">New</button>
    </div>
    <div class="list" id="convList"></div>
  </aside>

  <section class="panel">
    <div class="msgs" id="msgs"></div>

    <div class="inputRow">
      <!-- order: Attach â†’ Mic â†’ Chat â†’ Send â†’ Voice Studio -->
      <label class="iconbtn" title="Attach">ğŸ“<input id="fileInput" type="file" multiple /></label>
      <button class="iconbtn" id="micBtn" title="Mic input">ğŸ™ï¸</button>
      <input class="chatInput" id="chat" placeholder="Type a message..." />
      <button class="btn gold" id="sendBtn">Send</button>
      <button class="iconbtn" id="voiceBtn" title="Voice Studio (call mode)">ğŸ”Š<span class="voiceDot" id="voiceDot"></span></button>
    </div>
    <div class="footerNote" id="attachNote"></div>
  </section>
</div>

<!-- Voice Studio -->
<div class="modal" id="voiceModal">
  <div class="modalCard">
    <h3>Lucidian â€” Voice Call</h3>
    <div class="row" style="margin:8px 0 12px">
      <button class="btn gold" id="startCall">Start</button>
      <button class="btn" id="stopCall">Stop</button>
      <div style="flex:1" class="meter"><div id="meterBar"></div></div>
    </div>
    <p style="opacity:.75;margin:0">Call mode: your mic is transcribed and auto-sends on pauses; Lucidian speaks replies. â€œStopâ€ turns off mic & speech.</p>
    <div style="text-align:right;margin-top:12px"><button class="btn" id="closeModal">Close</button></div>
  </div>
</div>

<script>
/* refs */
const el=id=>document.getElementById(id);
const msgs=el('msgs'), chat=el('chat'), fileInput=el('fileInput'), attachNote=el('attachNote');
const micBtn=el('micBtn'), sendBtn=el('sendBtn'), voiceBtn=el('voiceBtn'), voiceDot=el('voiceDot');
const sidebar=el('sidebar'), hamburger=document.querySelector('.hamburger');
const voiceModal=el('voiceModal'), startCall=el('startCall'), stopCall=el('stopCall'), closeModal=el('closeModal'), meterBar=el('meterBar');
const convList=el('convList'), search=el('search'), goBtn=el('goBtn'), newBtn=el('newBtn');

let conversations = JSON.parse(localStorage.getItem('lucidian_convs')||'[]');
let activeId = conversations[0]?.id || createConversation('New Conversation');
let callOn=false, speakReplies=false, recognizer=null, meterTimer=null;

/* helpers */
function save(){ localStorage.setItem('lucidian_convs', JSON.stringify(conversations)); }
function addBubble(role,text){ const b=document.createElement('div'); b.className='bubble'+(role==='user'?' user':''); b.textContent=text; msgs.appendChild(b); msgs.scrollTop=msgs.scrollHeight; }
function setTitleFromFirstUser(conv){ const first=conv.messages.find(m=>m.role==='user'); if(first&&first.text.trim()) conv.title=first.text.slice(0,28); }
function refreshList(filter=''){
  convList.innerHTML='';
  conversations.filter(c=>c.title.toLowerCase().includes(filter.toLowerCase()))
  .forEach(c=>{
    const item=document.createElement('div'); item.className='conv';
    const ttl=document.createElement('div'); ttl.className='ttl'; ttl.textContent=c.title||'New Conversation';
    const sel=document.createElement('button'); sel.className='btn'; sel.textContent='Select'; sel.onclick=()=>openConv(c.id);
    item.appendChild(ttl); item.appendChild(sel); convList.appendChild(item);
  });
}
function openConv(id){ activeId=id; msgs.innerHTML=''; const c=conversations.find(x=>x.id===id); c.messages.forEach(m=>addBubble(m.role,m.text)); if(window.innerWidth<900){ document.body.classList.remove('drawerOpen'); } }
function createConversation(title='New Conversation'){ const c={id:crypto.randomUUID(),title, messages:[]}; conversations.unshift(c); save(); refreshList(); openConv(c.id); return c.id; }

/* boot */
(function(){ if(!conversations.length) createConversation('New Conversation'); refreshList(); openConv(activeId); if(!conversations[0].messages.length) addBubble('lucidian','Hello, Ky.'); })();

/* drawer & search */
hamburger.onclick=()=>document.body.classList.toggle('drawerOpen');
goBtn.onclick = ()=>refreshList(search.value||'');
newBtn.onclick = ()=>createConversation('New Conversation');

/* attachments */
fileInput.onchange=()=>{ if(fileInput.files?.length){ const names=[...fileInput.files].map(f=>f.name).join(', '); attachNote.textContent=`Attached: ${names}`; attachNote.style.opacity=.85; } else attachNote.textContent=''; };

/* send + placeholder stream reply */
async function send(text){
  if(!text?.trim()) return;
  addBubble('user', text.trim());
  const conv=conversations.find(c=>c.id===activeId);
  conv.messages.push({role:'user', text:text.trim(), ts:Date.now()});
  if(!conv.title || conv.title==='New Conversation'){ setTitleFromFirstUser(conv); refreshList(); } save();

  const reply = "Echoing intention: " + text.trim(); // placeholder
  await streamAppend(reply);
}
async function streamAppend(full){
  const conv=conversations.find(c=>c.id===activeId);
  const b=document.createElement('div'); b.className='bubble'; b.textContent=''; msgs.appendChild(b);
  for(const ch of full){ b.textContent+=ch; msgs.scrollTop=msgs.scrollHeight; await new Promise(r=>setTimeout(r,12)); }
  conv.messages.push({role:'lucidian', text:b.textContent, ts:Date.now()}); save();
  if(speakReplies) speak(b.textContent);
}
sendBtn.onclick=()=>{const t=chat.value; chat.value=''; send(t);};
chat.addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendBtn.click();}});

/* mic: one-shot dictation into input */
micBtn.onclick=()=>{
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR) return alert('Speech Recognition not supported in this browser (use Chrome/Edge over HTTPS).');
  const r=new SR(); r.lang='en-US'; r.interimResults=false;
  r.onresult=e=>{ chat.value=e.results[0][0].transcript.trim(); };
  r.start();
};

/* Voice Studio (call mode) */
voiceBtn.onclick=()=>voiceModal.classList.add('open');
closeModal.onclick=()=>voiceModal.classList.remove('open');

function ensureRecognizer(){ const SR=window.SpeechRecognition||window.webkitSpeechRecognition; if(!SR) return null; const r=new SR(); r.lang='en-US'; r.interimResults=true; r.continuous=true; return r; }
function startRecognizer(){
  recognizer=ensureRecognizer(); if(!recognizer){ alert('Speech Recognition not supported in this browser.'); return; }
  recognizer.onresult=e=>{
    let final='', interim='';
    for(let i=e.resultIndex;i<e.results.length;i++){ const res=e.results[i]; if(res.isFinal) final+=res[0].transcript; else interim+=res[0].transcript; }
    chat.value=(final||interim).trim();
    if(final.trim()){ const text=final.trim(); chat.value=''; send(text); }
  };
  recognizer.onend=()=>{ if(callOn) recognizer.start(); };
  recognizer.start();
}
function stopRecognizer(){ try{ recognizer && recognizer.stop(); }catch{} }
function speak(text){ if(!('speechSynthesis' in window)) return; const u=new SpeechSynthesisUtterance(text); u.rate=1; u.pitch=1; u.volume=1; speechSynthesis.cancel(); speechSynthesis.speak(u); }
function setMeter(active){ clearInterval(meterTimer); if(!active){ meterBar.style.width='0%'; return; } meterTimer=setInterval(()=>{ const w=15+Math.random()*70; meterBar.style.width=w.toFixed(0)+'%'; },130); }

startCall.onclick=()=>{ callOn=true; speakReplies=true; document.body.classList.add('callOn'); voiceDot.style.display='inline-block'; startRecognizer(); setMeter(true); };
stopCall.onclick =()=>{ callOn=false; speakReplies=false; document.body.classList.remove('callOn'); voiceDot.style.display='none'; stopRecognizer(); speechSynthesis.cancel(); setMeter(false); };

/* mobile: tap outside closes drawer */
document.addEventListener('click',e=>{ if(window.innerWidth>=900) return; if(document.body.classList.contains('drawerOpen') && !sidebar.contains(e.target) && !document.querySelector('.hamburger').contains(e.target)){ document.body.classList.remove('drawerOpen'); }});
</script>
</body>
</html>
