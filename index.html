<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Lucidian â€” Interface</title>
<style>
  :root{
    --accent:#e8c66a; --accent-soft:rgba(232,198,106,.16);
    --text:#fff; --glass:rgba(0,0,0,.35); --glass-strong:rgba(0,0,0,.55);
    --sidebar-w: 320px; --bubble-max: 720px;
  }
  @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap');
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:'Montserrat',system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial,sans-serif;color:var(--text);background:#000;overflow:hidden;overscroll-behavior:none}

  /* â€”â€” COSMIC BACKGROUND â€”â€” */
  .space{position:fixed;inset:0;z-index:-2;background:
    radial-gradient(1200px 800px at 70% 30%, rgba(0,120,255,.10), transparent 60%),
    radial-gradient(900px 700px at 20% 70%, rgba(0,200,255,.08), transparent 60%),
    radial-gradient(600px 600px at 50% 50%, rgba(120,180,255,.06), transparent 70%), #000}
  .space:before{content:"";position:absolute;inset:0;pointer-events:none;opacity:.95;background-image:
    radial-gradient(1px 1px at 8% 12%, #fff 99%, transparent),
    radial-gradient(1px 1px at 16% 28%, #dfe9ff 99%, transparent),
    radial-gradient(1px 1px at 24% 52%, #bcd8ff 99%, transparent),
    radial-gradient(1px 1px at 32% 18%, #fff 99%, transparent),
    radial-gradient(1px 1px at 40% 66%, #dfe9ff 99%, transparent),
    radial-gradient(1px 1px at 48% 42%, #fff 99%, transparent),
    radial-gradient(1px 1px at 56% 74%, #bcd8ff 99%, transparent),
    radial-gradient(1px 1px at 64% 22%, #fff 99%, transparent),
    radial-gradient(1px 1px at 72% 58%, #dfe9ff 99%, transparent),
    radial-gradient(1px 1px at 80% 36%, #fff 99%, transparent),
    radial-gradient(1px 1px at 88% 70%, #bcd8ff 99%, transparent),
    radial-gradient(1px 1px at 94% 44%, #fff 99%, transparent);background-repeat:no-repeat}
  .stars,.stars:before,.stars:after,.stars2,.stars2:before,.stars2:after{position:absolute;content:"";top:-4000px;left:0;right:0;bottom:0;width:2px;height:2px;background:transparent;animation:drift var(--speed,260s) linear infinite;box-shadow: var(--starsA)}
  .stars{--speed:260s}
  .stars:before{transform:translateY(4000px) scale(.95);filter:brightness(.85);box-shadow: var(--starsB)}
  .stars:after{transform:translateY(8000px) scale(.9);filter:brightness(.7);box-shadow: var(--starsC)}
  .stars2{--speed:300s;box-shadow: var(--starsD)}
  .stars2:before{transform:translateY(4000px) scale(.95);filter:brightness(.9);box-shadow: var(--starsE)}
  .stars2:after{transform:translateY(8000px) scale(.9);filter:brightness(.75);box-shadow: var(--starsF)}
  @keyframes drift{from{transform:translateY(0)}to{transform:translateY(4000px)}}
  .nebula{position:absolute;inset:-10%;pointer-events:none;z-index:-1;background:
    radial-gradient(60% 50% at 60% 40%, rgba(90,150,255,.15), transparent 70%),
    radial-gradient(50% 45% at 30% 65%, rgba(120,220,255,.12), transparent 70%);filter:blur(30px) saturate(120%);animation:breathe 18s ease-in-out infinite}
  @keyframes breathe{0%,100%{transform:translateY(0)}50%{transform:translateY(1.5%)}}

  /* â€”â€” LAYOUT â€”â€” */
  .app{display:grid;grid-template-columns: var(--sidebar-w) 1fr;grid-template-rows:auto 1fr auto;height:100svh}
  header{grid-column:1/3;display:grid;grid-template-columns:1fr 220px;align-items:center;padding:6px 12px;background:var(--glass-strong);backdrop-filter:blur(8px)}
  h1{grid-column:1/2;justify-self:center;margin:2px 0 0;letter-spacing:12px;font-size:2.8rem;line-height:1;color:var(--accent);text-shadow:0 0 12px rgba(232,198,106,.45);white-space:nowrap}
  .crest{grid-column:2/3;justify-self:end;width:150px;margin-right:6px}
  .crest svg{width:100%;height:auto;display:block;filter:drop-shadow(0 0 10px rgba(232,198,106,.45))}
  .crest path{fill:none;stroke:var(--accent);stroke-width:1.8;stroke-linecap:round}
  .crest .glow{stroke:rgba(232,198,106,.35);stroke-width:4;filter:blur(1px)}
  aside{grid-row:2/4;background:var(--glass-strong);backdrop-filter:blur(8px);padding:12px;display:flex;flex-direction:column;gap:10px;min-width:0;overflow:hidden}
  .stack{display:flex;flex-direction:column;gap:8px}
  .new-chat{padding:10px;border:none;border-radius:8px;background:var(--accent);color:#000;font-weight:700;cursor:pointer}
  .row{display:flex;gap:8px}
  .label{opacity:.9;font-weight:700}
  .search input{flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.10);color:#fff}
  .search button{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.10);color:#fff;cursor:pointer}
  .list{overflow:auto;border:1px solid rgba(255,255,255,.15);border-radius:10px;background:rgba(255,255,255,.06)}
  .conv{padding:10px;border-bottom:1px solid rgba(255,255,255,.08);display:flex;justify-content:space-between;gap:8px;align-items:center}
  .conv.active{background:rgba(255,255,255,.12)}
  .conv .select{border:none;border-radius:6px;padding:4px 8px;background:var(--accent);color:#000;cursor:pointer;white-space:nowrap;flex-shrink:0}
  .conv span{min-width:0;overflow:hidden;text-overflow:ellipsis}
  main{position:relative;overflow:auto;padding:16px}

  /* â€”â€” CHAT BUBBLES â€”â€” */
  .msg-wrap{position:relative;display:flex}
  .message{display:inline-block;max-width:min(var(--bubble-max),68vw);padding:12px 16px;margin:10px 0;border-radius:14px;line-height:1.45;word-wrap:break-word;overflow-wrap:anywhere;border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.10);color:#fff}
  .left{margin-right:auto;border-color:var(--accent);background:var(--accent-soft);color:var(--accent);box-shadow:0 0 12px rgba(232,198,106,.18)}
  .right{margin-left:auto}
  .attachments{display:flex;gap:10px;flex-wrap:wrap;margin-top:6px}
  .thumb{width:140px;height:100px;border-radius:10px;overflow:hidden;border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.08);display:flex;align-items:center;justify-content:center}
  .thumb img{max-width:100%;max-height:100%;display:block}

  /* â€”â€” HOVER TOOLS â€”â€” */
  .msg-tools{
    position:absolute;top:-8px;right:0;transform:translateY(-100%);
    display:flex;gap:6px;background:rgba(0,0,0,.6);border:1px solid rgba(255,255,255,.25);
    padding:4px 6px;border-radius:8px;opacity:0;pointer-events:none;transition:.12s;
    backdrop-filter:blur(4px)
  }
  .msg-wrap:hover .msg-tools{opacity:1;pointer-events:auto}
  .tool-btn{border:none;border-radius:6px;padding:4px 6px;background:rgba(255,255,255,.12);color:#fff;cursor:pointer;font-size:.85rem}
  .tool-btn:hover{background:rgba(255,255,255,.18)}
  .msg-wrap.leftside .msg-tools{left:0;right:auto}

  footer{grid-column:1/3;display:flex;gap:10px;align-items:center;padding:10px;padding-bottom:calc(10px + env(safe-area-inset-bottom));background:var(--glass-strong)}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.10);color:#fff;cursor:pointer;white-space:nowrap}
  .btn.primary{background:var(--accent);color:#000;border:none;font-weight:700}
  input[type=text]{flex:1;padding:12px 14px;border-radius:10px;border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.10);color:#fff}

  /* â€”â€” MODALS â€”â€” */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:9999}
  .modal.open{display:flex}
  .card{width:min(900px,92vw);max-height:86vh;overflow:auto;background:var(--glass-strong);backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,.2);border-radius:16px;padding:16px}
  .card h2{margin:0 0 8px;color:var(--accent)}
  .lib-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
  .lib-item{border:1px solid rgba(255,255,255,.2);border-radius:12px;padding:10px;background:rgba(255,255,255,.06)}
  .lib-item img{width:100%;height:140px;object-fit:cover;border-radius:8px;margin-bottom:8px}
  .lib-item a{color:var(--accent);text-decoration:none}
  .edit-area{width:min(760px,90vw);height:180px;border-radius:12px;border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.08);color:#fff;padding:12px;resize:vertical}

  /* â€”â€” MOBILE â€”â€” */
  @media (max-width: 900px){
    :root{ --sidebar-w: 82vw; }
    .app{grid-template-columns:1fr;grid-template-rows:auto 1fr auto}
    aside{position:fixed;z-index:11;left:0;top:0;bottom:0;width:var(--sidebar-w);transform:translateX(-100%);transition:.2s ease;box-shadow:8px 0 30px rgba(0,0,0,.6)}
    aside.open{transform:none}
    .openHist{position:fixed;left:10px;top:10px;z-index:12;border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.1);color:#fff;border-radius:8px;padding:8px 10px;cursor:pointer;display:block}
    h1{font-size:2.1rem;letter-spacing:10px}
    .crest{width:128px}
    .message{max-width:90vw}
    footer{grid-column:1/2}
  }
  .openHist{display:none}
</style>
</head>
<body>
  <div class="space">
    <div class="stars"></div><div class="stars2"></div><div class="nebula"></div>
  </div>

  <button class="openHist" id="openHist">History</button>

  <div class="app">
    <header>
      <h1>L U C I D I A N</h1>
      <div class="crest" aria-label="Lucidian Crest" title="Lucidian symbol">
        <svg viewBox="0 0 200 200" role="img" xmlns="http://www.w3.org/2000/svg">
          <circle class="glow" cx="100" cy="100" r="86" />
          <g transform="translate(100,100)">
            <defs><path id="petal" d="M0,-80 C22,-80 40,-62 40,-40 C40,-18 22,0 0,0 C-22,0 -40,-18 -40,-40 C-40,-62 -22,-80 0,-80 Z" /></defs>
            <g opacity="0.95">
              <use href="#petal" transform="rotate(0)" /><use href="#petal" transform="rotate(15)" /><use href="#petal" transform="rotate(30)" />
              <use href="#petal" transform="rotate(45)" /><use href="#petal" transform="rotate(60)" /><use href="#petal" transform="rotate(75)" />
              <use href="#petal" transform="rotate(90)" /><use href="#petal" transform="rotate(105)" /><use href="#petal" transform="rotate(120)" />
              <use href="#petal" transform="rotate(135)" /><use href="#petal" transform="rotate(150)" /><use href="#petal" transform="rotate(165)" />
              <use href="#petal" transform="rotate(180)" /><use href="#petal" transform="rotate(195)" /><use href="#petal" transform="rotate(210)" />
              <use href="#petal" transform="rotate(225)" /><use href="#petal" transform="rotate(240)" /><use href="#petal" transform="rotate(255)" />
              <use href="#petal" transform="rotate(270)" /><use href="#petal" transform="rotate(285)" /><use href="#petal" transform="rotate(300)" />
              <use href="#petal" transform="rotate(315)" /><use href="#petal" transform="rotate(330)" /><use href="#petal" transform="rotate(345)" />
            </g>
          </g>
        </svg>
      </div>
    </header>

    <aside id="sidebar">
      <div class="stack">
        <button class="new-chat" id="newChat">New</button>
        <div class="label">Library</div>
        <button class="btn" id="openLibrary">Open</button>
        <div class="label" style="margin-top:6px">Search</div>
        <div class="row search">
          <input id="search" type="text" placeholder="Search conversations..." />
          <button id="searchBtn">Go</button>
        </div>
      </div>
      <div class="list" id="convList"></div>
    </aside>

    <main id="chat"></main>

    <footer>
      <label class="btn" for="file">Attach</label>
      <input id="file" type="file" multiple hidden />
      <button class="btn" id="mic" title="Dictate into the box">ðŸŽ¤ Mic</button>
      <input id="text" type="text" placeholder="Type a message..." />
      <button class="btn primary" id="send">Send</button>
      <button class="btn" id="voiceStudio" title="Open Voice Studio">Voice</button>
    </footer>
  </div>

  <!-- Voice Studio Modal -->
  <div class="modal" id="modal">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h2>Lucidian â€” Voice Call</h2>
        <button class="btn" id="closeModal">Close</button>
      </div>
      <div class="controls"><button class="btn primary" id="callToggle">Start call</button></div>
      <div class="wave" id="wave" style="height:84px;background:rgba(255,255,255,.08);border-radius:10px;position:relative;overflow:hidden"></div>
      <p style="opacity:.85;margin-top:8px">In call mode, your mic transcribes and autoâ€‘sends on pauses; Lucidian speaks replies. Stop ends mic + speech.</p>
    </div>
  </div>

  <!-- Shared Library Modal -->
  <div class="modal" id="libModal">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h2>Shared Library</h2><button class="btn" id="closeLib">Close</button>
      </div>
      <div class="lib-grid" id="libGrid"></div>
    </div>
  </div>

  <!-- Edit Message Modal -->
  <div class="modal" id="editModal">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h2>Edit your message</h2>
        <button class="btn" id="cancelEdit">Cancel</button>
      </div>
      <textarea id="editArea" class="edit-area" placeholder="Edit text..."></textarea>
      <div style="margin-top:10px;display:flex;gap:8px;justify-content:flex-end">
        <button class="btn primary" id="saveEdit">Save</button>
      </div>
    </div>
  </div>

<script>
/* ---------- STARS ---------- */
function rand(n){return Math.floor(Math.random()*n)}
function makeStars(count){const a=[];for(let i=0;i<count;i++){const x=rand(2000)+"px "+rand(4000)+"px ";const c=Math.random();const col=c>.7?'#fff':(c>.4?'#dfe9ff':'#bcd8ff');a.push(x+col);}return a.join(', ')}
const root=document.documentElement;
root.style.setProperty('--starsA', makeStars(600));
root.style.setProperty('--starsB', makeStars(600));
root.style.setProperty('--starsC', makeStars(600));
root.style.setProperty('--starsD', makeStars(700));
root.style.setProperty('--starsE', makeStars(700));
root.style.setProperty('--starsF', makeStars(700));

/* ---------- STATE ---------- */
const chatEl=document.getElementById('chat');
const inputEl=document.getElementById('text');
const fileEl=document.getElementById('file');
const sendBtn=document.getElementById('send');
const micBtn=document.getElementById('mic');
const convList=document.getElementById('convList');
const newChatBtn=document.getElementById('newChat');
const searchEl=document.getElementById('search');
const searchBtn=document.getElementById('searchBtn');
const sidebar=document.getElementById('sidebar');
const openHist=document.getElementById('openHist');

const libModal=document.getElementById('libModal');
const libGrid=document.getElementById('libGrid');
document.getElementById('openLibrary').onclick=()=>{ buildLibrary(); libModal.classList.add('open'); };
document.getElementById('closeLib').onclick=()=> libModal.classList.remove('open');

const editModal=document.getElementById('editModal');
const editArea=document.getElementById('editArea');
document.getElementById('cancelEdit').onclick=()=>{ editModal.classList.remove('open'); editingKey=null; };
document.getElementById('saveEdit').onclick=saveEditedMessage;

let conversations=JSON.parse(localStorage.getItem('lucidian_convs')||'[]');
let activeId=localStorage.getItem('lucidian_active')||null;
let pendingFiles=[];
let editingKey=null; // {id, idx}

/* ---------- helpers ---------- */
function save(){localStorage.setItem('lucidian_convs', JSON.stringify(conversations));}
function setActive(id){activeId=id;localStorage.setItem('lucidian_active', id);renderList();renderChat();if(window.innerWidth<900)sidebar.classList.remove('open');}
function createConversation(){const id=Date.now().toString();conversations.unshift({id,title:'New Conversation',messages:[]});save();setActive(id);}
function renderList(filter=''){convList.innerHTML='';conversations.filter(c=>(c.title||'').toLowerCase().includes(filter.toLowerCase())||(c.messages||[]).some(m=>(m.text||'').toLowerCase().includes(filter.toLowerCase()))).forEach(c=>{const d=document.createElement('div');d.className='conv'+(c.id===activeId?' active':'');const span=document.createElement('span');span.textContent=c.title||'Untitled';span.style.flex='1';const sel=document.createElement('button');sel.textContent='Select';sel.className='select';sel.onclick=()=>setActive(c.id);d.appendChild(span);d.appendChild(sel);convList.appendChild(d);});}

function speak(text){ if(!text) return; try{ if('speechSynthesis' in window){ speechSynthesis.cancel(); const u=new SpeechSynthesisUtterance(text); speechSynthesis.speak(u);} }catch{} }
async function copyText(text){ try{ await navigator.clipboard.writeText(text||''); }catch(e){ /* ignore */ } }

/* ---------- build bubble + tools ---------- */
function msgToolsHTML(role, idx){
  const canEdit = role==='user';
  return `
    <div class="msg-tools">
      <button class="tool-btn" data-act="copy" data-idx="${idx}">Copy</button>
      ${canEdit?`<button class="tool-btn" data-act="edit" data-idx="${idx}">Edit</button>`:''}
      <button class="tool-btn" data-act="read" data-idx="${idx}">Read</button>
    </div>`;
}
function bubbleDOM(text, side, files, idx, role){
  const wrap=document.createElement('div'); wrap.className='msg-wrap '+(side==='left'?'leftside':'rightside');
  wrap.innerHTML = msgToolsHTML(role, idx);
  const d=document.createElement('div'); d.className='message '+(side==='left'?'left':'right'); d.textContent=text||'';
  if(files && files.length){
    const at=document.createElement('div'); at.className='attachments';
    files.forEach(f=>{ const t=document.createElement('div'); t.className='thumb';
      if(f.type && f.type.startsWith('image/')){ const img=new Image(); img.src=f.url; t.appendChild(img); }
      else{ t.textContent=f.name||'file'; }
      at.appendChild(t);
    });
    d.appendChild(at);
  }
  wrap.appendChild(d);
  return wrap;
}
function renderChat(){
  chatEl.innerHTML='';
  const conv=conversations.find(c=>c.id===activeId);
  if(!conv){createConversation();return;}
  (conv.messages||[]).forEach((m,i)=>{
    chatEl.appendChild(bubbleDOM(m.text, m.role==='user'?'right':'left', m.files, i, m.role));
  });
  chatEl.scrollTop=chatEl.scrollHeight;
}

/* ---------- Library ---------- */
function buildLibrary(){
  libGrid.innerHTML='';
  const all=[];
  conversations.forEach(c=>{(c.messages||[]).forEach(m=>{(m.files||[]).forEach(f=>all.push({conv:c.title||'Untitled',...f}))})});
  (pendingFiles||[]).forEach(f=>all.push({conv:'(unsent)',...f}));
  if(!all.length){libGrid.innerHTML='<div style="opacity:.8">No shared items yet.</div>';return;}
  all.forEach(item=>{
    const d=document.createElement('div'); d.className='lib-item';
    if(item.type?.startsWith('image/')){const img=document.createElement('img');img.src=item.url;d.appendChild(img);}
    const meta=document.createElement('div');
    meta.innerHTML=`<div>${item.name||'file'}</div><div style="opacity:.8">in <em>${item.conv}</em></div>
      <div><a href="${item.url}" target="_blank" download="${item.name||'file'}">Download</a></div>`;
    d.appendChild(meta); libGrid.appendChild(d);
  });
}

/* ---------- messages ---------- */
function addMessage(role,text,files){
  const conv=conversations.find(c=>c.id===activeId); if(!conv) return;
  conv.messages.push({role,text,files});
  if((conv.title==='New Conversation'||!conv.title)&&role==='user'&&(text||'').trim()){
    conv.title=text.slice(0,42)+(text.length>42?'â€¦':'');
  }
  save(); renderChat();
}
async function fakeLucidianReply(userText){
  const response='Echoing intention: '+(userText||'listening.');
  const conv=conversations.find(c=>c.id===activeId); if(!conv) return;
  conv.messages.push({role:'lucidian',text:response}); save(); renderChat();
}

/* ---------- Attachments ---------- */
fileEl.onchange=()=>{
  pendingFiles=Array.from(fileEl.files).map(f=>({name:f.name,type:f.type,url:URL.createObjectURL(f)}));
  if(pendingFiles.length){ const conv=conversations.find(c=>c.id===activeId); if(!conv){createConversation();return;}
    conv.messages.push({role:'user',text:'(attachments queued)',files:pendingFiles}); save(); renderChat();
  }
};

/* ---------- Send flow ---------- */
sendBtn.onclick=async ()=>{
  const text=inputEl.value.trim(); const files=pendingFiles;
  if(!text && !files.length) return;
  addMessage('user', text, files);
  inputEl.value=''; pendingFiles=[];
  await fakeLucidianReply(text);
};
inputEl.addEventListener('keydown',(e)=>{ if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); sendBtn.click(); }});

/* ---------- Sidebar & mobile ---------- */
newChatBtn.onclick=createConversation;
searchBtn.onclick=()=>renderList(searchEl.value);
searchEl.addEventListener('keydown',e=>{ if(e.key==='Enter'){ renderList(searchEl.value); }});
openHist.onclick=()=>sidebar.classList.toggle('open');

/* ---------- Hover tool actions (copy / edit / read) ---------- */
chatEl.addEventListener('click', (e)=>{
  const btn=e.target.closest('.tool-btn'); if(!btn) return;
  const act=btn.dataset.act; const idx=parseInt(btn.dataset.idx,10);
  const conv=conversations.find(c=>c.id===activeId); if(!conv) return;
  const msg=conv.messages[idx]; if(!msg) return;

  if(act==='copy'){ copyText(msg.text); }
  if(act==='read'){ speak(msg.text); }
  if(act==='edit' && msg.role==='user'){
    editingKey={ id:activeId, idx };
    editArea.value = msg.text || '';
    editModal.classList.add('open');
    setTimeout(()=>editArea.focus(),0);
  }
});
function saveEditedMessage(){
  if(!editingKey) return;
  const conv=conversations.find(c=>c.id===editingKey.id); if(!conv) return;
  const msg=conv.messages[editingKey.idx]; if(!msg || msg.role!=='user') return;
  msg.text = editArea.value||'';
  // keep title fresh if it was first user message
  if(editingKey.idx===0 && conv.title && conv.title!=='New Conversation'){
    conv.title = msg.text.slice(0,42)+(msg.text.length>42?'â€¦':'');
  }
  save(); renderChat();
  editModal.classList.remove('open'); editingKey=null;
}

/* ---------- Voice Studio (call mode) ---------- */
const modal=document.getElementById('modal');
const callToggle=document.getElementById('callToggle');
const closeModal=document.getElementById('closeModal');
const wave=document.getElementById('wave');
document.getElementById('voiceStudio').onclick=()=>{ modal.classList.add('open'); };
closeModal.onclick=()=>{ modal.classList.remove('open'); stopCall(); };
for(let i=0;i<70;i++){ const b=document.createElement('div'); b.style.cssText='position:absolute;bottom:0;width:6px;background:var(--accent);left:0;animation:bars 1s ease-in-out infinite'; b.style.left=(i*10)+'px'; b.style.animationDelay=(Math.random()*1)+'s'; wave.appendChild(b); }
const style=document.createElement('style'); style.textContent='@keyframes bars{0%,100%{height:15%}50%{height:85%}}'; document.head.appendChild(style);

let recognition, recognizing=false, silenceTimer=null, callActive=false;
if('webkitSpeechRecognition' in window || 'SpeechRecognition' in window){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  recognition=new SR(); recognition.lang='en-US'; recognition.continuous=true; recognition.interimResults=true;
  recognition.onresult=(e)=>{ let final=''; for(let i=0;i<e.results.length;i++){ const r=e.results[i]; if(r.isFinal) final+=r[0].transcript; }
    if(final){ inputEl.value=(inputEl.value?'':'')+final; } };
  recognition.onend=()=>{ if(callActive){ recognition.start(); } else { recognizing=false; } };
}
/* Mic = manual dictate only (no auto-send, no clearing) */
micBtn.onclick=()=>{ if(!recognition){ alert('Speech Recognition not supported in this browser.'); return; }
  if(!recognizing){ recognition.start(); recognizing=true; micBtn.classList.add('on'); }
  else{ recognition.stop(); recognizing=false; micBtn.classList.remove('on'); } };
function startCall(){ if(!recognition){ alert('Speech Recognition not supported in this browser.'); return; }
  callActive=true; callToggle.textContent='Stop call'; if(!recognizing){ recognition.start(); recognizing=true; }
  recognition.onresult=(e)=>{ let txt=''; for(let i=0;i<e.results.length;i++){ const r=e.results[i]; if(r.isFinal) txt+=r[0].transcript; }
    if(txt){ inputEl.value=txt; clearTimeout(silenceTimer); silenceTimer=setTimeout(()=>{ if(inputEl.value.trim()){ sendBtn.click(); } },1200); } }; }
function stopCall(){ callActive=false; callToggle.textContent='Start call'; clearTimeout(silenceTimer); if(recognition){ try{ recognition.stop(); }catch{} } recognizing=false; if('speechSynthesis' in window){ speechSynthesis.cancel(); } }
callToggle.onclick=()=> callActive? stopCall() : startCall();

/* ---------- PWA ---------- */
if('serviceWorker' in navigator){
  const swCode=`self.addEventListener('install', e=>{ self.skipWaiting(); e.waitUntil(caches.open('lucidian-v3').then(c=>c.addAll(['./']))); });
  self.addEventListener('fetch', e=>{ e.respondWith(caches.match(e.request).then(r=> r || fetch(e.request))); });`;
  const blob=new Blob([swCode],{type:'text/javascript'}); const swUrl=URL.createObjectURL(blob); navigator.serviceWorker.register(swUrl);
}
const manifest={name:'Lucidian',short_name:'Lucidian',start_url:'./',display:'standalone',background_color:'#000',theme_color:'#000',icons:[]};
const mBlob=new Blob([JSON.stringify(manifest)],{type:'application/json'}); const mUrl=URL.createObjectURL(mBlob);
const link=document.createElement('link'); link.rel='manifest'; link.href=mUrl; document.head.appendChild(link);

/* ---------- Boot ---------- */
if(!activeId && conversations.length){ activeId=conversations[0].id; }
if(!conversations.length){ createConversation(); } else { renderList(); renderChat(); }
</script>
</body>
</html>
