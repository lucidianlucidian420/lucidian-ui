<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Lucidian</title>
<style>
  :root{
    --brand-gold:#f2cf66; --brand-gold-soft:rgba(242,207,102,.25);
    --ink:#d9dde7; --bg-top:#0f1217; --bg-deep:#0a1017;
    --bubble-user:rgba(60,64,72,.85); --bubble-ai:rgba(240,210,90,.15);
    --symbol-size:74px; --header-h:84px; --sidebar-w:320px; --rad:14px;
    --shadow:0 8px 30px rgba(0,0,0,.55);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:radial-gradient(1200px 800px at 50% 40%,#113049 0%,#0d2132 40%,var(--bg-deep) 100%);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica Neue,Arial}
  body{overflow:hidden}
  .hidden{display:none!important}

  .app{position:relative;height:100%;width:100%;display:grid;grid-template-rows:var(--header-h) 1fr auto}

  /* header */
  .header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,rgba(15,18,23,.95),rgba(15,18,23,.86));border-bottom:1px solid rgba(255,255,255,.06);display:grid;grid-template-columns:auto 1fr auto;align-items:center;padding:0 16px}
  .settings-btn{background:rgba(255,255,255,.06);color:var(--ink);border:1px solid rgba(255,255,255,.12);padding:8px 10px;border-radius:10px;cursor:pointer}
  .brand{display:flex;align-items:center;justify-content:center;font-weight:800;letter-spacing:.48rem;color:var(--brand-gold);font-size:32px;user-select:none}
  .brand-symbol{width:var(--symbol-size);height:var(--symbol-size);min-width:var(--symbol-size);min-height:var(--symbol-size);border-radius:9999px;margin-left:10px;background:radial-gradient(circle at 50% 50%,rgba(242,207,102,.9),rgba(242,207,102,.35) 40%,rgba(242,207,102,.08) 68%,transparent 70%);box-shadow:0 0 18px rgba(242,207,102,.55), inset 0 0 18px rgba(242,207,102,.25)}
  .brand-wrap{display:flex;align-items:center;justify-content:center}

  /* stars */
  #stars{position:absolute;inset:0;z-index:0;pointer-events:none}

  /* main row */
  .main{position:relative;display:grid;grid-template-columns:var(--sidebar-w) 1fr;height:100%;z-index:1}

  /* sidebar */
  .sidebar{height:100%;overflow:hidden;border-right:1px solid rgba(255,255,255,.06);background:linear-gradient(180deg,rgba(15,18,23,.86),rgba(15,18,23,.66));padding:12px}
  .sidebar-scroll{height:100%;overflow:auto;padding-right:4px}
  .section-label{font-size:12px;opacity:.75;margin:8px 4px}
  .row{display:flex;gap:8px;align-items:center;margin-bottom:10px}
  .btn{background:linear-gradient(180deg,rgba(242,207,102,.95),rgba(242,207,102,.85));color:#2b2300;border:0;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer;box-shadow:0 2px 0 rgba(0,0,0,.3)}
  .btn.secondary{background:rgba(255,255,255,.06);color:var(--ink);border:1px solid rgba(255,255,255,.12);font-weight:600}
  .input{flex:1;background:rgba(0,0,0,.25);border:1px solid rgba(255,255,255,.12);color:var(--ink);padding:10px 12px;border-radius:12px}
  .conv{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:8px;border-radius:10px;background:rgba(0,0,0,.2);border:1px solid rgba(255,255,255,.06);margin-bottom:8px}
  .conv .title{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .mini{display:flex;gap:6px}
  .pill{padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.05);cursor:pointer}
  .pill.danger{background:rgba(240,70,70,.18);border-color:rgba(240,70,70,.35);color:#ffdada}

  /* chat */
  .chat-wrap{position:relative;height:100%;overflow:auto;padding:18px 18px 110px}
  .chat{max-width:1100px;margin:0 auto;position:relative}
  .row-bubble{display:flex}
  .row-bubble.me{justify-content:flex-end}
  .row-bubble.ai{justify-content:flex-start}
  .bubble{display:inline-block;max-width:70%;margin:10px 12px;padding:12px 14px;border-radius:14px;line-height:1.35;backdrop-filter:blur(3px);position:relative;word-break:break-word;white-space:pre-wrap}
  .ai{background:var(--bubble-ai);border:1px solid var(--brand-gold-soft);color:var(--ink)}
  .me{background:var(--bubble-user);border:1px solid rgba(255,255,255,.12);color:var(--ink)}
  .actions{position:absolute;right:-6px;top:-32px;display:flex;gap:6px;opacity:0;pointer-events:none;transition:.12s}
  .bubble:hover .actions{opacity:1;pointer-events:auto}
  .action{font-size:12px;padding:6px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.45);cursor:pointer}

  .composer{position:sticky;bottom:0;z-index:10;background:linear-gradient(180deg,rgba(15,18,23,0),rgba(15,18,23,.9));border-top:1px solid rgba(255,255,255,.06);padding:10px 14px}
  .composer-row{max-width:1100px;margin:0 auto;display:flex;gap:8px}
  .composer .btn,.composer .input{height:44px}

  /* scroll to bottom pill */
  #toBottom{position:fixed;right:22px;bottom:120px;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.18);cursor:pointer;z-index:15;display:none}

  /* settings (profile) panel */
  #overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);backdrop-filter:blur(2px);z-index:1600;display:none}
  #panel{position:fixed;top:82px;left:16px;width:min(420px,calc(100vw - 32px));max-height:min(80vh,900px);overflow:auto;padding:16px;border-radius:12px;background:rgba(20,20,22,.92);border:1px solid var(--brand-gold-soft);box-shadow:var(--shadow);z-index:1700;display:none}
  .tabs{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px}
  .tab{padding:6px 10px;border-radius:10px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);cursor:pointer}
  .tab.act{background:rgba(242,207,102,.15);border-color:rgba(242,207,102,.35)}
  .field{display:flex;flex-direction:column;gap:6px;margin:10px 0}
  .field input,.field select{background:rgba(0,0,0,.25);border:1px solid rgba(255,255,255,.14);color:var(--ink);padding:10px 12px;border-radius:10px}

  /* library modal */
  #libModal{position:fixed;inset:0;z-index:1500;display:none;align-items:center;justify-content:center}
  #libScrim{position:absolute;inset:0;background:rgba(0,0,0,.45);backdrop-filter:blur(2px)}
  #libCard{position:relative;width:min(880px,92vw);max-height:min(70vh,800px);overflow:auto;padding:16px;border-radius:16px;background:rgba(18,19,23,.95);border:1px solid rgba(255,255,255,.12);box-shadow:var(--shadow)}
  .lib-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
  .lib-item{border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);border-radius:12px;padding:10px}
  .close-x{position:absolute;right:14px;top:12px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.18);border-radius:10px;padding:6px 10px;cursor:pointer}

  /* voice call */
  #call{position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(2px);display:none;align-items:center;justify-content:center;z-index:1800}
  .call-card{background:#0d1324;border:1px solid rgba(255,255,255,.1);padding:24px;border-radius:18px;text-align:center}
  #meterWrap{width:160px;height:160px;border-radius:9999px;margin:0 auto;background:radial-gradient(ellipse at center, rgba(102,153,255,.2), rgba(102,153,255,.05));display:grid;place-items:center}
  #meter{width:110px;height:110px;border-radius:9999px;background:rgba(255,255,255,.2);transition:transform .08s linear}

  /* auth screen */
  #auth{min-height:100%;display:grid;place-items:center;padding:24px}
  .card{width:min(460px,92vw);background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:16px}

  /* responsive */
  @media (max-width:1024px){
    .main{grid-template-columns:1fr}
    .sidebar{position:fixed;z-index:1200;top:var(--header-h);left:0;height:calc(100% - var(--header-h));width:min(86vw,360px);transform:translateX(-110%);transition:transform .18s}
    .sidebar.open{transform:translateX(0)}
    .chat-wrap{padding:16px 12px 100px}
    .bubble{max-width:86%}
  }
</style>
</head>
<body>

<!-- AUTH -->
<div id="auth">
  <div class="card">
    <h2 style="margin:6px 0 12px 0;text-align:center;color:var(--brand-gold)">L U C I D I A N</h2>
    <div style="display:flex;gap:6px;margin-bottom:10px">
      <button id="modeLogin" class="tab act">Log in</button>
      <button id="modeReg" class="tab">Create account</button>
    </div>
    <div class="field"><label>Email <input id="aEmail" type="email"></label></div>
    <div class="field"><label>Password <input id="aPass" type="password"></label></div>
    <div id="extraReg" class="hidden">
      <div class="field"><label>Name <input id="aName" type="text"></label></div>
      <div class="field"><label>Phone <input id="aPhone" type="tel"></label></div>
      <div class="field"><label>Confirm password <input id="aPass2" type="password"></label></div>
    </div>
    <button id="authGo" class="btn" style="width:100%;margin-top:8px">Continue</button>
  </div>
</div>

<!-- APP -->
<div id="app" class="app hidden">
  <!-- Header -->
  <div class="header">
    <button id="settingsBtn" class="settings-btn">Settings</button>
    <div class="brand-wrap"><div class="brand">L U C I D I A N</div></div>
    <div class="brand-symbol" aria-hidden="true"></div>
  </div>

  <!-- Stars -->
  <canvas id="stars"></canvas>

  <!-- Main -->
  <div class="main">
    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar">
      <div class="sidebar-scroll">
        <div class="section-label" data-i18n="profile">Profile</div>
        <div class="row">
          <button id="newConv" class="btn" style="flex:1;" data-i18n="new">New</button>
        </div>

        <div class="row" style="margin-top:14px;">
          <div class="section-label" style="margin:0" data-i18n="library">Library</div>
          <button id="openLibrary" class="btn secondary" style="margin-left:auto;" data-i18n="libraryBtn">Library</button>
        </div>

        <div class="section-label" style="margin-top:14px;" data-i18n="search">Search</div>
        <div class="row">
          <input id="searchBox" class="input" placeholder="Search conversations..." data-i18n-ph="searchPH" />
          <button id="searchGo" class="btn secondary" data-i18n="go">Go</button>
        </div>

        <div id="convList"></div>
      </div>
    </aside>

    <!-- Chat -->
    <div id="chatWrap" class="chat-wrap">
      <div id="chat" class="chat"></div>
    </div>
  </div>

  <!-- Composer -->
  <div class="composer">
    <div class="composer-row">
      <button id="attach" class="btn secondary" data-i18n="attach">Attach</button>
      <button id="mic" class="btn secondary" data-i18n="mic">üéôÔ∏è Mic</button>
      <input id="msg" class="input" placeholder="Type a message..." data-i18n-ph="typePH" />
      <button id="send" class="btn" data-i18n="send">Send</button>
      <button id="voice" class="btn secondary" data-i18n="voice">Voice</button>
    </div>
  </div>
</div>

<!-- scroll-down pill -->
<button id="toBottom">‚Üì</button>

<!-- Settings panel -->
<div id="overlay"></div>
<div id="panel">
  <div class="tabs">
    <button class="tab act" data-tab="acct" data-i18n="account">Account</button>
    <button class="tab" data-tab="prefs" data-i18n="preferences">Preferences</button>
    <button class="tab" data-tab="mems" data-i18n="memories">Memories</button>
    <button class="tab" data-tab="conns" data-i18n="connectors">Connectors</button>
    <button class="tab" data-tab="danger" data-i18n="deleteAccount">Delete account</button>
    <button class="tab" id="signOut" data-i18n="signOut">Sign out</button>
  </div>

  <!-- Account -->
  <div class="tabpane" id="p-acct">
    <div class="field"><label>Name <input id="profName" type="text"></label></div>
    <div class="field"><label>Email <input id="profEmail" type="email"></label></div>
    <div class="field"><label>Phone <input id="profPhone" type="tel"></label></div>
    <div class="field"><label>Password <input id="profPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></label></div>
    <button id="profSave" class="btn" data-i18n="save">Save</button>
  </div>

  <!-- Preferences -->
  <div class="tabpane hidden" id="p-prefs">
    <div class="field">
      <label>UI language
        <select id="langSel">
          <option value="en">English</option>
          <option value="es">Espa√±ol</option>
        </select>
      </label>
    </div>
    <div style="opacity:.75;font-size:13px">Changes labels instantly.</div>
  </div>

  <!-- Memories -->
  <div class="tabpane hidden" id="p-mems">
    <div class="row"><button id="addMem" class="btn" data-i18n="addMemory">Add memory</button></div>
    <div id="memList"></div>
  </div>

  <!-- Connectors -->
  <div class="tabpane hidden" id="p-conns">
    <div class="field"><label>Gmail <input id="c-gmail" type="url" placeholder="https://mail.google.com/‚Ä¶"></label></div>
    <div class="field"><label>Google Drive <input id="c-drive" type="url" placeholder="https://drive.google.com/‚Ä¶"></label></div>
    <div class="field"><label>Google Docs <input id="c-docs" type="url"></label></div>
    <div class="field"><label>Google Calendar <input id="c-cal" type="url"></label></div>
    <div class="field"><label>Dropbox <input id="c-dropbox" type="url"></label></div>
    <div class="field"><label>Box <input id="c-box" type="url"></label></div>
    <div class="field"><label>Notion <input id="c-notion" type="url"></label></div>
    <button id="saveConns" class="btn" data-i18n="save">Save</button>
  </div>

  <!-- Danger -->
  <div class="tabpane hidden" id="p-danger">
    <p>Removes your local data on this device (demo auth).</p>
    <button id="deleteAcct" class="btn secondary" style="border-color:#f66;color:#ffdada">Delete account</button>
  </div>
</div>

<!-- Library -->
<div id="libModal">
  <div id="libScrim"></div>
  <div id="libCard">
    <button id="libClose" class="close-x">Close</button>
    <h3 style="margin:0 0 12px 0" data-i18n="sharedLib">Shared Library</h3>
    <div id="libGrid" class="lib-grid"></div>
  </div>
</div>

<!-- Voice call -->
<div id="call">
  <div class="call-card">
    <div id="callLabel" style="margin-bottom:10px">Voice ‚Ä¢ Live</div>
    <div id="meterWrap"><div id="meter"></div></div>
    <div class="row" style="justify-content:center;margin-top:12px">
      <button id="endCall" class="btn secondary">End call</button>
    </div>
  </div>
</div>

<script>
/* ==================== i18n ==================== */
const I18N = {
  en:{profile:'Profile',new:'New',library:'Library',libraryBtn:'Library',search:'Search',searchPH:'Search conversations‚Ä¶',go:'Go',attach:'Attach',mic:'üéôÔ∏è Mic',typePH:'Type a message‚Ä¶',send:'Send',voice:'Voice',account:'Account',preferences:'Preferences',memories:'Memories',connectors:'Connectors',deleteAccount:'Delete account',signOut:'Sign out',save:'Save',addMemory:'Add memory',sharedLib:'Shared Library'},
  es:{profile:'Perfil',new:'Nuevo',library:'Biblioteca',libraryBtn:'Biblioteca',search:'Buscar',searchPH:'Buscar conversaciones‚Ä¶',go:'Ir',attach:'Adjuntar',mic:'üéôÔ∏è Micr√≥fono',typePH:'Escribe un mensaje‚Ä¶',send:'Enviar',voice:'Voz',account:'Cuenta',preferences:'Preferencias',memories:'Memorias',connectors:'Conectores',deleteAccount:'Eliminar cuenta',signOut:'Cerrar sesi√≥n',save:'Guardar',addMemory:'Agregar memoria',sharedLib:'Biblioteca compartida'}
};
let lang = localStorage.getItem('lang') || 'en';
function applyI18n(){
  const dict = I18N[lang];
  document.querySelectorAll('[data-i18n]').forEach(n=>{ n.textContent = dict[n.dataset.i18n] || n.textContent; });
  document.querySelectorAll('[data-i18n-ph]').forEach(n=>{ n.placeholder = dict[n.dataset.i18nPh] || n.placeholder; });
}
function setLang(v){ lang=v; localStorage.setItem('lang',v); applyI18n(); }

/* ==================== auth (demo) ==================== */
const $ = s=>document.querySelector(s);
const auth = {
  users: JSON.parse(localStorage.getItem('users')||'[]'),
  get current(){ return JSON.parse(localStorage.getItem('currentUser')||'null'); },
  set current(u){ if(u) localStorage.setItem('currentUser',JSON.stringify(u)); else localStorage.removeItem('currentUser'); },
  login(email,pass){ const u=this.users.find(x=>x.email===email && x.pass===pass); if(!u) throw new Error('Invalid credentials'); this.current=u; },
  register({name,email,phone,pass}){ if(this.users.some(x=>x.email===email)) throw new Error('Email in use'); const u={id:crypto.randomUUID(),name,email,phone,pass}; this.users.push(u); localStorage.setItem('users',JSON.stringify(this.users)); this.current=u; },
  logout(){ this.current=null; }
};

/* ==================== state ==================== */
const state = {
  get uid(){ return auth.current?.id || 'anon'; },
  get key(){ return id => `${this.uid}:${id}`; },
  get convs(){ return JSON.parse(localStorage.getItem(this.key('convs'))||'[]'); },
  set convs(v){ localStorage.setItem(this.key('convs'),JSON.stringify(v)); },
  get library(){ return JSON.parse(localStorage.getItem(this.key('lib'))||'[]'); },
  set library(v){ localStorage.setItem(this.key('lib'),JSON.stringify(v)); },
  get profile(){ return JSON.parse(localStorage.getItem(this.key('profile'))||'{}'); },
  set profile(v){ localStorage.setItem(this.key('profile'),JSON.stringify(v)); },
  get mems(){ return JSON.parse(localStorage.getItem(this.key('mems'))||'[]'); },
  set mems(v){ localStorage.setItem(this.key('mems'),JSON.stringify(v)); },
  get conns(){ return JSON.parse(localStorage.getItem(this.key('conns'))||'{}'); },
  set conns(v){ localStorage.setItem(this.key('conns'),JSON.stringify(v)); },
  currentConvId:null
};

/* ==================== stars ==================== */
(function stars(){
  const c = $('#stars'), ctx = c.getContext('2d');
  function resize(){ c.width = innerWidth; c.height = innerHeight; }
  resize();
  const density = (c.width*c.height)/8000; // more stars
  const stars = Array.from({length:Math.round(density)}, ()=>({x:Math.random()*c.width,y:Math.random()*c.height,z:Math.random()*0.7+0.3,tw:Math.random()*0.7+0.3}));
  function tick(){
    ctx.clearRect(0,0,c.width,c.height);
    for(const s of stars){
      const size = s.z*1.5;
      ctx.fillStyle = `rgba(255,255,255,${0.7*s.tw})`;
      ctx.fillRect(s.x, s.y, size, size);
      s.x += 0.025*s.z; if(s.x>c.width+2) s.x=-2;
      s.tw += (Math.random()-.5)*0.02; s.tw=Math.min(1,Math.max(0.2,s.tw));
    }
    requestAnimationFrame(tick);
  }
  addEventListener('resize', resize); tick();
})();

/* ==================== helpers ==================== */
function saveConvs(v){ state.convs = v; }
function convById(id){ return state.convs.find(c=>c.id===id); }
function ensureConv(){
  if(!state.currentConvId){
    const id = crypto.randomUUID();
    const all = state.convs;
    all.unshift({id,title:"New Conversation",items:[]});
    state.currentConvId = id; saveConvs(all);
  }
}
function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, ch=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[ch])); }

/* ==================== render ==================== */
const el = {
  app: $('#app'), auth: $('#auth'),
  chat: $('#chat'), chatWrap: $('#chatWrap'), msg: $('#msg'),
  convList: $('#convList'), toBottom: $('#toBottom'),
  settingsBtn: $('#settingsBtn'), overlay: $('#overlay'), panel: $('#panel'),
  libModal: $('#libModal'), libGrid: $('#libGrid')
};

function renderSidebar(){
  const list = state.convs.map(c=>`
    <div class="conv" data-id="${c.id}">
      <div class="title">${escapeHtml(c.title||'New Conversation')}</div>
      <div class="mini">
        <div class="pill select" data-i18n="select">Select</div>
        <div class="pill danger del" data-i18n="del">Del</div>
      </div>
    </div>`).join('');
  el.convList.innerHTML = list; applyI18n();
}

function renderChat(){
  const conv = convById(state.currentConvId);
  const html = (conv?.items||[]).map(m=>{
    const side = m.role==='ai' ? 'ai':'me';
    const actions = `<div class="actions">
      <div class="action copy">Copy</div>
      ${side==='me' && m.type!=='file' ? '<div class="action edit">Edit</div>' : ''}
      <div class="action read">Read</div>
    </div>`;
    if(m.type==='file'){
      return `<div class="row-bubble ${side}"><div class="bubble ${side}">${actions}
        <div><strong>${escapeHtml(m.name)}</strong></div>
        <div style="margin-top:6px;"><a href="${m.url}" download>Download</a></div>
      </div></div>`;
    }
    return `<div class="row-bubble ${side}"><div class="bubble ${side}">${actions}${escapeHtml(m.text)}</div></div>`;
  }).join('');
  el.chat.innerHTML = html;
  maybeStickToBottom(true);
}

function renderLibrary(){
  el.libGrid.innerHTML = state.library.map(f=>{
    const d = new Date(f.ts||Date.now()).toLocaleString();
    return `<div class="lib-item">
      <div style="font-size:13px;opacity:.8;">${d}</div>
      <div style="margin:6px 0;font-weight:700;">${escapeHtml(f.name)}</div>
      <a href="${f.url}" download>Download</a>
    </div>`;
  }).join('') || `<div style="opacity:.7;">Nothing shared yet.</div>`;
}

/* ==================== chat logic ==================== */
function send(text){
  ensureConv();
  const all = state.convs; const conv = convById(state.currentConvId);
  conv.items.push({role:'me',text}); saveConvs(all); renderChat();
  // demo echo
  setTimeout(()=>{ conv.items.push({role:'ai',text:`Echoing intention: ${text}`}); saveConvs(all); renderChat(); },150);
}

function attachDummy(){
  ensureConv();
  const all = state.convs; const conv = convById(state.currentConvId);
  const blob = new Blob([new TextEncoder().encode('lucidian demo file')], {type:'text/plain'});
  const url = URL.createObjectURL(blob); const name = 'index.html';
  conv.items.push({role:'me',type:'file',url,name});
  const lib = state.library; lib.unshift({name,url,ts:Date.now()}); state.library = lib;
  saveConvs(all); renderChat();
}

/* edit ‚Üí trim tail behavior */
function editMessageAt(index,newText){
  const all = state.convs; const conv = convById(state.currentConvId); if(!conv) return;
  // compute array of message indexes excluding system if needed
  const msgIdx = index;
  if(msgIdx<0 || msgIdx>=conv.items.length) return;
  conv.items[msgIdx].text = newText;
  conv.items = conv.items.slice(0, msgIdx+1); // trim everything after
  saveConvs(all); renderChat();
}

/* scroll helpers */
function nearBottom(){ return el.chatWrap.scrollTop + el.chatWrap.clientHeight >= el.chatWrap.scrollHeight - 120; }
function maybeStickToBottom(force=false){
  if(force || nearBottom()){ el.chatWrap.scrollTop = el.chatWrap.scrollHeight; el.toBottom.style.display='none'; }
  else el.toBottom.style.display='block';
}
el.chatWrap.addEventListener('scroll', ()=> maybeStickToBottom(false));

/* mic ‚Äì final only, stop after first result */
$('#mic').addEventListener('click', ()=>{
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR){ alert('SpeechRecognition not supported'); return; }
  const r = new SR(); r.lang = (lang==='es' ? 'es-ES':'en-US'); r.interimResults = false; r.maxAlternatives = 1;
  r.onresult = e => { const t = e.results[0][0].transcript; send(t); r.stop(); };
  r.onerror = e => console.error(e); r.start();
});

/* voice call modal with analyser */
let mediaStream=null, raf=0, audioCtx=null, analyser=null, data=null;
$('#voice').addEventListener('click', async()=>{
  $('#call').style.display='flex';
  try{
    mediaStream = await navigator.mediaDevices.getUserMedia({audio:true});
    audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    analyser = audioCtx.createAnalyser(); analyser.fftSize = 256;
    const src = audioCtx.createMediaStreamSource(mediaStream); src.connect(analyser);
    data = new Uint8Array(analyser.frequencyBinCount);
    const meter = $('#meter');
    const step = ()=>{ analyser.getByteFrequencyData(data); const v = data.reduce((a,b)=>a+b,0)/(data.length*255); meter.style.transform=`scale(${1 + v*1.8})`; raf=requestAnimationFrame(step); };
    step();
  }catch(e){ console.error(e); }
});
$('#endCall').addEventListener('click', ()=>{
  cancelAnimationFrame(raf); if(mediaStream) mediaStream.getTracks().forEach(t=>t.stop());
  if(audioCtx) audioCtx.close(); $('#call').style.display='none';
});

/* events */
$('#send').addEventListener('click', ()=>{ const t = el.msg.value.trim(); if(!t) return; el.msg.value=''; send(t); });
el.msg.addEventListener('keydown', e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); $('#send').click(); }});
$('#attach').addEventListener('click', attachDummy);
$('#toBottom').addEventListener('click', ()=> maybeStickToBottom(true));

$('#newConv').addEventListener('click', ()=>{ state.currentConvId=null; ensureConv(); renderSidebar(); renderChat(); });
$('#searchGo').addEventListener('click', ()=>{ const q = ($('#searchBox').value||'').toLowerCase(); const match = state.convs.find(c=> (c.title||'new conversation').toLowerCase().includes(q)); if(match){ state.currentConvId=match.id; renderSidebar(); renderChat(); }});
$('#convList').addEventListener('click', e=>{
  const row = e.target.closest('.conv'); if(!row) return; const id = row.dataset.id;
  if(e.target.classList.contains('del')){ const all = state.convs.filter(c=>c.id!==id); state.convs = all; if(state.currentConvId===id) state.currentConvId=null; ensureConv(); renderSidebar(); renderChat(); }
  else if(e.target.classList.contains('select') || e.target.classList.contains('title')){ state.currentConvId=id; renderSidebar(); renderChat(); }
});

/* bubble actions */
$('#chat').addEventListener('click', async e=>{
  const bubble = e.target.closest('.bubble'); if(!bubble) return;
  const idx = [...$('#chat').querySelectorAll('.bubble')].indexOf(bubble);
  const conv = convById(state.currentConvId); if(!conv) return;
  const msg = conv.items[idx];

  if(e.target.classList.contains('copy')){ const text = msg.type==='file' ? msg.name : msg.text; await navigator.clipboard.writeText(text||''); }
  if(e.target.classList.contains('edit') && msg && msg.type!=='file'){ const nt = prompt('Edit your message:', msg.text||''); if(nt!=null) editMessageAt(idx, nt); }
  if(e.target.classList.contains('read')){ const t = msg.type==='file' ? msg.name : msg.text; if('speechSynthesis' in window){ const u=new SpeechSynthesisUtterance(t||''); speechSynthesis.cancel(); speechSynthesis.speak(u); } }
});

/* library modal */
$('#openLibrary').addEventListener('click', ()=>{ renderLibrary(); $('#libModal').style.display='flex'; });
$('#libClose').addEventListener('click', ()=> $('#libModal').style.display='none');
$('#libScrim').addEventListener('click', ()=> $('#libModal').style.display='none');

/* settings panel */
function openPanel(){ $('#overlay').style.display='block'; $('#panel').style.display='block'; }
function closePanel(){ $('#overlay').style.display='none'; $('#panel').style.display='none'; }
$('#settingsBtn').addEventListener('click', e=>{ e.stopPropagation(); openPanel(); });
$('#overlay').addEventListener('click', closePanel);

/* tabs */
document.querySelectorAll('#panel .tab').forEach(t=>{
  t.addEventListener('click',()=>{
    if(t.id==='signOut'){ doLogout(); return; }
    document.querySelectorAll('#panel .tab').forEach(x=>x.classList.remove('act'));
    t.classList.add('act');
    const k = t.dataset.tab;
    document.querySelectorAll('.tabpane').forEach(p=>p.classList.add('hidden'));
    $('#p-'+k).classList.remove('hidden');
  });
});

/* account save */
$('#profSave').addEventListener('click', ()=>{
  const p = { name: $('#profName').value, email: $('#profEmail').value, phone: $('#profPhone').value };
  state.profile = p; alert('Saved'); closePanel();
});

/* language switch */
$('#langSel').addEventListener('change', e=> setLang(e.target.value));

/* memories */
function renderMems(){
  const box = $('#memList');
  box.innerHTML = state.mems.map(m=>`<div class="conv"><div class="title">${escapeHtml(m.text)}</div><div class="mini"><div class="pill danger del" data-id="${m.id}">Del</div></div></div>`).join('') || '<div style="opacity:.7">No memories yet.</div>';
}
$('#addMem').addEventListener('click', ()=>{
  const t = prompt('Memory text'); if(!t) return;
  const next = [{id:crypto.randomUUID(), text:t, ts:Date.now()}, ...state.mems];
  state.mems = next; renderMems();
});
$('#memList').addEventListener('click', e=>{
  if(e.target.classList.contains('del')){ const id=e.target.dataset.id; state.mems = state.mems.filter(m=>m.id!==id); renderMems(); }
});

/* connectors */
function loadConns(){
  const c = state.conns||{}; ['gmail','drive','docs','cal','dropbox','box','notion'].forEach(k=>{ const el=document.getElementById('c-'+(k==='cal'?'cal':k)); if(el) el.value=c[k]||''; });
}
$('#saveConns').addEventListener('click', ()=>{
  const c = {
    gmail: $('#c-gmail').value, drive: $('#c-drive').value, docs: $('#c-docs').value,
    cal: $('#c-cal').value, dropbox: $('#c-dropbox').value, box: $('#c-box').value, notion: $('#c-notion').value
  };
  state.conns = c; alert('Saved');
});

/* delete account */
$('#deleteAcct').addEventListener('click', ()=>{
  if(!confirm('Delete account and local data?')) return;
  // remove all namespaced keys for this user
  ['convs','lib','profile','mems','conns'].forEach(k=>localStorage.removeItem(`${state.uid}:${k}`));
  // remove user from list and logout
  const u = auth.users.filter(x=>x.id!==state.uid); localStorage.setItem('users',JSON.stringify(u));
  doLogout(true);
});

/* ==================== AUTH UI ==================== */
function showApp(){ $('#auth').classList.add('hidden'); $('#app').classList.remove('hidden'); initAfterLogin(); }
function showAuth(){ $('#app').classList.add('hidden'); $('#auth').classList.remove('hidden'); }

function doLogout(skipAlert=false){ auth.logout(); if(!skipAlert) alert('Signed out.'); showAuth(); }

const modeLogin = $('#modeLogin'), modeReg = $('#modeReg'), extraReg = $('#extraReg');
modeLogin.addEventListener('click', ()=>{ modeLogin.classList.add('act'); modeReg.classList.remove('act'); extraReg.classList.add('hidden'); });
modeReg.addEventListener('click', ()=>{ modeReg.classList.add('act'); modeLogin.classList.remove('act'); extraReg.classList.remove('hidden'); });

$('#authGo').addEventListener('click', ()=>{
  try{
    const email = $('#aEmail').value.trim(), pass = $('#aPass').value;
    if(modeReg.classList.contains('act')){
      const pass2 = $('#aPass2').value, name = $('#aName').value, phone = $('#aPhone').value;
      if(pass!==pass2) throw new Error('Passwords do not match');
      auth.register({name,email,phone,pass});
    }else{
      auth.login(email,pass);
    }
    showApp();
  }catch(e){ alert(e.message); }
});

/* ==================== init after login ==================== */
function initAfterLogin(){
  // profile into settings
  const p = state.profile||{}; $('#profName').value=p.name||''; $('#profEmail').value=p.email||auth.current?.email||''; $('#profPhone').value=p.phone||'';
  // conversations
  ensureConv(); renderSidebar(); renderChat();
  // language
  $('#langSel').value = lang; applyI18n();
  // memories/connectors
  renderMems(); loadConns();
}

/* boot */
applyI18n();
if(auth.current) showApp();
else showAuth();
</script>
</body>
</html>
