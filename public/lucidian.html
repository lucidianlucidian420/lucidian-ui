<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Lucidian â€” Interface (Accounts + Admin + Voice)</title>
<style>
  :root{
    --accent:#e8c66a; --accent-soft:rgba(232,198,106,.16);
    --text:#fff; --glass:rgba(0,0,0,.35); --glass-strong:rgba(0,0,0,.58);
  }
  @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap');
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:'Montserrat',system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial,sans-serif;color:var(--text);background:#000;overflow:hidden}

  /* Space BG â€” stars visible immediately */
  .space{position:fixed;inset:0;z-index:-2;background:
    radial-gradient(1200px 800px at 55% 40%, rgba(20,120,220,.18), transparent 60%),
    radial-gradient(900px 700px at 18% 74%, rgba(40,180,255,.10), transparent 60%),
    radial-gradient(700px 600px at 60% 60%, rgba(100,160,240,.10), transparent 70%),
    #000}
  .stars,.stars:before,.stars:after,.stars2,.stars2:before,.stars2:after{position:absolute;content:"";top:-4000px;left:0;right:0;bottom:0;width:2px;height:2px;background:transparent;animation:drift var(--speed,260s) linear infinite}
  .stars{--speed:280s; box-shadow: var(--starsA);}
  .stars:before{transform:translateY(4000px) scale(.96); filter:brightness(.85); box-shadow: var(--starsB);}
  .stars:after {transform:translateY(8000px) scale(.9);  filter:brightness(.7);  box-shadow: var(--starsC);}
  .stars2{--speed:320s; box-shadow: var(--starsD);}
  .stars2:before{transform:translateY(4000px) scale(.95); filter:brightness(.9); box-shadow: var(--starsE);}
  .stars2:after {transform:translateY(8000px) scale(.9);  filter:brightness(.75); box-shadow: var(--starsF);}
  @keyframes drift{from{transform:translateY(0)}to{transform:translateY(4000px)}}
  .nebula{position:absolute;inset:-10%;pointer-events:none;z-index:-1;background:
    radial-gradient(60% 50% at 60% 40%, rgba(90,150,255,.12), transparent 70%),
    radial-gradient(50% 45% at 30% 65%, rgba(120,220,255,.08), transparent 70%);filter:blur(32px) saturate(115%);animation:breathe 18s ease-in-out infinite}
  @keyframes breathe{0%,100%{transform:translateY(0)}50%{transform:translateY(1.4%)}}

  /* Layout */
  .app{display:grid;grid-template-columns:300px 1fr;grid-template-rows:auto 1fr auto;height:100vh}
  header{grid-column:1/3;position:relative;background:var(--glass-strong);backdrop-filter:blur(8px);padding:8px 12px}
  header .bar{display:grid;grid-template-columns:1fr auto 1fr;align-items:center}
  .center-title{display:flex;justify-content:center}
  h1{margin:6px 0 8px;letter-spacing:12px;font-size:2.2rem;color:var(--accent);text-shadow:0 0 12px rgba(232,198,106,.4)}
  .crest{width:66px;margin-left:auto}
  .crest svg{width:100%;height:auto;display:block;filter:drop-shadow(0 0 10px rgba(232,198,106,.45))}
  .crest path{fill:none;stroke:var(--accent);stroke-width:1.8;stroke-linecap:round}
  .crest .glow{stroke:rgba(232,198,106,.35);stroke-width:4;filter:blur(1px)}
  .account-trigger{justify-self:start;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.2);color:#fff;border-radius:10px;padding:8px 10px;cursor:pointer}
  .account-menu{position:absolute;top:58px;left:12px;background:rgba(0,0,0,.9);border:1px solid rgba(255,255,255,.18);border-radius:12px;padding:10px;width:280px;display:none;z-index:9999}
  .account-menu h4{margin:4px 0 8px;color:var(--accent)}
  .account-menu .row{display:flex;gap:8px;margin-bottom:8px}
  .account-menu input{flex:1;padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.08);color:#fff}
  .account-menu .actions{display:flex;gap:8px;justify-content:flex-end}

  aside{grid-row:2/4;background:var(--glass-strong);backdrop-filter:blur(8px);padding:10px;display:flex;flex-direction:column;gap:10px;overflow:hidden}
  .pill{border:none;border-radius:10px;background:var(--accent);color:#000;font-weight:700;padding:8px 10px;cursor:pointer}
  .sectionLabel{opacity:.9}
  .search{display:flex;gap:8px}
  .search input{flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.10);color:#fff}
  .search button{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.10);color:#fff;cursor:pointer}
  .list{overflow:auto;border:1px solid rgba(255,255,255,.15);border-radius:10px;background:rgba(255,255,255,.06)}
  .conv{padding:10px;border-bottom:1px solid rgba(255,255,255,.08);display:flex;justify-content:space-between;gap:8px;align-items:center}
  .conv.active{background:rgba(255,255,255,.12)}
  .conv .select{border:none;border-radius:6px;padding:4px 8px;background:var(--accent);color:#000;cursor:pointer}
  .conv .del{border:none;border-radius:6px;padding:4px 8px;background:#e44;color:#fff;cursor:pointer}

  main{position:relative;overflow:auto;padding:16px;background:var(--glass)}
  .message{position:relative;display:inline-block;max-width:min(780px,80%);padding:10px 14px;margin:10px 0;border-radius:12px;line-height:1.45;word-wrap:break-word}
  .lucidian{border:1px solid var(--accent);color:var(--accent);background:var(--accent-soft);box-shadow:0 0 12px rgba(232,198,106,.18);margin-right:auto}
  .user{border:1px solid rgba(255,255,255,.7);background:rgba(255,255,255,.12);color:#fff;margin-left:auto}
  .message .actions{position:absolute;right:0;top:calc(100% + 4px);display:flex;gap:6px;opacity:0;transform:translateY(-2px);pointer-events:none;transition:.15s ease}
  .message:hover .actions{opacity:1;transform:none;pointer-events:auto}
  .chip{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.25);color:#fff;border-radius:8px;padding:4px 7px;cursor:pointer;font-size:.82rem}

  footer{grid-column:2/3;display:flex;gap:10px;align-items:center;padding:10px;background:var(--glass-strong)}
  .row{display:flex;gap:8px;align-items:center;width:100%}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.10);color:#fff;cursor:pointer;white-space:nowrap}
  .btn.primary{background:var(--accent);color:#000;border:none;font-weight:700}
  input[type=text]{flex:1;padding:12px 14px;border-radius:10px;border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.10);color:#fff}

  /* Library modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:10}
  .modal.open{display:flex}
  .card{width:min(780px,92vw);background:var(--glass-strong);backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,.2);border-radius:16px;padding:16px}
  .card h2{margin:0 0 8px;color:var(--accent)}
  .items{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
  .library-card{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.16);border-radius:12px;padding:10px;overflow:hidden}
  .library-card .meta{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .library-card a{color:var(--accent);text-decoration:none}

  /* Auth Gate */
  .gate{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.85);z-index:15}
  .panel{width:min(520px,92vw);background:rgba(0,0,0,.7);border:1px solid rgba(255,255,255,.2);border-radius:16px;padding:16px}
  .panel h2{margin:0 0 8px;color:var(--accent)}
  .panel .row{display:flex;gap:10px;flex-wrap:wrap}
  .panel input{flex:1;min-width:180px;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.1);color:#fff;margin-bottom:8px}

  /* Mobile */
  @media (max-width: 900px){
    .app{grid-template-columns:1fr;grid-template-rows:auto 1fr auto}
    aside{position:fixed;z-index:11;left:0;top:0;bottom:0;width:86vw;transform:translateX(-100%);transition:.2s ease;box-shadow:8px 0 30px rgba(0,0,0,.6)}
    aside.open{transform:none}
    footer{grid-column:1/2}
    .message{max-width:90%}
  }
</style>
</head>
<body>
  <!-- Space -->
  <div class="space">
    <div class="stars"></div>
    <div class="stars2"></div>
    <div class="nebula"></div>
  </div>

  <!-- Auth Gate -->
  <div class="gate" id="gate">
    <div class="panel">
      <h2>Welcome to Lucidian</h2>
      <div style="display:flex;gap:14px;flex-wrap:wrap">
        <div style="flex:1;min-width:240px">
          <h3 style="margin:.2rem 0 .4rem">Create account</h3>
          <input id="suName" placeholder="Name" />
          <input id="suEmail" placeholder="Email" />
          <input id="suPhone" placeholder="Phone" />
          <input id="suPass" placeholder="Password" type="password" />
          <button class="pill" id="signUp">Sign up</button>
        </div>
        <div style="flex:1;min-width:240px">
          <h3 style="margin:.2rem 0 .4rem">Or sign in</h3>
          <input id="siEmail" placeholder="Email" />
          <input id="siPass" placeholder="Password" type="password" />
          <button class="pill" id="signIn">Log in</button>
        </div>
      </div>
    </div>
  </div>

  <!-- App -->
  <div class="app" id="app" style="display:none">
    <header>
      <div class="bar">
        <button class="account-trigger" id="acctBtn">Account â–¾</button>
        <div class="center-title"><h1>L U C I D I A N</h1></div>
        <div class="crest" aria-label="Lucidian Crest">
          <!-- Symbol unchanged -->
          <svg viewBox="0 0 200 200" role="img" xmlns="http://www.w3.org/200/svg">
            <circle class="glow" cx="100" cy="100" r="86" />
            <g transform="translate(100,100)">
              <defs><path id="petal" d="M0,-80 C22,-80 40,-62 40,-40 C40,-18 22,0 0,0 C-22,0 -40,-18 -40,-40 C-40,-62 -22,-80 0,-80 Z" /></defs>
              <g opacity="0.95">
                <use href="#petal" transform="rotate(0)" /><use href="#petal" transform="rotate(15)" /><use href="#petal" transform="rotate(30)" />
                <use href="#petal" transform="rotate(45)" /><use href="#petal" transform="rotate(60)" /><use href="#petal" transform="rotate(75)" />
                <use href="#petal" transform="rotate(90)" /><use href="#petal" transform="rotate(105)" /><use href="#petal" transform="rotate(120)" />
                <use href="#petal" transform="rotate(135)" /><use href="#petal" transform="rotate(150)" /><use href="#petal" transform="rotate(165)" />
                <use href="#petal" transform="rotate(180)" /><use href="#petal" transform="rotate(195)" /><use href="#petal" transform="rotate(210)" />
                <use href="#petal" transform="rotate(225)" /><use href="#petal" transform="rotate(240)" /><use href="#petal" transform="rotate(255)" />
                <use href="#petal" transform="rotate(270)" /><use href="#petal" transform="rotate(285)" /><use href="#petal" transform="rotate(300)" />
                <use href="#petal" transform="rotate(315)" /><use href="#petal" transform="rotate(330)" /><use href="#petal" transform="rotate(345)" />
              </g>
            </g>
          </svg>
        </div>
      </div>

      <!-- Account menu -->
      <div class="account-menu" id="acctMenu">
        <h4>Profile</h4>
        <div class="row"><input id="acctName" placeholder="Name" /></div>
        <div class="row"><input id="acctEmail" placeholder="Email" /></div>
        <div class="row"><input id="acctPhone" placeholder="Phone" /></div>
        <div class="actions">
          <button class="btn" id="acctSave">Save</button>
          <button class="btn" id="acctUsers" style="display:none">Manage users</button>
          <button class="btn" id="acctSignOut">Sign out</button>
        </div>
      </div>
    </header>

    <aside id="sidebar">
      <div class="row" style="justify-content:space-between">
        <button class="pill" id="newChat">New</button>
      </div>

      <div class="sectionLabel">Library</div>
      <button class="btn" id="openLibrary">Open</button>

      <div class="sectionLabel">Search</div>
      <div class="search">
        <input id="search" type="text" placeholder="Search conversations..." />
        <button id="searchBtn">Go</button>
      </div>

      <div class="list" id="convList" style="margin-top:6px"></div>
    </aside>

    <main id="chat"></main>

    <footer>
      <div class="row">
        <label class="btn" for="file">Attach</label>
        <input id="file" type="file" multiple hidden />
        <button class="btn" id="mic">ðŸŽ¤ Mic</button>
        <input id="text" type="text" placeholder="Type a message..." />
        <button class="btn primary" id="send">Send</button>
        <button class="btn" id="voiceStudio">Voice</button>
      </div>
    </footer>
  </div>

  <!-- Library modal -->
  <div class="modal" id="libModal">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2>Shared Library</h2>
        <button class="btn" id="closeLib">Close</button>
      </div>
      <div class="items" id="libItems"></div>
    </div>
  </div>

<script>
/* ---------- Stars (instant) ---------- */
function rand(n){return Math.floor(Math.random()*n)}
function makeStars(count){
  const arr=[]; for(let i=0;i<count;i++){
    const x=rand(2000)+"px "+(rand(4000))+"px ";
    const c=Math.random();
    const col=c>.7? '#fff' : (c>.4? '#dfe9ff' : '#bcd8ff');
    arr.push(x+col);
  } return arr.join(', ');
}
const root=document.documentElement;
root.style.setProperty('--starsA', makeStars(350));
root.style.setProperty('--starsB', makeStars(350));
root.style.setProperty('--starsC', makeStars(350));
root.style.setProperty('--starsD', makeStars(420));
root.style.setProperty('--starsE', makeStars(420));
root.style.setProperty('--starsF', makeStars(420));

/* ---------- Simple â€œaccounts backendâ€ (localStorage demo) ---------- */
function getAccounts(){ return JSON.parse(localStorage.getItem('lucidian:accounts')||'[]'); }
function setAccounts(a){ localStorage.setItem('lucidian:accounts', JSON.stringify(a)); }
function saveCurrentUser(u){ localStorage.setItem('lucidian:currentUser', JSON.stringify(u)); }
function loadCurrentUser(){ try{return JSON.parse(localStorage.getItem('lucidian:currentUser')||'null')}catch{return null} }
function findByEmail(email){ return getAccounts().find(u=>u.email.toLowerCase()===email.toLowerCase()); }
function upsertAccount(u){
  const list=getAccounts(); const i=list.findIndex(x=>x.id===u.id);
  if(i>=0) list[i]=u; else list.push(u); setAccounts(list);
}
/* Admin rule: Kyle email is admin */
const ADMIN_EMAIL = 'kylejmjenkins@gmail.com';

/* ---------- Per-user storage helpers ---------- */
function userKey(u, suffix){ const id=u?.id || 'anon'; return `lucidian:${id}:${suffix}`; }
function loadConversations(user){ return JSON.parse(localStorage.getItem(userKey(user,'convs'))||'[]'); }
function saveConversations(user, convs){ localStorage.setItem(userKey(user,'convs'), JSON.stringify(convs)); }
function loadActiveId(user){ return localStorage.getItem(userKey(user,'active'))||null; }
function saveActiveId(user, id){ if(id) localStorage.setItem(userKey(user,'active'), id); else localStorage.removeItem(userKey(user,'active')); }
function loadLibrary(user){ return JSON.parse(localStorage.getItem(userKey(user,'library'))||'[]'); }
function saveLibrary(user, items){ localStorage.setItem(userKey(user,'library'), JSON.stringify(items)); }

/* ---------- Auth Gate wiring ---------- */
const gate = document.getElementById('gate');
const app  = document.getElementById('app');
const signUp = document.getElementById('signUp');
const signIn = document.getElementById('signIn');
function openApp(){ gate.style.display='none'; app.style.display='grid'; }
function openGate(){ gate.style.display='flex'; app.style.display='none'; }

let currentUser = loadCurrentUser();
if(currentUser){ openApp(); } else { openGate(); }

signUp.onclick = ()=>{
  const name = document.getElementById('suName').value.trim();
  const email= document.getElementById('suEmail').value.trim();
  const phone= document.getElementById('suPhone').value.trim();
  const pass = document.getElementById('suPass').value;
  if(!name||!email||!pass){ alert('Please fill name, email and password.'); return; }
  if(findByEmail(email)){ alert('An account with that email already exists.'); return; }
  const user={ id:crypto.randomUUID(), name, email, phone, pass, isAdmin: email.toLowerCase()===ADMIN_EMAIL };
  upsertAccount(user); saveCurrentUser(user); currentUser=user;
  // fresh per-user state
  saveConversations(user, []); saveActiveId(user,null); saveLibrary(user, []);
  openApp(); initAfterAuth();
};

signIn.onclick = ()=>{
  const email=document.getElementById('siEmail').value.trim();
  const pass =document.getElementById('siPass').value;
  const u=findByEmail(email);
  if(!u || u.pass!==pass){ alert('Invalid email or password.'); return; }
  // ensure admin flag (in case account pre-existed)
  if(email.toLowerCase()===ADMIN_EMAIL && !u.isAdmin){ u.isAdmin=true; upsertAccount(u); }
  saveCurrentUser(u); currentUser=u; openApp(); initAfterAuth();
};

/* ---------- App State ---------- */
const chatEl = document.getElementById('chat');
const inputEl = document.getElementById('text');
const fileEl = document.getElementById('file');
const sendBtn = document.getElementById('send');
const micBtn = document.getElementById('mic');
const convList = document.getElementById('convList');
const newChatBtn = document.getElementById('newChat');
const searchEl = document.getElementById('search');
const searchBtn = document.getElementById('searchBtn');
const voiceStudioBtn = document.getElementById('voiceStudio');
const sidebar = document.getElementById('sidebar');

let conversations=[], activeId=null, libraryItems=[];
function initAfterAuth(){
  // account menu fill + admin button
  document.getElementById('acctName').value = currentUser?.name||'';
  document.getElementById('acctEmail').value= currentUser?.email||'';
  document.getElementById('acctPhone').value= currentUser?.phone||'';
  document.getElementById('acctBtn').textContent = (currentUser?.name || 'Account') + ' â–¾';
  document.getElementById('acctUsers').style.display = currentUser?.isAdmin ? 'inline-flex':'none';

  conversations = loadConversations(currentUser);
  activeId = loadActiveId(currentUser);
  libraryItems = loadLibrary(currentUser);
  if(!conversations.length){ createConversation(); }
  renderList(); renderChat();
}
if(currentUser) initAfterAuth();

/* ---------- Sidebar search/render ---------- */
function save(){ saveConversations(currentUser, conversations); }
function setActive(id){ activeId=id; saveActiveId(currentUser, id); renderList(); renderChat(); if(window.innerWidth<900) sidebar.classList.remove('open'); }
function createConversation(){
  const id = Date.now().toString();
  conversations.unshift({id, title:'New Conversation', messages:[]});
  save(); setActive(id);
}
function deleteConversation(id){
  const i = conversations.findIndex(c=>c.id===id);
  if(i>=0){ conversations.splice(i,1); save(); if(activeId===id){ activeId=null; if(conversations[0]) setActive(conversations[0].id); else createConversation(); } renderList(); renderChat(); }
}
function renderList(filter=''){
  convList.innerHTML = '';
  conversations
  .filter(c=> c.title.toLowerCase().includes(filter.toLowerCase()) || c.messages.some(m=>m.text.toLowerCase().includes(filter.toLowerCase())))
  .forEach(c=>{
    const d=document.createElement('div'); d.className='conv'+(c.id===activeId?' active':'');
    const span=document.createElement('span'); span.textContent=c.title; span.style.flex='1';
    const sel=document.createElement('button'); sel.textContent='Select'; sel.className='select'; sel.onclick=()=>setActive(c.id);
    const del=document.createElement('button'); del.textContent='Del'; del.className='del'; del.onclick=()=>deleteConversation(c.id);
    d.appendChild(span); d.appendChild(sel); d.appendChild(del); convList.appendChild(d);
  });
}
newChatBtn.onclick=createConversation;
searchBtn.onclick=()=> renderList(searchEl.value);
searchEl.addEventListener('keydown', e=>{ if(e.key==='Enter'){ renderList(searchEl.value); }});

/* ---------- Chat render + actions ---------- */
function renderChat(){
  chatEl.innerHTML='';
  const conv = conversations.find(c=>c.id===activeId);
  if(!conv){ createConversation(); return; }
  conv.messages.forEach((m,idx)=>{
    const d=document.createElement('div'); d.className='message '+(m.role==='user'?'user':'lucidian'); d.textContent=m.text;
    // actions
    const actions=document.createElement('div'); actions.className='actions';
    const copy=document.createElement('button'); copy.className='chip'; copy.textContent='Copy';
    copy.onclick=(ev)=>{ ev.stopPropagation(); navigator.clipboard.writeText(m.text); };
    actions.appendChild(copy);
    if(m.role==='user'){
      const edit=document.createElement('button'); edit.className='chip'; edit.textContent='Edit';
      edit.onclick=(ev)=>{ ev.stopPropagation(); const t=prompt('Edit your message:',m.text); if(t!=null){ m.text=t; save(); renderChat(); } };
      actions.appendChild(edit);
    }
    const read=document.createElement('button'); read.className='chip'; read.textContent='Read';
    read.onclick=(ev)=>{ ev.stopPropagation(); if('speechSynthesis' in window){ const u=new SpeechSynthesisUtterance(m.text); speechSynthesis.speak(u);} };
    actions.appendChild(read);
    d.appendChild(actions);

    chatEl.appendChild(d);
  });
  chatEl.scrollTop = chatEl.scrollHeight;
}
function addMessage(role, text){
  const conv = conversations.find(c=>c.id===activeId); if(!conv) return;
  conv.messages.push({role, text});
  if(conv.title==='New Conversation' && role==='user' && text.trim()){
    conv.title = text.slice(0,42)+(text.length>42?'â€¦':'');
  }
  save(); renderChat();
}

/* ---------- Placeholder Lucidian reply ---------- */
async function lucidianReply(userText){
  const chunks = ["Echoing intention: ", userText||'listening.'];
  let assembled=''; for(const c of chunks){ assembled+=c; await new Promise(r=>setTimeout(r,60)); updateOrAppendLucidian(assembled); }
}
function updateOrAppendLucidian(text){
  const conv = conversations.find(c=>c.id===activeId); if(!conv) return;
  const last = conv.messages[conv.messages.length-1];
  if(last && last.role==='lucidian'){ last.text=text; } else { conv.messages.push({role:'lucidian', text}); }
  save(); renderChat();
}

/* ---------- Send, Enter ---------- */
sendBtn.onclick=async ()=>{
  const text=inputEl.value.trim(); if(!text) return; addMessage('user', text); inputEl.value=''; await lucidianReply(text);
};
inputEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendBtn.click(); }});

/* ---------- Attachments â†’ Library + message thumbnails ---------- */
fileEl.onchange = ()=>{
  const files=[...fileEl.files]; if(!files.length) return;
  const conv = conversations.find(c=>c.id===activeId); if(!conv) return;
  files.forEach(f=>{
    const url = URL.createObjectURL(f);
    // record in per-user library
    libraryItems.push({name:f.name, type:f.type, size:f.size, url});
    // add a message with the filename (thumbnail-ish label)
    conv.messages.push({role:'user', text:`(attachments queued) ${f.name}`});
  });
  saveLibrary(currentUser, libraryItems); save(); renderChat();
  fileEl.value='';
};

/* ---------- Library modal ---------- */
const libModal=document.getElementById('libModal');
const openLib = document.getElementById('openLibrary');
const closeLib= document.getElementById('closeLib');
const libItemsEl=document.getElementById('libItems');
openLib.onclick=()=>{ renderLibrary(); libModal.classList.add('open'); };
closeLib.onclick=()=> libModal.classList.remove('open');
function renderLibrary(){
  libItemsEl.innerHTML='';
  if(!libraryItems.length){ libItemsEl.textContent='No shared items yet.'; return; }
  libraryItems.forEach(it=>{
    const card=document.createElement('div'); card.className='library-card';
    const meta=document.createElement('div'); meta.className='meta'; meta.textContent=it.name;
    const dl=document.createElement('a'); dl.href=it.url; dl.download=it.name; dl.textContent='Download';
    card.appendChild(meta); card.appendChild(dl); libItemsEl.appendChild(card);
  });
}

/* ---------- Account menu ---------- */
const acctBtn=document.getElementById('acctBtn');
const acctMenu=document.getElementById('acctMenu');
acctBtn.onclick=(e)=>{ e.stopPropagation(); acctMenu.style.display= acctMenu.style.display==='none'?'block':'none'; };
document.addEventListener('click', (e)=>{ if(!(e.target).closest('.account-menu') && !(e.target).closest('#acctBtn')) acctMenu.style.display='none'; });

document.getElementById('acctSave').onclick=()=>{
  const name=document.getElementById('acctName').value.trim();
  const email=document.getElementById('acctEmail').value.trim();
  const phone=document.getElementById('acctPhone').value.trim();
  let u=findByEmail(currentUser.email);
  u={...u, name, email, phone};
  if(email.toLowerCase()===ADMIN_EMAIL) u.isAdmin=true;
  upsertAccount(u); saveCurrentUser(u); currentUser=u;
  acctBtn.textContent = (currentUser.name||'Account') + ' â–¾';
  acctMenu.style.display='none';
};
document.getElementById('acctSignOut').onclick=()=>{ localStorage.removeItem('lucidian:currentUser'); openGate(); };

document.getElementById('acctUsers').onclick=()=>{
  // admin panel modal
  const list=getAccounts();
  const modal=document.createElement('div'); modal.className='modal open';
  modal.innerHTML=`<div class="card"><div style="display:flex;justify-content:space-between;align-items:center">
      <h2>Accounts</h2><button class="btn" id="admClose">Close</button></div>
      <div id="admList"></div></div>`;
  document.body.appendChild(modal);
  modal.querySelector('#admClose').onclick=()=> modal.remove();
  const admList=modal.querySelector('#admList');
  admList.innerHTML=list.map(u=>`
    <div style="display:grid;grid-template-columns:1fr auto auto;gap:8px;align-items:center;border-bottom:1px solid rgba(255,255,255,.1);padding:8px 0">
      <div style="opacity:.9">${u.name||'(no name)'}<div style="opacity:.6;font-size:.9em">${u.email}</div></div>
      <div>${u.isAdmin?'Admin':''}</div>
      <button class="btn" data-id="${u.id}">Impersonate</button>
    </div>
  `).join('');
  admList.querySelectorAll('button[data-id]').forEach(btn=>{
    btn.onclick=()=>{
      const id=btn.getAttribute('data-id');
      const u=list.find(x=>x.id===id);
      if(u){ saveCurrentUser(u); currentUser=u; initAfterAuth(); modal.remove(); }
    };
  });
};

/* ---------- Mic (no autosend on pause) â€” quick fill ---------- */
let recognition, recognizing=false;
if('webkitSpeechRecognition' in window || 'SpeechRecognition' in window){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SR(); recognition.lang='en-US'; recognition.continuous=true; recognition.interimResults=true;
  recognition.onresult = (e)=>{
    let txt=''; for(let i=0;i<e.results.length;i++){ const res=e.results[i]; const str=res[0].transcript; if(res.isFinal) txt=str; }
    if(txt) inputEl.value = txt; // fill only; do not auto-send
  };
  recognition.onend = ()=>{ recognizing=false; };
}
micBtn.onclick=()=>{
  if(!recognition){ alert('Speech Recognition not supported in this browser.'); return; }
  if(!recognizing){ recognition.start(); recognizing=true; micBtn.textContent='â¹ Mic'; }
  else { recognition.stop(); recognizing=false; micBtn.textContent='ðŸŽ¤ Mic'; }
};

/* ---------- Voice button placeholder ---------- */
voiceStudioBtn.onclick=()=> alert('Voice call studio wired previously â€” placeholder here.');

/* ---------- PWA Manifest + SW (optional cache) ---------- */
if('serviceWorker' in navigator){
  const swCode = `self.addEventListener('install', e=>{ self.skipWaiting(); e.waitUntil(caches.open('lucidian-v3').then(c=>c.addAll(['./']))); });
  self.addEventListener('fetch', e=>{ e.respondWith(caches.match(e.request).then(r=> r || fetch(e.request))); });`;
  const blob = new Blob([swCode], {type:'text/javascript'});
  const swUrl = URL.createObjectURL(blob);
  navigator.serviceWorker.register(swUrl);
}
const manifest = { name:'Lucidian', short_name:'Lucidian', start_url:'./', display:'standalone', background_color:'#000', theme_color:'#000', icons:[] };
const mBlob = new Blob([JSON.stringify(manifest)], {type:'application/json'});
const mUrl = URL.createObjectURL(mBlob);
const link = document.createElement('link'); link.rel='manifest'; link.href=mUrl; document.head.appendChild(link);
</script>
</body>
</html>
